---
title: "FIESTA - Database Tools"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{FIESTA - Database Tools}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


## FIESTA Overview
The R package, FIESTA (Forest Inventory ESTimation and Analysis) is a research estimation tool for analysts that work with sample-based inventory data from the U.S. Department of Agriculture, Forest Service, Forest Inventory and Analysis (FIA) Program to accommodate: unique population boundaries, different evaluation time periods, customized stratification schemes, non-standard variance equations, integration of multi-scale remotely-sensed data and other ancillary information, and interaction with other modeling and estimation tools from CRAN R's library of packages. FIESTA contains a collection of functions that can access FIA databases, summarize and compile plot and spatial data, and generate estimates with associated sampling errors. 


Functions are organized by type or objective and are named with a corresponding prefix: 

* Database tools (DB) - functions for querying and extracting data from FIA's national database.

* Data tools (dat) - functions for summarizing and exploring FIA data.

* Spatial tools (sp) - functions for manipulating and summarizing spatial data.

* Estimation modules (GB, PB, SA) - functions for different estimation strategies, such as FIA's standard 'Green-Book' estimators (GB); suplementary photo-based estimators (PB); integration with different available small area estimators (SAE) or other model-assisted or model-based estimation tools, such as LASSO.

* Analysis tools (an) - wrapper functions for steam-lining estimation processes.



FIESTA's DB tools extract data from FIA's internal Oracle database or FIA's online publically-available comma-delimited files (\*.csv or \*.zip). In order to access FIA's internal Oracle database, you must have select permission to the necessary tables. Typically, permission is only granted to FIA employees (check with the regional FIA Oracle administrator for granted permissions). FIA's CSV files are publically available. CSV files are available by state from the FIA DataMart at the following link: https://apps.fs.usda.gov/fia/datamart/datamart.html. Because of FIA's confidentiality agreement to protect the privacy of landowners, as well as protecting the scientific integrity of FIA's sample design, the exact coordinates of the sample plot locations are not included in the public data. If the exact coordinates are necessary for your analysis, contact FIA's Spatial Data Services (https://www.fia.fs.fed.us/tools-data/spatial/index.php).

For accessing the FIA Oracle database, it is also necessary to have ODBC (Open DataBase Connectivity) compliancy. ODBC refers to a database driver on the client's computer which translates queries from client applications into commands the database understands. Check your local IT service for compliancy, setup, and availability of 32- vs 64-bit drivers.

### Objective of tutorial
The objective of this tutorial is to demonstrate the use of FIESTA's DB tools for accessing FIA data. These tools extract data from FIADB using FIA's standard evaluations as well as customized evaluations (DBgetPlots and DBgetStrata). An FIA Evaluation is a group of plots within the FIA database that is used for population estimates, representing different inventory spans of data with different stratification or area adjustments. Each Evaluation is determined by the type of estimation (evalType) including: area and tree estimates, growth and mortality estimates, and area change estimates (evalType). These plots are identified by an evalid, which is a unique identifier in the format of a 2-digit State code, a 2-digit year code, and a 2-digit evaluation type code. For example, EVALID '491601' represents the Utah 2016 evaluation for current area estimates. 

FUNCTION  | DESCRIPTION
-------------- | ---------------------------------------------------------------
[DBtestORACLE()](#DBtestORACLE) | Tests connection to FIA's ORACLE database.
[DBgetCSV()](#DBgetCSV) | Downloads comma-delimited file (.csv) or downloads and extracts a compressed csv file (.zip) from FIA's online DataMart.
[DBqryCSV()](#DBqryCSV) | Extracts and queries data from FIA's online DataMart, either CSV or ZIP files.
[DBqryORACLE()](#DBqryORACLE) | Queries and extracts data from FIA's Oracle Database.
[DBgetEvalid()](#DBgetEvalid) | Gets evalid for identifying an estimation group of plots for state or checks evalid.
[DBgetPlots()](#DBgetPlots) | Extracts inventory plot data from FIA database.
[DBgetStrata()](#DBgetStrata) | Extracts strata information and total acres by estimation unit from FIA database, including plot-level assignment and a data frame with strata weights by estimation unit.


### EXAMPLES

Set up for examples
```
# Load library
library(FIESTA)

# Set workspace to FIESTA folder (create if doesn't exist)
if (!file.exists("C:/FIESTA"))  dir.create("C:/FIESTA")
setwd("C:/FIESTA")

# Create 2 subfolders under the FIESTA folder, 'data' and 'outfolder' and set path to objects 
if (!file.exists("data"))  dir.create("data")
datfolder <- "data" 

if (!file.exists("outfolder")) dir.create("outfolder")
outfolder <- "outfolder"

```

The following examples show how to use the publically-available, online zipfiles and FIA's Oracle database, if permissions allow. There are a few differences to note:

1. If datsource=ORACLE, you must have select permission to SDS_PLOT and SDS_COND tables to get actual coordinates. This is currently only available for FIA employees, and only within the individual's FIA research unit of employment. The data extraction process may take several minutes, depending on what you are extracting and the server connections. Please be patient. Check if a 64-bit driver is available for ODBC connection using 64-bit R.

2. For datsource=CSV (default), the plot coordinates have been altered for privacy (See https://www.fia.fs.fed.us/tools-data/spatial/Policy/index.php for details). The zip files are extracted on-the-fly from the online website. Web server connections will affect download speeds.



#### <a name="DBtestORACLE"/>DBtestORACLE()
```
######################################################################################
# Usage:
# DBtestORACLE(dbconnout = FALSE) 
#  
# Description:
# Tests the FIA Oracle database connection and return an open database connection. 
# If you do not get the following response, "Oracle connection successful", 
# check your ODBC connection.
######################################################################################

# Test connection.
DBtestORACLE()

# Test connection and return an open database connection
dbconn <- DBtestORACLE(dbconnopen=TRUE)
dbconn

```


#### <a name="DBgetCSV"/>DBgetCSV()
```
####################################################################################
# Usage:
# DBgetCSV(DBtable, states = NULL, ZIP = TRUE, returnDT = TRUE) 
# 
# Description:
# Downloads *.csv file or downloads and extracts a *.zip file from FIA DataMart.
# Only 1 table can be specified, but multiple states may be included.
# Value:
# Returns a data table (returnDT=TRUE), or data.frame (returnDT=FALSE).
####################################################################################

## Get plot table for Wyoming
WYplots <- DBgetCSV("PLOT", "Wyoming")
dim(WYplots)

## Get plot table for Wyoming and Utah
WYUTplots <- DBgetCSV(DBtable="PLOT", states=c("Wyoming", "Utah"))
table(WYUTplots$STATECD)

## Get survey table for Wyoming
WYsurvey <- DBgetCSV("SURVEY", "Wyoming")
WYsurvey

## Get ref_unit table
ref_research_station <- DBgetCSV("ref_research_station")
head(ref_research_station)

```


#### <a name="DBqryCSV"/>DBqryCSV()
```
####################################################################################
# Usage:
# DBqryCSV(sql, ZIP = TRUE, states = NULL, sqltables = NULL) 
# 
# Description:
# Queries and extracts data from FIA's online data sources (FIA DataMart), 
#	either CSV or ZIP files (Note: must use SQL syntax).
#
# Value:
# Returns a data frame from resulting query.
####################################################################################

# QUERY1: Number of plots by inventory year for the state of Wyoming
sql1.csv <- "select INVYR, count(*) AS NBRPLOTS 
          from plot 
          where statecd=56 group by INVYR"
DBqryCSV(sql=sql1.csv, states="Wyoming", sqltables="plot")

# QUERY2: min, mean, max height by FORTYPCD in Wyoming
sql2a.csv <- "select c.FORTYPCD, min(HT) HTmin, round(avg(HT)) HTmean, max(HT) maxHT 
			        from cond c, tree t
			        where c.statecd = 56 and c.PLT_CN = t.PLT_CN 
			        group by c.FORTYPCD order by c.FORTYPCD"
DBqryCSV(sql=sql2a.csv, states="Wyoming", sqltables=c("cond", "tree"))

# Using different SQL syntax (e.g., INNER JOIN)
sql2b.csv <- "select c.FORTYPCD, min(HT) HTmin, round(avg(HT)) HTmean, max(HT) maxHT 
			        from cond c INNER JOIN tree t ON c.PLT_CN = t.PLT_CN 
			        where c.statecd = 56 
			        group by c.FORTYPCD order by c.FORTYPCD"
DBqryCSV(sql=sql2b.csv, states="Wyoming", sqltables=c("cond", "tree"))

# QUERY3: Number of plots by inventory year for Utah and Wyoming
sql3.csv <- "select STATECD, INVYR, count(*) NBRPLOTS 
          from plot 
          where statecd in(49,56) group by STATECD, INVYR"
DBqryCSV(sql=sql3.csv, states=c("Utah", "Wyoming"), sqltables="plot")

```

#### <a name="DBqryORACLE"/>DBqryORACLE()
```
######################################################################################
# Usage:
# DBqryORACLE(sql, dbconn = NULL, dbconnopen = TRUE) 
# 
# Description:
# Queries and extracts data from FIA's Oracle Database. (Note: must use SQL syntax).
# You must have select permission for the tables in the query. The tables must
# include the ORACLE schema as a prefix to each table.
#
# Value:
# Returns a data frame from resulting query
######################################################################################

# QUERY1: Number of plots by inventory year for the state of Wyoming
sql1.ora <- "select INVYR, count(*) NBRPLOTS 
          from FS_FIADB.plot 
          where statecd=56 group by INVYR"
DBqryORACLE(sql=sql1.ora)

# QUERY2: min, mean, max height by FORTYPCD in Wyoming
sql2a.ora <- "select c.FORTYPCD, min(HT) HTmin, round(avg(HT)) HTmean, max(HT) maxHT 
              from FS_FIADB.cond c, FS_FIADB.tree t
              where c.statecd = 56 and c.PLT_CN = t.PLT_CN 
              group by c.FORTYPCD order by c.FORTYPCD"
DBqryORACLE(sql=sql2a.ora)

# With different SQL syntax
sql2b.ora <- "select c.FORTYPCD, min(HT) HTmin, round(avg(HT)) HTmean, max(HT) maxHT 
              from FS_FIADB.cond c INNER 
              JOIN FS_FIADB.tree t ON c.PLT_CN = t.PLT_CN
              where c.statecd = 56 
              group by c.FORTYPCD order by c.FORTYPCD"
DBqryORACLE(sql=sql2b.ora)

# QUERY3: Number of plots by inventory year for Utah and Wyoming, including dbconn.
dbconn <- DBtestORACLE(dbconnout=TRUE)
sql3.ora <- "select STATECD, INVYR, count(*) NBRPLOTS 
          from FS_FIADB.plot 
          where statecd in(49,56) group by STATECD, INVYR"
DBqryORACLE(sql=sql3.ora, dbconn=dbconn)

```

#### <a name="DBgetEvalid"/>DBgetEvalid()
```
######################################################################################
# Usage:
# DBgetEvalid(states = NULL, rs = NULL, datsource = "CSV", ZIP = TRUE, FS_FIADB = TRUE,  
#   invyrtab = NULL, invtype = "ANNUAL", evalCur = TRUE, evalEndyr = NULL, evalid = NULL, 
#   evalType = "all", dbconn = NULL, dbconnopen = FALSE, gui = FALSE)
# 
# Description:
# Extracts an evalid for identifying an estimation group of plots. If evalCur=TRUE, 
#	extracts current evalid and inventory years for state(s), or for a specified 
#	evalEndyr. Otherwise checks an evalid and returns states and inventory years.
#
# Value:
# A list of data objects:
#   $states      - state names
#   $rslst       - FIA research station names included in output
#   $evalidlist  - evalid by state
#   $invtype     - inventory type for state(s) (ANNUAL/PERIODIC)
#   $invyrtab    - a data frame with inventory years by state corresponding to evalid
#   $evalType    - Evaluation type(s) included in query
#   $invyrs      - a list of inventory years by state corresponding to evalid
#   $datsource   - the datsource used for query (ORALCE or CSV)
#   $FS_FIADB    - TRUE, if datsource=ORACLE and FS_FIADB schema is used
######################################################################################

help(DBgetEvalid)

# Using GUI interface. 
eval <- DBgetEvalid()
names(eval)
eval

## Get evalid and inventory years for Wyoming (from CSV files)
WYeval <- DBgetEvalid(states="Wyoming")
names(WYeval)
WYeval$evalidlist
WYeval$invyrs
WYeval$invyrtab
WYeval$invtype

## Get evalid for Utah and Wyoming (from CSV files)
UTWYeval <- DBgetEvalid(states=c("Wyoming", "Utah"), datsource="CSV")
UTWYeval$evalidlist
UTWYeval$invyrs
UTWYeval$invyrtab
UTWYeval$invtype

## Get evalid for Utah and Wyoming (from Oracle - must have select permission)
UTWYeval <- DBgetEvalid(states=c("Wyoming", "Utah"), datsource="ORACLE")
UTWYeval$evalidlist
UTWYeval$invyrs
UTWYeval$invyrtab
UTWYeval$invtype

## Get most current evaluation for all states in RMRS and NCRS FIA research units
eval.cur <- DBgetEvalid(rs=c("RMRS", "NCRS"))
names(eval.cur)
eval.cur$evalidlist


```

#### <a name="DBgetPlots"/>DBgetPlots()
```
######################################################################################
# Usage:
# DBgetPlots(datsource = "ORACLE", ZIP = TRUE, FS_FIADB = TRUE, states = NULL, 
#   rs = NULL, invtype = "ANNUAL", evalid = NULL, evalCur = FALSE, evalEndyr = NULL, 
#   evalType = "all", allyrs = FALSE, invyrs = NULL, actual = FALSE, istree = FALSE, 
#   isseed = FALSE, isveg = FALSE, issp = FALSE, spcoords = NULL, 
#   spcondid1 = FALSE, defaultVars = TRUE, regionVars = FALSE, ACI = FALSE,
#   subcycle99 = FALSE, intensity1 = TRUE, allFilter = NULL, savedata = FALSE, 
#   saveqry = FALSE, parameters = FALSE, outfolder = NULL, outfn.pre = NULL, 
#   outfn.date = FALSE, overwrite = FALSE, dbconn = NULL, dbconnopen = FALSE, 
#   returnPOP=FALSE, gui = FALSE)
# 
# Description:
# Extracts field, calculated, and derived data from FIA's internal, permission-controlled,
#   Oracle database, or from FIA's publically-accessible online DataMart
#   (https://apps.fs.usda.gov/fia/datamart/datamart.html), in the form of comma-delimited
#   (*.csv) files, or compressed comma-delimited files (*.zip).
# 
# Value:
# A list of data objects:
#   $states   - state names
#   $plt		  - Plot variables from PLOT table
#   $cond		  - Cond variables from COND table
#   $actualc	- If actual=TRUE, actual condition-level variables
#   $actualp	- If actual=TRUE, actual plot-level variables
#   $tree		  - If istree=TRUE, tree variables from TREE table
#   $seed 		- If isseed=TRUE, seedling variables from SEEDLING table
#   $spplt_*		- if issp=TRUE, SpatialPoints object with plot and some cond attributes represented 
#              at plot-level (see help for details).
#   $vspspp  - if isveg=TRUE, subplot understory vegetation from P2VEG_SUBPLOT_SPP
#   $vspstr  - if isveg=TRUE, subplot cover and layer understory vegetation from P2VEG_SUBP_STRUCTURE
#   $evalid  - if evalCur=TRUE or evalEndyr is not NULL, evalidation ID by state
#   $pltcnt  - number of plots by state, cycle, inventory year, and plot status
#   $dbconn - if datsource=ORACLE and dbconnopen=TRUE, the open ODBC dbconn
#
# If savedata=TRUE:
#	- If saveqry=TRUE, text file(s) of SQL queries used to extract data from database (*.txt),
#		Note: the plot and cond table is 1 query (pltcondqry*.txt).
#	- If parameters=TRUE, text file of parameters used. This file can be used to run program again 
#   (DBgetPlots_parameters_'date'.txt).
#	- If text file of plot and condition counts (pltcnt_*'date'.txt).
#	- If comma-delimited files of data frame objects (*'date'.csv).
#	- If issp=TRUE, an ESRI shapefile of plot and some condition attributes (shp_'spcooords'_'date'.shp).
#   Variable names are truncated to 10 characters or less. 
#	- If issp=TRUE, a comma-delimited file of the SpatialPoints data frame (shpdat_'spcooords'_'date'.csv).
#	- If issp=TRUE, a comma-delimited file of truncated names for conversion to shapefile
#   (shp_'spcooords'_'date'_newnames.shp). See notes for more info.
######################################################################################

help(DBgetPlots)

# Using GUI interface.
dat <- DBgetPlots()
names(dat)
save(dat, file=paste(outfolder, "dat.rda"), sep="/")

######################################################################################
# From CSV files
######################################################################################

# Most current evaluation and shapefile with public coordinates
WYdat1 <- DBgetPlots(datsource="CSV", states="Wyoming", evalCur=TRUE,
                    issp=TRUE)
names(WYdat1)
WYplt1 <- WYdat1$plt
WYcond1 <- WYdat1$cond
WYspplt_PUBLIC1 <- WYdat1$spplt_PUBLIC
WYdat1$evalid
WYdat1$pltcnt

# Look at output
head(WYcond1)
sp::plot(WYspplt_PUBLIC1, col=WYspplt_PUBLIC1$PLOT_STATUS_CD)
table(WYplt1$INVYR)

# Include tree data
WYdat1 <- DBgetPlots(datsource="CSV", states="Wyoming", evalCur=TRUE,
                    issp=TRUE, istree=TRUE)
names(WYdat1)
WYtree1 <- WYdat1$tree
head(WYtree1)


## From CSV files ##
# Most current evaluation and shapefile with public coordinates, 
# evalTypes - all, areavol, and growmort
##################################################################################
WYdat1a <- DBgetPlots(datsource="CSV", states="Wyoming", evalCur=TRUE,
                    issp=TRUE, evalType=c("all", "areavol", "growmort"))
names(WYdat1a)
WYplt1a <- WYdat1a$plt
WYcond1a <- WYdat1a$cond
WYdat1a$evalid

# Look at output
dim(WYplt1a)
head(WYplt1a)
table(WYplt1a$EVALID)

WYplt00 <- WYplt1a[WYplt1a$EVALID == 561700,]
dim(WYplt00)



## From CSV files ##
# Inventory years 2012:2014 and shapefile with public coordinates
##################################################################################
WYdat2 <- DBgetPlots(datsource="CSV", states="Wyoming", invyrs=2012:2014,
                    issp=TRUE)
names(WYdat2)
WYplt2 <- WYdat2$plt
WYcond2 <- WYdat2$cond
WYspplt_PUBLIC2 <- WYdat2$spplt_PUBLIC
WYdat2$evalid
WYdat2$pltcnt

# Look at output
head(WYcond2)
sp::plot(WYspplt_PUBLIC2, col=WYspplt_PUBLIC2$PLOT_STATUS_CD)
table(WYplt2$INVYR)


## From CSV files ##
# Two different states, most current evaluation
##################################################################################
UTWYdata <- DBgetPlots(datsource="CSV", states=c("Utah", "Wyoming"), evalCur=TRUE)
names(UTWYdata)
UTWYdata$pltcnt
UTWYplt <- UTWYdata$plt
table(UTWYplt$STATECD, UTWYplt$INVYR)


## From CSV files ##
# Two different states, one inventory year
##################################################################################
UTWY15data <- DBgetPlots(datsource="CSV", states=c("Utah", "Wyoming"), invyrs=2015)
names(UTWY15data)
UTWY15data$pltcnt
UTWY15plt <- UTWY15data$plt
table(UTWY15plt$STATECD, UTWY15plt$INVYR)


## From CSV files ##
# Two different states, different inventory years
##################################################################################
UTWYdata2 <- DBgetPlots(datsource="CSV", states=c("Utah", "Wyoming"), 
    invyrs=list(Utah=2010, Wyoming=2015))
names(UTWYdata2)
UTWYdata2$pltcnt


## From CSV files ##
# All years of periodic data for Wyoming
##################################################################################
WYdata.periodic <- DBgetPlots(datsource="CSV", states="Wyoming", invtype="PERIODIC", 
    allyrs=TRUE)
names(WYdata.periodic)
WYdata.periodic$pltcnt


## From CSV files ##
# Most current evaluation of periodic data for Wyoming
##################################################################################
WYdata.periodic2 <- DBgetPlots(datsource="CSV", states="Wyoming", invtype="PERIODIC", 
    evalCur=TRUE)
names(WYdata.periodic2)
WYdata.periodic2$pltcnt


## From CSV files ##
# Most current evaluation of Utah and Wyoming filtered for OWNCD=11
##################################################################################
UTWYdata.nfs <- DBgetPlots(datsource="CSV", states=c("Utah", "Wyoming"), evalEndyr=2017,
    allFilter="OWNCD == 11", evalType="ALL")
names(UTWYdata.nfs)
UTWYdata.nfs$pltcnt
table(UTWYdata.nfs$cond$ADFORCD)


## From CSV files ##
# Most current inventory years of Utah, filtered for OWNCD=11, include tree data
##################################################################################
UTdata.nfs <- DBgetPlots(datsource="CSV", states="Utah", invyrs=2008:2017,
    allFilter="OWNCD == 11", istree=TRUE)
names(UTdata.nfs)
UTdata.nfs$pltcnt
table(UTdata.nfs$cond$ADFORCD)


## Compare FIA Utah 2017 Evaluation and 2008-2017 Utah Inventory years
UTnfs.plt <- UTWYdata.nfs$plt[UTWYdata.nfs$plt$STATECD == 49,]
table(UTnfs.plt$PLOT_STATUS_CD)
dim(UTdata.nfs$tree[UTdata.nfs$tree$PLT_CN %in% UTnfs.plt$CN, ])

table(UTdata.nfs$plt$PLOT_STATUS_CD)
dim(UTdata.nfs$tree)


################## All Condition Inventory (ACI) data

## From CSV files ##
# Most current inventory years of Utah, filtered for OWNCD=11, include tree data with ACI
# Note: ACI data are not included in FIA evaluations, must specify inventory years
##################################################################################
UTdata.nfsACI <- DBgetPlots(datsource="CSV", states="Utah", invyrs=2008:2017,
    allFilter="OWNCD == 11", istree=TRUE, ACI=TRUE)
names(UTdata.nfsACI)
UTdata.nfsACI$pltcnt
table(UTdata.nfsACI$cond$ADFORCD)


## Compare FIA 2008-2017 Utah Inventory years, not including and including ACI data
table(UTdata.nfs$plt$PLOT_STATUS_CD)
dim(UTdata.nfs$tree)

table(UTdata.nfsACI$plt$PLOT_STATUS_CD)
dim(UTdata.nfsACI$tree)


## From CSV files ##
# All inventory years for Utah
##################################################################################
UTdat.all <- DBgetPlots(states="Utah", allyrs=TRUE)
names(UTdat.all)
UTplt.all <- UTdat.all$plt
table(UTplt.all$INVYR)



######################################################################################
# From ORACLE database
######################################################################################

WYdat <- DBgetPlots(states="Wyoming", evalCur=TRUE, issp=TRUE, dbconnopen=TRUE)
names(WYdat)
WYplt <- WYdat$plt
WYcond <- WYdat$cond
WYspplt_PUBLIC <- WYdat$spplt_PUBLIC
WYpltcnt <- WYdat$pltcnt
dbconn <- WYdat$dbconn

head(WYplt)
head(WYcond)
sp::plot(WYspplt_PUBLIC)
WYpltcnt


## From ORACLE database ##
# Actual data and SpatialPoints of public and actual coordinates
# Note: must have select permission to SDS tables.
##################################################################################
WYdat.actual <- DBgetPlots(states="Wyoming", actual=TRUE, issp=TRUE, invyrs=2015, 
                    spcoords=c("PUBLIC", "ACTUAL"), savedata=TRUE)
names(WYdat.actual)
WYactualp <- WYdat.actual$actualp
WYactualc <- WYdat.actual$actualc
head(WYactualp)
head(WYactualc)

WYspplt_PUBLIC <- WYdat.actual$spplt_PUBLIC
WYspplt_ACTUAL <- WYdat.actual$spplt_ACTUAL
sp::plot(WYspplt_PUBLIC)
sp::plot(WYspplt_ACTUAL, add=TRUE, col="red")


```


#### <a name="DBgetStrata"/>DBgetStrata()
```
######################################################################################
# Usage:
# DBgetStrata(dat = NULL, datsource = "ORACLE", ZIP = TRUE, FS_FIADB = TRUE, 
#   uniqueid = "CN", states = NULL, evalid = NULL, evalCur = FALSE, evalEndyr = NULL,
#   evalType = "areavol", savedata = FALSE, outfolder = NULL, outfn.pre = NULL,   
#   outfn.date = FALSE, overwrite = FALSE, dbconn = NULL, dbconnopen=FALSE,
#   POP_PLOT_STRATUM_ASSGN = NULL)
# 
# Description:
# Gets strata information from FIA's Oracle database or FIA DataMart, including:
# (1) strata and estimation unit assignment per plot; (2) total area by estimation unit;
# (3) pixel counts and number plots by strata/estimation unit. 
# 
# Value:
# A list of data objects:
#   $datstrat    - plot-level strata/estimation unit assignment  
#   $unitarea   - total acres by estimation unit
#   $unitvar     - name of estimation unit variable (ESTN_UNIT)
#   $areavar     - name acre variable (ACRES)
#   $strlut      - strata look-up table with summarized pixel counts (P1POINTCNT)
#   $strvar      - name of strata variable (STRATA)
#   $strwtvar    - name of strata weight variable (P1POINTCNT)
#   $evalid      - the evalid used
#
# If savedata=TRUE:
#	- Comma-delimited file of datstrat (*'date'.csv).
#	- Comma-delimited file of unitarea (*'date'.csv).
#	- Comma-delimited file of stratalut (*'date'.csv).
#	- If collapsed, a comma-delimited file of original classes and new collapsed classes.
######################################################################################

help(DBgetStrata)

# Using GUI interface.
datstrat <- DBgetStrata()
names(datstrat)


## From CSV files ##
# Get strata for the most current evaluation for Wyoming
WYstrat1 <- DBgetStrata(states="Wyoming", evalCur=TRUE, datsource="CSV")
names(WYstrat1)

WYdatstrat <- WYstrat1$pltstrat
head(WYpltstrat)
WYstrat1$unitarea
WYstrat1$unitvar
WYstrat1$areavar
WYstrat1$strlut
WYstrat1$strvar
WYstrat1$strwtvar
WYstrat1$evalid


## From ORACLE database ##
# Get strata information for a specific evaluation for Wyoming
WYstrat2 <- DBgetStrata(evalid=561200, savedata=TRUE, outfolder=outfolder)
names(WYstrat2)
WYpltstrat2 <- WYstrat2$pltstrat
head(WYpltstrat2)
WYstrat2$unitarea
WYstrat2$strlut
WYstrat2$strwtvar
WYstrat2$evalid


## From CSV files ##
# Get strata information for Wyoming, evaluation ending in 2014
WYstrat3 <- DBgetStrata(states="Wyoming", evalEndyr=2014, datsource="CSV")
names(WYstrat3)
WYpltstrat3 <- WYstrat3$pltstrat
head(WYpltstrat3)
WYstrat3$unitarea
WYstrat3$strlut
WYstrat3$strwtvar
WYstrat3$evalid


## From CSV files ##
# Get strata information for a specific set of Wyoming plots
WYstrat4 <- DBgetStrata(dat=WYplt, datsource="CSV")
names(WYstrat4)
WYpltstrat4 <- WYstrat4$pltstrat
head(WYpltstrat4)
WYstrat4$unitarea
WYstrat4$strlut
WYstrat4$evalid


## Get strata information for Wyoming plots, 1 inventory year
WY2013strat <- DBgetStrata(dat=WYplt[WYplt$INVYR == 2013, ])
names(WY2013strat)
WY2013pltstrat <- WY2013strat$pltstrat
head(WY2013pltstrat)
WY2013strat$unitarea
WY2013strat$strlut
WY2013strat$strwtvar
WY2013strat$evalid


## Get strata information for Utah and Wyoming, most current evaluations
UTWYstrat <- DBgetStrata(states=c("Utah", "Wyoming"), evalCur=TRUE)
names(UTWYstrat)
UTWYpltstrat <- UTWYstrat$pltstrat
table(UTWYpltstrat$STATECD)
UTWYstrat$unitarea
UTWYstrat$strlut
UTWYstrat$evalid


## Get strata information for Utah, evalid 491500 and Wyoming, evalid 561500
UTWYstrat2 <- DBgetStrata(evalid = list(Utah=491500, Wyoming=561500))
names(UTWYstrat2)
UTWYpltstrat2 <- UTWYstrat2$pltstrat
table(UTWYpltstrat2$STATECD)
UTWYstrat2$unitarea
UTWYstrat2$strlut
UTWYstrat2$strwtvar
UTWYstrat2$evalid


## Get strata information all inventory years of Utah
## Note: For plots locations that have been visited more than once: all 
#   plots are assigned an estimation unit and strata value, but area and 
#   strata proportions are from the most current evaluation.
UTdat.all <- DBgetPlots(states="Utah", allyrs=TRUE, datsource="CSV")
names(UTdat.all)
UTplt.all <- UTdat.all$plt
table(UTplt.all$INVYR)

UTstrat.all <- DBgetStrata(dat=UTplt.all, evalType="all", datsource="CSV")
names(UTstrat.all)
dim(UTplt.all)
pltstrat <- UTstrat.all$pltstrat
dim(pltstrat)

UTstrat.all$unitarea
UTstrat.all$strlut

UTplt.all[!UTplt.all$CN %in% pltstrat$CN, "PLOT_STATUS_CD"]


```

