---
title: "FIESTA - Green-book Estimators"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{FIESTA - Green-book Estimators}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


## FIESTA Overview
The R package, FIESTA (Forest Inventory ESTimation and Analysis) is a research estimation tool for analysts that work with sample-based inventory data from the U.S. Department of Agriculture, Forest Service, Forest Inventory and Analysis (FIA) Program. FIESTA can generate FIA's traditional state-wide estimates while also accommodate: unique population boundaries, different evaluation time periods, customized stratification schemes, non-standard variance equations, integration of multi-scale remotely-sensed data and other auxiliary information, and interaction with other modeling and estimation tools from CRAN R's library of packages. FIESTA contains a collection of functions that can access FIA databases, summarize and compile plot and spatial data, and generate estimates with associated sampling errors. 

Functions are organized by type or objective and are named with a corresponding prefix. FIESTA core functions facilitate data extraction and compilation of data input information and are used independently or within the FIESTA estimation modules. FIESTA estimation modules combine multiple functions from FIESTA or other packages to generate population estimates using different estimation strategies. Each module has an associated mod*pop function for compiling the population data and calculations (e.g., adjustments for nonresponse) for a custom boundary and can be used for generating multiple estimates. FIESTA analysis functions streamline different estimation routines by wrapping (i.e., combining) estimation modules and other functions for a specific purpose. 

**Core Functions**

* Database tools (DB) - functions for querying and extracting data from FIA's national database.
* Data tools (dat) - functions for summarizing and exploring FIA data.
* Spatial tools (sp) - functions for manipulating and summarizing spatial data.

**Estimation Modules (mod) **

* Green-Book (modGB) - functions for FIA's standard Green-Book estimators.
* Photo-Based (modPB) - functions for supplementary photo-based estimators.
* Small Area (modSA) - functions for integration with available small area estimators (SAE).
* Model-Assisted (modMA) - functions for integration with available Model-Assisted estimators.

**Analysis Functions**

* Analysis functions (an) - wrapper functions for steam-lining estimation processes.



### Green-Book (GB) module overview
FIESTA's Green-Book (GB) module calculates population estimates and their sampling errors based on Bechtold and Patterson's (2005), 'Green-Book' for FIA's nationally-consistent, systematic annual sample design, chapter 4 (Scott et al. 2005). FIA's sample design is based on 2 phases: the first phase uses remotely-sensed data to stratify the land area to increase precision of estimates; while the 2nd phase obtains photo and ground observations and measurements for a suite of information across a hexagonal grid, each approximately 6000 acres in size. The associated estimators and variance estimators are used for area and tree attribute totals with the assumption of a simple random, stratified design and double sampling for stratification. Adjustment factors are calculated by estimation unit and strata to account for nonsampled (nonresponse) conditions.   

Functions include non-ratio estimators for area and tree estimates by domain and ratio-of-means estimators for per-acre and per-tree estimates within domain. In addition, FIESTA adjusts for nonsampled conditions, supports post-stratification for reducing variance, and reports by estimation unit or a summed combination of estimation units. Output from the Green-Book module was tested and compared to output from FIA's publicly-available online tool (EVALIDator - https://apps.fs.usda.gov/Evalidator/evalidator.jsp) for state-level population estimates and associated sampling errors generated from the FIA Database (FIADB).

### Objective of tutorial
The main objective of this tutorial is to demonstrate how to use FIESTA for generating estimates and estimated variances using the 'Green Book' estimators with FIA's plot and standard population data from the FIA database (FIADB). This tutorial steps through the following topics to help use FIESTA's GB module. 

* [FIESTA parameters](#input)
* [Required variables for input tables](#required)
* [FIESTA output from Green-Book module](#output)
* [Reference tables](#ref)
* [GB Functions and Examples](#GBfun)
 


<a name="input"></a>

## FIESTA Green-Book Parameters - modGBarea(), modGBtree(), modGBratio()

The parameters for GB functions are organized by different categories based on population data and estimation output.

Population data:

1. [Population type](#ptyp)  
2. [Data tables and unique identifiers of plot](#dtab)  
3. [Estimation data](#edata)   
4. [Nonsample filters](#nonsamp)
5. [Estimation unit information](#estunit)
6. [Stratification information](#strat)

Estimation output:

1. [Plot/condition filters to subset table records](#filt)
2. [Tree information for tree estimates - modGBtree()](#tree) 
3. [Tree information for ratio estimates - modGBratio()](#rat)
4. [Output table information](#out1)
5. [Output table specifications](#out2)
6. [Output table title(s)](#title)


<a name="ptyp"></a>
**Population type**

The population types (i.e., Eval_Type) currently available for FIESTA estimation. The population type defines the set of sampled plots and data used for estimation. For example, if you are only interested in area estimates (popType='CURR'), you do not need the tree data. Other population types will be available in the future, including GRM (Growth, mortality, removals), P2VEG (understory vegetation), CHNG (Change), and DWM (down woody material). These population types may have different sets of plots based on what was sampled.

* **popType**    - Population type ('ALL', 'CURR', 'VOL').


<a name="dtab"></a>
**Data tables and unique identifiers**

The required data tables are from the FIA national database. Plot-level information, such as: state, county, or strata assignment may be included in the pltassgn table, or cond table (with pltassgn=NULL). The data table inputs can be the name of a comma-delimited file (\*.csv), a layer within a database, (e.g., SQLite), or an R data frame or data table object already loaded into R. The pltassgn table can also be a point shapefile (\*.shp), a spatial layer within a database, or a sf R object with one point per plot. The unique identifier for a plot must be provided in the corresponding parameter for each input table. See required variables section for a list of variables necessary to include for estimation.

* **tree**      - Tree-level data, with 1 record per tree - *required for modGBtree() or modGBratio() tree estimates*.
* **cond**      - Condition-level data, with 1 record per condition, including nonsampled conditions. May include estimation unit and strata assignment if plt=NULL and pltassgn=NULL - *required for all estimates*. 
* **plt**       - Plot-level data, with 1 record per plot, including nonsampled conditions. May include nonsampled plots if PLOT_STATUS_CD variable is in dataset. May include estimation unit and strata assignment if pltassgn=NULL - *optional for all estimates*. 
* **pltassgn**  - Plot-level data, with 1 record per plot and plot assignment of estimation unit and strata, if applying stratification. If nonsampled plots are included, PLOT_STATUS_CD variable must be in table. These plots are excluded from the analysis.       - *optional for all estimates*.
* **seed**      - Seedling data, with 1 record per seedling count - *required for modGBtree() or modGBratio() seedling estimates*.
* **dsn**       - Data source name of database where data table layers reside.
* **tuniqueid** - Unique identifier for plot in tree or seed.
* **cuniqueid** - Unique identifier for plot in cond.
* **condid**    - Unique identifier for conditions in cond (default="CONDID").
* **pltassgnid**- Unique identifier for plot in pltassgn, if pltassgn is included.
* **pjoinid**   - Join variable in plot to match pltassgnid. Does not need to be unique.


<a name="edata"></a>
**Estimation area info**

Define information for area estimation.

* **areawt**    - Variable to use for calculating area estimates (e.g., CONDPROP_UNADJ). This may change for other population types.
* **adj**       - Adjustment for nonresponse ('none', 'samp', 'plot'). Note: adj='samp', expands area across strata and estimation unit(s), based on the summed proportions of sampled conditions divided by the total plots in the strata/estimation unit; adj='plot', expands area across plot based on 1 divided by the summed proportions of sampled conditions in plot.


<a name="popfilters"></a>
**Population filters**

Population filters subset the plot data set before population calculations are generated. 

* **evalid**    - If multiple evaluations are in dataset, select evalid for estimation.
* **invyrs**    - If want to subset inventory years in dataset for estimation.
* **intensity** - If want to specify intensification number of code to use for estimation.
* **ACI**       - Logical. If TRUE, includes All Condition Inventory (ACI) conditions and associated tree data in estimates. If FALSE, a filter, is applied to remove nonsampled nonforest conditions (see cond.nonsamp.filter).


<a name="nonsamp"></a>
**Nonsample filters**

Nonsample filters remove nonsample (i.e., nonresponse) conditions from the dataset. Nonsample filters are defined internally, unless otherwise specified.

* **plt.nonsamp.filter** - A predefined filter for nonsampled (nonresponse) plots (PLOT_STATUS_CD != 3).
* **cond.nonsamp.filter** - A predefined filter for nonsampled (nonresponse) conditions (COND_STATUS_CD != 5; or if ACI=TRUE: is.na(NF_COND_STATUS_CD) | NF_COND_STATUS_CD != 5). 


<a name="estunit"></a>
**Estimation unit information**

An estimation unit is a population, or area of interest, with known area and number of plots. As an example, in Interior-West FIA, an estimation unit is generally an individual county. An estimation unit may be a subpopulation of a larger population (e.g., Counties within a State). Subpopulations are mutually exclusive and independent within a population, therefore estimated totals and variances are additive. Each plot is assigned to only one estimation unit based on plot center and can be stored in either pltassgn or cond. 

* **unitvar** - Name of the estimation unit variable in cond or pltassgn with assignment for each plot (e.g., 'ESTN_UNIT').
* **unitvar2** - Name of a second estimation unit variable in cond or pltassgn with assignment for each plot (e.g., 'STATECD').
* **unitarea**  - Total acres by estimation unit. If only 1 estimation unit, include a number representing total acreage for the area of interest. If more than one estimation unit, provide a data frame/data table of total acres by estimation unit, with variables defined by unitvar and areavar. 
* **areavar**   - Name of acre variable in unitarea (Default = "ACRES").
* **unitcombine** - TRUE, an automated procedure occurs to combine estimation units if less than 10 plots (See note below for more details).


<a name="strat"></a>
**Strata information**

Stratification is used to reduce variance in population estimates by partitioning the population into homogenous classes (strata), such as forest and nonforest. For stratified sampling methods, the strata sizes (weights) must be either known or estimated. Remotely-sensed data is often used to generate strata weights with proporation of pixels by strata. If stratification is desired (strata=TRUE), the required data include: stratum assignment for the center location of each plot, stored in either pltassgn or cond; and a look-up table with the area, pixel count, or proportion of the total area (strwt) of each strata value by estimation unit, making sure the name of the strata (and estimation unit) variable and values match the plot assignment name(s) and value(s). If strata (and estimation unit) variables are included in cond, all conditions in a plot must have the same strata (and estimation unit) value.

* **strata**    - TRUE, use stratification for variance reduction.
* **stratalut** - Look-up table with pixel counts, area, or proportions (strwt) by strata (and estimation unit).
* **strvar**    - Name of strata variable in stratalut and pltassgn or cond table with strata assignment for each plot.
* **getwt**     - If TRUE, calculates strata weights from getwtvar in stratalut.
* **getwtvar**  - Name of variable in stratalut to calculate weights (e.g., pixels counts). Default="P1POINTCNT". 
* **nonresp**   - TRUE, if substrata are used to minimize bias of nonresponse (currently not available).
* **substrvar** - Name of substrata variable in stratalut and table with substrata assignment for each plot (currently not available).
* **stratcombine** - TRUE, an automated procedure occurs to combine strata within estimation units if less than 2 plots (See note below for more details).


Note: 
A minimum of 2 plots per strata is necessary for stratification. If there are less than 2 plots in any strata/estimation combination, an error occurs with a message to collapse classes. If autocombine=TRUE, an automated procedure occurs to collapse all strata/estimation unit combinations that have 10 or less plots (Westfall and others, 2011). The procedure collapses classes based on the order of estimation units in stratalut. If an estimation unit has 10 or less plots, it is grouped with the estimation unit following in the table. If it is the last estimation unit in the table, it is grouped with the estimation unit prededing in the table.  


<a name="filt"></a>
**Estimation Filters**

Filters subset the area of the sample population for the desired output. Filters do no change the population data used for estimate (e.g., number of plots, strata weights). Some filters are defined internally, depending on the dataset, such as land area of interest (landarea) or inclusion of ACI (All Condition Inventory) data. Others are specified according to the input table, such as pfilter or cfilter. The nonsamp.filter is for removing nonsampled conditions and is applied, internally, unless otherwise stated. *All filter expressions must be in R syntax*.

* **landarea**       - A predefined cond filter depending on desired sample land area {ALL, FOREST (COND_STATUS_CD=1), TIMBERLAND (SITECLCD in(1:6) & RESERVCD=0)}.
* **pfilter**    - Plot-level filter.
* **cfilter**    - Condition-level filter.


<a name="tree"></a>
**Tree information for tree estimates - modGBtree()**

Tree information is used for calculating estimates for derived tree data, such as basal area (BA), volume (e.g., VOLCFNET), or number of trees (i.e., TPA_UNADJ). All variables except number of tree variables are extrapolated to the acre plot size by multiplying by TPA_*). 

* **estvar**        - Name of estimate variable in tree (e.g., VOLCFNET, TPA_UNADJ).
* **estvar.filter** - Tree-level filter (e.g., 'STATUS_CD == 1 & DIA >= 5.0').
* **estvar.name**   - A name for aggregated estvar (Default = estvar'_SUM').

<a name="rat"></a>
**Tree information for ratio estimates - modGBratio()**

Tree information is used for calculating per-acre ratio estimates (numerator) and per-tree ratio estimates (numerator and denominator) from derived tree data, such as basal area (BA), volume (e.g., VOLCFNET), or number of trees (i.e., TPA_UNADJ). All variables except number of tree variables are extrapolated to the acre plot size by multiplying by TPA_*).

* **ratiotype** - If ratio estimate, the ratio type ("PERACRE", "PERTREE").
* **estvar(n)**        - Numerator - Name of estimate variable (e.g., VOLCFNET, TPA_UNADJ)
* **estvar(n).filter** - Numerator - Tree-level filter(s).
* **estvar(n).name**   - Numerator - A name for aggregated estvar (Default = estvar(n)'_SUM').
* **estvard**        - Denominator - Name of estimate variable (e.g., VOLCFNET, TPA_UNADJ)
* **estvard.filter** - Denominator - Tree-level filter(s).
* **estvard.name**   - Denominator - A name for aggregated estvar (Default = estvard'_SUM').


<a name="out1"></a>
**Output table information**

The following parameters define how estimates will be generated (i.e., by domain) and how the output table will be set up (i.e., by row/column). Output tables may be: by row domain; by row domain and column domain; or for total estimates, where row and column domains are NULL. If only one domain is desired, the rowvar must be populated, leaving the colvar=NULL. Row and columns may be ordered in a particular way, defined by row.orderby and col.orderby variables. A default set of code names are stored internally (FIESTA::ref_codes). If row.FIAname/col.FIAname = TRUE and the respective rowvar/colvar is in ref_codes, the default code description is used in output tables.

* **rowvar**        - Name of row variable (domain). If area estimate, rowvar must be from cond (e.g., FORTYPCD). If tree or ratio estimate, rowvar can be from cond or tree (e.g., SPCD).
* **colvar**        - Name of column variable (domain). If area estimate, colvar must be from cond (e.g., FORTYPCD). If tree or ratio estimate, colvar can be from cond or tree (e.g, SPCD).
* **row.FIAname**   - TRUE, gets FIA reference name for rowvar, if available.
* **col.FIAname**   - TRUE, gets FIA reference name for colvar, if available.
* **row.orderby**   - Name of variable to order values of rowvar (if row.FIAname=FALSE).
* **col.orderby**   - Name of variable to order values of colvar (if col.FIAname=FALSE).
* **row.add0**      - TRUE, add 0 values in table for row values that occur in input dataset or in rowlut, but are not in final estimate.
* **col.add0**      - TRUE, add 0 values in table for column values that occur in input dataset or in rowlut, but are not in final estimate.
* **rowlut**        - A lookup table with variable codes and descriptions to include in rows of output table (See note following for more details).
* **collut**        - A lookup table with specific variable codes and descriptions to include in columns of output table (See note following for more details).

Note: 
rowlut/collut - There are several objectives for including rowlut/collut look-up tables: 1) to include descriptive names that match row/column codes in the input table; 2) to use number codes that match row/column names in the input table for ordering rows; 3) to add rows and/or columns with 0 values for consistency. No duplicate names are allowed.

Include 2 columns in the table: 1-the merging variable with same name as the variable in the input merge table; 2-the ordering or descriptive variable. If the ordering variable is the rowvar/colvar in the input table and the descriptive variable is in rowlut/collut, set row.orderby/col.orderby equal to rowvar/colvar. If the descriptive variable is the rowvar/colvar in the input table, and the ordering code variable is in rowlut/collut, set row.orderby/col.orderby equal to the variable name of the code variable in rowlut/collut. 


<a name="out2"></a>
**Output table specifications**

The final parameters dictate what the output will look like, such as: how to display the sample error; how many digits to round values to; whether to include a title; and whether to write the output to a folder or only return as R objects.  

* **sumunits**  - TRUE, sum estimates by estimation units (sub-populations) into one estimate (e.g., Counties to State).
* **allin1**     - TRUE, table cells include: estimates (% sample error).
* **estround**   - Number of digits to round estimates to (for modGBarea and modGBtree, default=0; for modGBratio, default=3).
* **cvround**    - Number of digits to round % sample error to (for modGBarea and modGBtree, default=3; for modGBratio, default=3).
* **savedata**   - TRUE, save data to outfolder.
* **rawdata**    - TRUE, if output of raw data information is desired. See output values for details.
* **outfolder**  - Name of folder to output data to (Default = working directory or window to browse).
* **outfn**      - Name of file for output data (Default = 'esttype_'estvar.name'_'rowvar'_'date'.csv').
* **outfn.pre**  - Add a prefix to output name (e.g., '01_*').
* **outfn.date** - Add a date to output name (e.g., '*_20200220').
* **overwrite**  - TRUE, overwrites existing files.
* **addtitle**   - TRUE, add title to tables.
* **returntitle**  - TRUE, return table titles.


<a name="title"></a>
**Title parameters**

If saving to a folder, and a title is desired, there are parameters for including a specific title or for generating a title based on pieces of information. 

* **title.main** - Full title for table.
* **title.ref**  - The ending text for table title. If not NULL, included with title.main.
* **title.rowvar**  - Pretty name for rowvar for table title (If NULL, default = rowvar).
* **title.colvar**  - Pretty name for colvar for table title (If NULL, default = colvar).
* **title.unitvar** - Pretty name for unitvar for table title (If NULL and sumunits=FALSE, default = unitvar).
* **title.estvar**  - Pretty name for estvar for table title (If NULL, default = estvar). For ratio estimates, title.estvarn (default = estvarn) and title.estvard (default = estvard).
* **title.filter**  - Pretty name for any filters for table title.


<a name="required"></a>

## Required variables in input data tables

The following variables by data table are required for successful FIESTA output.

```{r, results = 'asis', echo=FALSE}

#required.lut <- read.table("C:/_tsf/_GitHub/meta/required_variables.txt", header=TRUE, sep="\t")

required.lut <- data.frame(
  Table = c("tree", "", "", "cond", "", "", "", "", "", "", "", "", "", "plot", "", ""), 
  Variable = c("*tuniqueid*", "CONDID", "TPA_UNADJ", "*cuniqueid*", "CONDID", "CONDPROP_UNADJ", 
               "COND_STATUS_CD", "NF_COND_STATUS_CD", "SITECLCD", "RESERVCD", "SUBPROP_UNADJ",
               "MICRPROP_UNADJ", "MACRPROP_UNADJ", "*puniqueid*", "STATECD", "INVYR"), 
  Description = c("Unique identifier for each plot, for joining tables (ex. PLT_CN)", 
    "Unique identifier for each condition on plot, for joining tables. Optional if only 1 condition (record)   per plot", 
    "Number of trees per acre each sample tree represents (ex. DESIGNCD=1: TPA_UNADJ=6.018046 for trees on subplot; 74.965282 for trees on microplot)", "Unique identifier for each plot, for joining tables (e.g., PLT_CN)", 
    "Unique identifier for each condition on plot, for joining tables. Optional if only 1 condition (record) per plot", 
    "Unadjusted proportion of condition on each plot. Optional if only 1 condition (record) per plot", 
    "Status of each forested condition on plot (i.e. accessible forest, nonforest, water, etc.)", 
    "Only if ACI=TRUE. Status of each nonforest condition plot (i.e. accessible nonforest, nonsampled nonforest)", 
    "Only if landarea=TIMBERLAND. Measure of site productivity", 
    "If landarea=TIMBERLAND. Reserved status", 
    "Unadjusted proportion of subplot conditions on each plot. Optional if only 1 condition (record) per plot", 
    "If microplot tree attributes. Unadjusted proportion of microplot conditions on each plot. Optional if only 1 condition (record) per plot", 
    "If macroplot tree attributes. Unadjusted proportion of macroplot conditions on each plot. Optional if only 1 condition (record) per plot", 
    "Unique identifier for each plot, for joining tables (ex. CN)", 
    "Identifies state each plot is located in. Optional if only 1 state", 
    "Identifies inventory year of each plot. Optional. Assumes estimation time span is less than inventory cycle"), 
    stringsAsFactors = FALSE)

library(knitr)
kable(required.lut,
  format = "pandoc",   # default
  # caption = "Title of the table",
  col.names = names(required.lut),
  row.names = FALSE,
  align = c("l"),       # align = c("c", "c", "c", "r")
  # padding = 2         # inner spacing
)

```


<a name="output"></a>

## Output values from FIESTA Green-Book module

Estimates with percent sampling error for the row domain (and column domain) specified by the input parameters. This can be in the form of one table or two separate tables, depending on the number of domains and on allin1 parameter. 

A list object with one or more of the following components. If savedata=TRUE, all output data frames are written to outfolder.

* **$est** - Data frame with estimates by rowvar, colvar (and estimation unit). If sumunits=TRUE or one estimation unit and colvar=NULL, estimates and percent sampling error (confidence level 68%) are all in est. For 95% percent confidence level multiply percent sampling error by 1.96.
* **$pse** - Data frame with percent sampling errors corresponding to est.
* **$titlelst** - If returntitle=TRUE, a list with one or two titles for est and pse, depending on number of output data frames (see below for list components).
* **$raw** - If rawdata=TRUE, a list of raw data used in the estimation process.
* **$GBpopdat** - If GBpopdat=NULL, list of the population data used for estimation is returned (see below for list components). This object can be to modGB* estimation modules for efficiency.


### Population data used for producing estimates (GBpopdat$):
* **GBpopdat$condx**       - Data frame of condition data within population, including plot assignments, condition proportion adjustment factor (cadjfac), and adjusted condition proportions (CONDPROP_ADJ).
* **GBpopdat$pltcondx**    - Data frame of plot/condition data within population, used for estimation.
* **GBpopdat$cuniqueid**   - Unique identifier of plot in condx and pltcondx.
* **GBpopdat$condid**      - Unique identifier of condition in condx and pltcondx.
* **GBpopdat$treex**       - Data frame of tree data within population, used for estimation, including trees per acre adjustment factor (tadjfac), and adjusted trees per acre (TPA_ADJ).
* **GBpopdat$tuniqueid**   - Unique identifier of plot in treex.
* **GBpopdat$ACI.filter**  - Filter used for excluding ACI plots if ACI=FALSE.
* **GBpopdat$unitarea**    - Data frame with area by estimation unit.
* **GBpopdat$areavar**     - Name of area variable in unitarea.
* **GBpopdat$unitvar**     - Name of estimation unit variable in unitarea and condx.
* **GBpopdat$stratalut**      - Data frame of stratification information by estimation unit. See below for variable descriptions.
* **GBpopdat$strvar**      - Name of strata variable in stratalut and condx 
* **GBpopdat$expcondtab**  - Data frame of condition-level area expansion factors.
* **GBpopdat$plotsampcnt** - Number of plots by plot status.
* **GBpopdat$condsampcnt** - Number of conditions by condition status.
* **GBpopdat$states**      - States of FIA plot data used in estimation (for title reference).
* **GBpopdat$invyrs**      - Inventory years of FIA plot data used in estimation (for title reference).

```{r, results = 'asis', echo=FALSE}

#stratdat.lut <- read.csv("C:/_tsf/_GitHub/meta/stratdat_variables.csv", stringsAsFactors=FALSE)
#source("C:/_tsf/_GitHub/meta/undataframe.R")
#stratdat.lut <- undataframe(stratdat.lut)

stratdat.lut <- data.frame(
Variable = c("ESTN_UNIT", "STRATUMCD", "P1POINTCNT", "P2POINTCNT", "n.strata", "n.total", "strwt", "CONDPROP_UNADJ_SUM", "cadjfac", "ACRES", "expfac", "EXPNS"), 
Description = c("Estimation unit", "Strata value", "Number of pixels by strata and estimation unit", "Number of P2 plots in population data", "Number of sampled plots in strata", "Number of sampled plots for estimation unit", "Proportion of pixels in strata (strata weight)", "Summed condition proportion in strata", "Adjustment factor for nonsampled plots in strata (CONDPROP_UNADJ_SUM/n.strata)", "Total acres for estimation unit", "Expansion factor, in acres, area in strata divided by number of sampled plots", "Expanded area, in acres, expfac multiplied by strwt"), 
    stringsAsFactors = FALSE)

library(knitr)
kable(stratdat.lut,
  format = "pandoc",   # default
  caption = "Description of variables in stratdat.",
  col.names = names(stratdat.lut),
  row.names = FALSE,
  align = c("l"),       # align = c("c", "c", "c", "r")
  # padding = 2         # inner spacing
) 

```

### Raw data used for producing estimates (If rawdata=TRUE, raw$):
The raw data includes the domain-level data set used for estimation and separate data frames with calculated variables used in estimation process. The number of processing tables depends on the input parameters. The tables include:

* **raw$domdat**      - Plot domain data used for estimation.
* **raw$unit.totest** - Total by estimation unit 
* **raw$unit.rowest** - If rowvar != NULL, rowvar totals by estimation unit
* **raw$unit.colvar** - If colvar != NULL, colvar totals by estimation unit
* **raw$unit.grpvar** - If colvar != NULL, a combination of rowvar and colvar by estimation unit
* If sumunits=TRUE, the raw data for the summed estimation units are also included: (totest, rowest, colest, grpest, respectively). These tables do not included estimate proportions (nhat and nhat.var). See below for variable descriptions.
* **raw$totest** - Total by estimation unit, summed to population 
* **raw$rowest** - If rowvar != NULL, rowvar totals by estimation unit, summed to population
* **raw$colvar** - If colvar != NULL, colvar totals by estimation unit, summed to population
* **raw$grpvar** - If colvar != NULL, a combination of rowvar and colvar by estimation unit, summed to population 


```{r, results = 'asis', echo=FALSE}


nonratio <- data.frame(Variable = c("nhat", "nhat.var", "est", "est.var"), Description = c("Estimated proportion", "Variance estimate of estimated proportion", "Estimated acres { nhat * ACRES }", "Variance estimate of estimated acres { nhat * ACRES^2 }"), stringsAsFactors = FALSE)

ratio <- data.frame(Variable = c("nhat", "nhat.var", "dhat", "dhat.var", "covar", "estn", "estd", "estn.var", "estn.se", "estn.cv", "estn.pse", "estd.var", "estd.se", "estd.cv", "estd.pse", "est.covar", "rhat", "rhat.var", "rhat.se", "rhat.cv", "est", "est.var"), Description = c("Estimated proportion of land, for numerator", "Variance estimate of estimated proportion of land, for numerator", "Estimated proportion of land, for denominator", "Variance estimate of estimated proportion of land, for denominator", "Covariance of estimated proportion of numerator and denominator", "Estimated acres, for numerator", "Estimated acres, for denominator", "Variance estimate of estimate acres, for numerator", "Standard error estimated acres, for numerator", "Coeffiecient of variation of estimated acres, for numerator", "Percent sampling error of estimate, for numerator", "Variance estimate of estimate acres, for denominator", "Standard error estimated acres, for denominator", "Coefficient of variation of estimated acres, for denominator", "Percent sampling error of estimate, for denominator", "Covariance of estimated acres of numerator and denominator", "Ratio of estimated proportions (numerator/denominator)", "Variance of ratio of estimated proportions", "Standard error of ratio of estimated proportions { rhat.se/rhat }", "Coefficient of variation of ratio of estimated proportions { sqrt(rhat.var) }", "Estimated percent cover of land { rhat*100 }", "Variance of estimated percent cover of land { rhat.var*100^2 }"), stringsAsFactors = FALSE)

all <- data.frame(Variable = c("NBRPLT.gt0", "ACRES", "est.se", "est.cv", "pse", "CI99left", "CI99right", "CI95left", "CI95right", "CI68left", "CI68right"), Description = c("Number of nonzero plots used in estimate", "Total acres for estimation unit", "Standard error of estimated acres { sqrt(est.var) }", "Coefficient of variation of estimated acres { est.se/est }", "Percent sampling error of estimate { est.cv * 100 }", "Left tail of 99% confidence interval for estimate { est - (2.58*est.se) }", "Right tail of 99% confidence interval for estimate { est + (2.58*est.se) }", "Left tail of 95% confidence interval for estimate { est - (1.96*est.se) }", "Right tail of 95% confidence interval for estimate { est + (1.96*est.se) }", "Left tail of 68% confidence interval for estimate { est - (0.97*est.se) }", "Right tail of 68% confidence interval for estimate { est + (0.97*est.se) }"), stringsAsFactors = FALSE)


library(knitr)
kable(nonratio,
  format = "pandoc",   # default
  caption = "Description of variables in nonratio tables.",
  col.names = names(nonratio),
  row.names = FALSE,
  align = c("l"),       # align = c("c", "c", "c", "r")
  # padding = 2         # inner spacing
) 

library(knitr)
kable(ratio,
  format = "pandoc",   # default
  caption = "Description of variables in nonratio tables.",
  col.names = names(ratio),
  row.names = FALSE,
  align = c("l"),       # align = c("c", "c", "c", "r")
  # padding = 2         # inner spacing
) 

library(knitr)
kable(all,
  format = "pandoc",   # default
  caption = "Description of variables in nonratio and ratio tables.",
  col.names = names(all),
  row.names = FALSE,
  align = c("l"),       # align = c("c", "c", "c", "r")
  # padding = 2         # inner spacing
) 

```


<a name="ref"></a>

## Reference Tables in FIESTA

There are several reference tables stored in FIESTA, including table variable descriptions, code definitions, and estimation categories. 

* Table variable descriptions - ref_plt, ref_cond, ref_tree
* Code definitions - ref_codes
* Domain variables - ref_domain
* Estimation variables - ref_estvar

getdomain()
getestvar()



<a name="GBfun"></a>

## GB Functions and Examples

The following examples are for generating FIA's traditional, state-level estimate, using standard FIA Evaluation data from FIA's National database, including associated Estimation unit and Stratification information. The examples use data from three inventory years of field measurements in the state of Wyoming, from FIADB_1.7.2.00, last updated June 20, 2018, downloaded on June 25, 2018 and stored as internal data objects in FIESTA.


## Example data - Wyoming (WY), Inventory Years 2011-2013

Data Frame  | Description
:-----------| :-----------------------------------------------------------------------------------
WYpltassgn  | WY plot-level data with strata and estimation unit assignments
WYcond      | WY condition-level data
WYtree      | WY tree-level data
WYunitarea | WY estimation unit look-up table with total acres by estimation unit (ESTUNIT)
WYstratalut    | WY strata look-up table with pixel counts (P1POINTCNT) by strata and estimation unit

External data             | Description
:-------------------------| :------------------------------------------------------------------------
WYbighorn_adminbnd.shp    | Polygon shapefile of WY Bighorn National Forest Administrative boundary^1^
WYbighorn_districtbnd.shp | Polygon shapefile of WY Bighorn National Forest District boundaries^2^

^1^USDA Forest Service, Automated Lands Program (ALP). 2018. S_USA.AdministrativeForest (http://data.fs.usda.gov/geodata/edw). Description: An area encompassing all the National Forest System lands administered by an administrative unit. The area encompasses private lands, other governmental agency lands, and may contain National Forest System lands within the proclaimed boundaries of another administrative unit. All National Forest System lands fall within one and only one Administrative Forest Area.

^2^USDA Forest Service, Automated Lands Program (ALP). 2018. S_USA.RangerDistrict (http://data.fs.usda.gov/geodata/edw). Description: A depiction of the boundary that encompasses a Ranger District.



#### Set up for examples


```
# Load library
library(FIESTA)

## If not on windows platform, set up an outfolder to output from examples
if (.Platform$OS.type == "windows") {
  # Set workspace to FIESTA folder (create if doesn't exist)
  if (!file.exists("C:/FIESTA"))  {
    dir.create("C:/FIESTA")
  }
  setwd("C:/FIESTA")

  if (!file.exists("outfolder")) {
    dir.create("outfolder")
  }
  outfolder <- "outfolder"
}


```


#### GB Functions
* [modGBarea()](#modGBarea)
* [modGBtree()](#modGBtree)
* [modGBratio()](#modGBratio)
* [modGBpop()](#modGBpop)

<a name="modGBpop"></a>

#### modGBpop

```
######################################################################################
# Usage:
# modGBpop(popType="VOL", cond, plt = NULL, tree = NULL, seed = NULL, 
#   vspspp = NULL, subplot = NULL, subp_cond = NULL, pltassgn = NULL, dsn = NULL,  
#   puniqueid = "CN", pltassgnid = "CN", pjoinid = "CN", tuniqueid = "PLT_CN",     
#   cuniqueid = "PLT_CN", condid = "CONDID", areawt = "CONDPROP_UNADJ", adj = "samp",  
#   evalid = NULL, invyrs = NULL, intensity = NULL, ACI = FALSE, unitvar = NULL,     
#   unitvar2 = NULL, unitarea = NULL, areavar = "ACRES", unitcombine = FALSE, 
#   minplotnum.unit = 10, strata = TRUE, stratalut = NULL, strvar = "STRATUMCD",    
#   getwt = TRUE, getwtvar = "P1POINTCNT", stratcombine = TRUE, saveobj = FALSE,  
#   savedata = FALSE, outfolder = NULL, out_fmt = "csv", out_dsn = NULL,  
#   outfn.pre = NULL, outfn.date = TRUE, overwrite_dsn = FALSE,  
#   overwrite_layer = TRUE, GBdata = NULL, GBstratdat = NULL, gui = FALSE)
# 
# Description:
# Generates population data for input to modGB* estimation modules. Data includes
# strata weights, number of plots by strata and estimation unit, strata-level
# expansion factors, and sample-based area adjustment factors.  
# - checks input parameters and data tables
# - checks unitarea data
# - checks auxiliary data (i.e., stratification data)
# - calculates adjustment factors for nonresponse
########################################################################################

help(modGBpop)


## Get population data for Wyoming area of interest using post-stratification
########################################################################################
GBpopdat <- modGBpop(cond=WYcond, tree=WYtree, pltassgn=WYpltassgn, pltassgnid="CN", 
    unitarea=WYunitarea, unitvar="ESTN_UNIT", strata=TRUE, stratalut=WYstratalut)

## Get names of list components
names(GBpopdat)

## Look at population data
names(GBpopdat)
GBpopdat$plotsampcnt	# Number of plots after plot filter
GBpopdat$condsampcnt	# Number of conditions after plot filter, before cond filters
GBpopdat$stratalut      # Strata information and adjustment factors


```



<a name="modGBarea"></a>

#### modGBarea

```
######################################################################################
# Usage:
# modGBarea(GBpopdat = NULL, landarea = "FOREST", pfilter = NULL, cfilter = NULL,    
#   rowvar = NULL, colvar = NULL, row.FIAname = FALSE, col.FIAname = FALSE,    
#   row.orderby = NULL, col.orderby = NULL, row.add0 = FALSE, col.add0 = FALSE,   
#   rowlut = NULL, collut = NULL, rowgrp = NULL, rowgrpnm = NULL, rowgrpord = NULL, 
#   sumunits = FALSE, allin1 = FALSE, estround = 0, pseround = 2, 
#   estnull = 0, psenull = "--", divideby = NULL, savedata = FALSE, rawdata = FALSE,  
#   rawonly = FALSE, outfolder = NULL, outfn.pre = NULL, outfn.date = TRUE,  
#   overwrite = TRUE, addtitle = TRUE, returntitle = FALSE, title.main = NULL, 
#   title.ref = NULL, title.rowvar = NULL, title.colvar = NULL,  
#   title.unitvar = NULL, title.filter = NULL, gui = FALSE, ...)
# 
# Description:
# Generates acre estimates by domain (and estimation unit). Calculations are based on 
# Scott et al. 2005 ('the green-book') for mapped forest inventory plots. The non-ratio 
# estimator for estimating area by stratum and domain is used. Plots that are totally 
# nonsampled are excluded from estimation dataset. Next, an adjustment factor is 
# calculated by strata to adjust for nonsampled (nonresponse) conditions that have 
# proportion less than 1. The attribute is the proportion of the plot which is divided 
# by the adjustment factor, and averaged by stratum. Strata means are combined using the
# strata weights and then expanded to acres using the total land area in the population.  
########################################################################################

#help(modGBarea)


## Area of forest land and % sampling error, Wyoming, 2011-2013 (sum estimation units)
########################################################################################
area1 <- modGBarea(cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", unitarea=WYunitarea, 
    unitvar="ESTN_UNIT", stratalut=WYstratalut, landarea="FOREST", sumunits=TRUE)

## Get names of list components
names(area1)

## Look at estimate table from area1 list
area1$est


## Area of forest land and % sampling error, Wyoming, 2011-2013 (sum estimation units)
## Add raw data and return title
#######################################################################################
area1 <- modGBarea(cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", unitarea=WYunitarea, 
  unitvar="ESTN_UNIT", stratalut=WYstratalut, landarea="FOREST", sumunits=TRUE,
  rawdata=TRUE, returntitle=TRUE)

## Get names of list components
names(area1)

## Look at estimate table from area1 list
area1$est

## Get list of raw data from area1 list components and look at names
raw.tot <- area1$raw
names(raw.tot)
raw.tot$unit.totest	# Raw data for total estimates by estimation unit
raw.tot$totest		  # Raw data for total estimates by estimation unit summed to one estimate

## Look at population data
GBpopdat <- area1$GBpopdat
names(GBpopdat)
GBpopdat$plotsampcnt	# Number of plots after plot filter
GBpopdat$condsampcnt	# Number of conditions after plot filter, before cond filters
GBpopdat$stratalut    # Strata information and adjustment factors

## Look at titles
area1$titlelst


## Add table rows:
## Area of forest land and % sampling error by forest type, Wyoming, 2011-2013
####################################################################################
## Rows only; combine estimation units (sumunits=TRUE)
area2a <- modGBarea(cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  unitvar="ESTN_UNIT", unitarea=WYunitarea, stratalut=WYstratalut, landarea="FOREST", 
  rowvar="FORTYPCD", row.FIAname=TRUE, sumunits=TRUE, savedata=TRUE, 
  returntitle=TRUE, outfolder="outfolder")
area2a$est

## Rows only; combine estimation units (sumunits=TRUE; allin1=TRUE)
area2b <- modGBarea(cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  unitvar="ESTN_UNIT", unitarea=WYunitarea, stratalut=WYstratalut, landarea="FOREST", 
  rowvar="FORTYPCD", row.FIAname=TRUE, sumunits=TRUE, allin1=TRUE)
area2b$est


## Add row and columns to table
## Area of forest land and % sampling error by forest type and stand-size class, 
##    Wyoming, 2011-2013
######################################################################################
 
## Rows and columns; combine estimation units (sumunits=TRUE)
area3a <- modGBarea(cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN",   
  unitvar="ESTN_UNIT", unitarea=WYunitarea, strata=TRUE, stratalut=WYstratalut,   
  landarea="FOREST", rowvar="FORTYPCD", colvar="STDSZCD", row.FIAname=TRUE,
  col.FIAname=TRUE, sumunits=TRUE)
area3a$est
area3a$pse
GBpopdat <- area3a$GBpopdat


## Try adding GBpopdat
area3aa <- modGBarea(GBpopdat=GBpopdat, landarea="FOREST", rowvar="FORTYPCD",  
  colvar="STDSZCD", row.FIAname=TRUE, col.FIAname=TRUE, sumunits=TRUE)
area3aa$est
area3aa$pse


## Rows and columns; combine estimation units (sumunits=TRUE; allin1=TRUE)
area3b <- modGBarea(GBpopdat=GBpopdat, landarea="FOREST", 
  rowvar="FORTYPCD", colvar="OWNGRPCD", row.FIAname=TRUE, col.FIAname=TRUE, 
  allin1=TRUE, sumunits=TRUE)
area3b$est


## Rows and columns; combine estimation units (sumunits=TRUE; rawdata=TRUE; returntitle=TRUE)
area3c <- modGBarea(GBpopdat=GBpopdat, landarea="FOREST", 
  rowvar="FORTYPCD", colvar="STDSZCD", row.FIAname=TRUE, col.FIAname=TRUE, 
  sumunits=TRUE, rawdata=TRUE, returntitle=TRUE)
names(area3c)
area3c$est
area3c$pse

## Get list of raw data from area3c list components and look at names
raw.rowcol <- area3c$raw
names(raw.rowcol)

head(raw.rowcol$unit.grpest)
head(raw.rowcol$grpest)

## Get list of titles from area3c list components
area3c$titlelst

## No strata
## Rows and columns; combine estimation units (sumunits=TRUE); no strata (strata=FALSE)
## Note: the population data includes stratification...  must recalculate population data 
## for no strata (using GBpopdat() or through modGBarea.
area4 <- modGBarea(cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", strata=FALSE, 
  unitvar="ESTN_UNIT", unitarea=WYunitarea, landarea="FOREST", 
  rowvar="FORTYPCD", colvar="STDSZCD", row.FIAname=TRUE, col.FIAname=TRUE, 
  sumunits=TRUE, rawdata=TRUE)
area4$est
area4$pse

raw.nostrat <- area4$raw
names(raw.nostrat)

raw.nostrat$rowest


## By estimation unit
## Area of forest land and % sampling error by forest type and stand-size class
##    and Estimation Unit, Wyoming, 2011-2013
##################################################################################

## Rows and columns; by estimation unit (sumunits=FALSE); no strata (strata=FALSE)
area5a <- modGBarea(cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", strata=FALSE,
  unitvar="ESTN_UNIT", unitarea=WYunitarea, landarea="FOREST", 
  rowvar="FORTYPCD", colvar="STDSZCD", row.FIAname=TRUE, col.FIAname=TRUE,
  sumunits=TRUE)
area5a$est
area5a$pse

## Rows and columns; 1 estimation unit; get raw data and savedata and title info
area5b <- modGBarea(cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", unitvar=NULL, 
  unitarea=sum(WYunitarea$ACRES), stratalut=WYstratalut, landarea="FOREST", 
  rowvar="FORTYPCD", colvar="STDSZCD", row.FIAname=TRUE, col.FIAname=TRUE, 
  rawdata=TRUE, savedata=TRUE, returntitle=TRUE, outfolder=outfolder)
names(area5b)
area5b$est
area5b$pse
area5b$titlelst
area5b.raw <- area5b$raw
names(area5b.raw)


```

<a name="modGBtree"></a>

#### modGBtree
```
######################################################################################
# Usage:
# modGBtree(GBpopdat = NULL, estseed = "none", landarea="FOREST", pfilter = NULL,  
#   cfilter = NULL, estvar = NULL, estvar.filter = NULL, rowvar = NULL, colvar = NULL,  
#   row.FIAname = FALSE, col.FIAname = FALSE, row.orderby = NULL, col.orderby = NULL,     
#   row.add0 = FALSE, col.add0 = FALSE, rowlut = NULL, collut = NULL,   
#   rowgrp = FALSE, rowgrpnm = NULL, rowgrpord = NULL, sumunits = FALSE,    
#   allin1 = FALSE, estround = 0, pseround = 2, estnull = 0, psenull = "--",     
#   divideby = NULL, savedata = FALSE, rawdata = FALSE, rawonly = FALSE, 
#   outfolder = NULL, outfn.pre = NULL, outfn.date = TRUE, overwrite = TRUE, 
#   addtitle = TRUE, returntitle = FALSE, title.main = NULL, title.ref = NULL,  
#   title.rowvar = NULL, title.colvar = NULL, title.unitvar = NULL,
#   title.estvar = NULL, title.filter = NULL, gui = FALSE, ...)
# 
# Description:
#	Generates tree estimates by domain and/or tree domain (and estimation unit). 
#	Calculations are based on Scott et al. 2005 ('the green-book') for mapped forest 
#	inventory plots. The non-ratio estimator for estimating tree attributes
#	by stratum and domain is used. Plots that are totally nonsampled are excluded from 
#	estimation dataset. Next, an adjustment factor is calculated by strata to adjust for 
#	nonsampled (nonresponse) conditions that have proportion less than 1. Attributes 
#	adjusted to a per-acre value are summed by plot, divided by the adjustment factor, 
#	and averaged by stratum. Strata means are combined using the strata weights and then 
#	expanded to using the total land area in the population. 
######################################################################################

help(modGBtree)


## Reference table for tree estimates
ref_estvar


## Total net volume of live trees (at least 5 inches), Wyoming, 2011-2013
######################################################################################
tree1 <- modGBtree(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  unitvar="ESTN_UNIT", unitarea=WYunitarea, stratalut=WYstratalut, landarea="FOREST", 
  estvar="VOLCFNET", estvar.filter="STATUSCD == 1", sumunits=TRUE, rawdata=TRUE, 
  returntitle=TRUE)

## Get names of list components
names(tree1)

## Look at estimate table from tree1 list
tree1$est

## Get list of raw data from tree1 list components and look at names
raw.tot <- tree1$raw
names(raw.tot)
raw.tot$unit.totest	# Raw data for total estimates by estimation unit
raw.tot$totest		  # Raw data for total estimates by estimation unit summed to one estimate

## Look at population data
GBpopdat <- tree1$GBpopdat
names(GBpopdat)
GBpopdat$plotsampcnt	# Number of plots after plot filter
GBpopdat$condsampcnt	# Number of conditions after plot filter, before cond filters
GBpopdat$stratalut    # Strata information and adjustment factors

## Look at titles
tree1$titlelst


## Add table rows:
## Net volume of live trees (at least 5 inches) by forest type, Wyoming, 2011-2013
######################################################################################

## Rows only; combine estimation units (sumunits=TRUE)
tree2a <- modGBtree(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  unitvar="ESTN_UNIT", unitarea=WYunitarea, stratalut=WYstratalut, landarea="FOREST", 
  estvar="VOLCFNET", estvar.filter="STATUSCD == 1", rowvar="FORTYPCD", row.FIAname=TRUE, 
  sumunits=TRUE, savedata=TRUE, returntitle=TRUE, outfolder="outfolder")
tree2a$est

## Rows only; combine estimation units (sumunits=TRUE; allin1=TRUE)
tree2b <- modGBtree(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  unitvar="ESTN_UNIT", unitarea=WYunitarea, stratalut=WYstratalut, landarea="FOREST", 
  estvar="VOLCFNET", estvar.filter="STATUSCD == 1", rowvar="FORTYPCD", row.FIAname=TRUE, 
  sumunits=TRUE, allin1=TRUE)
tree2b$est


## Add row and columns to table
## Net volume of live trees (at least 5 inches) by forest type and stand-size class, 
##    Wyoming, 2011-2013
######################################################################################

## Rows and columns; combine estimation units (sumunits=TRUE)
tree3a <- modGBtree(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  strata=TRUE, unitvar="ESTN_UNIT", unitarea=WYunitarea, stratalut=WYstratalut, landarea="FOREST",
  estvar="VOLCFNET", estvar.filter="STATUSCD == 1", rowvar="FORTYPCD", colvar="STDSZCD",  
  row.FIAname=TRUE, col.FIAname=TRUE, sumunits=TRUE)
tree3a$est
tree3a$pse

## Try adding GBpopdat
tree3aa <- modGBtree(GBpopdat=GBpopdat, landarea="FOREST", 
  estvar="VOLCFNET", estvar.filter="STATUSCD == 1",
  rowvar="FORTYPCD", colvar="STDSZCD", row.FIAname=TRUE, col.FIAname=TRUE, sumunits=TRUE)
tree3aa$est
tree3aa$pse


## Rows and columns; combine estimation units (sumunits=TRUE; allin1=TRUE)
tree3b <- modGBtree(GBpopdat=GBpopdat, landarea="FOREST", 
  estvar="VOLCFNET", estvar.filter="STATUSCD == 1", 
  rowvar="FORTYPCD", colvar="OWNGRPCD", row.FIAname=TRUE, col.FIAname=TRUE, 
  sumunits=TRUE, allin1=TRUE)
tree3b$est

## Rows and columns; combine estimation units (sumunits=TRUE; rawdata=TRUE; returntitle=TRUE)
tree3c <- modGBtree(GBpopdat=GBpopdat, landarea="FOREST", 
  estvar="VOLCFNET", estvar.filter="STATUSCD == 1", 
  rowvar="FORTYPCD",colvar="STDSZCD", row.FIAname=TRUE, col.FIAname=TRUE, 
  sumunits=TRUE, rawdata=TRUE, returntitle=TRUE)
names(tree3c)
tree3c$est
tree3c$pse

## Get list of raw data from area3c list components and look at names
raw.rowcol <- tree3c$raw
names(raw.rowcol)

head(raw.rowcol$unit.grpest)
head(raw.rowcol$grpest)

## Get list of titles from area3c list components
tree3c$titlelst


## No strata
## Rows and columns; combine estimation units (sumunits=TRUE); no strata (strata=FALSE)
## Note: the population data includes stratification...  must recalculate population data 
## for no strata (using GBpopdat() or through modGBarea.
tree4 <- modGBtree(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  strata=FALSE, unitvar="ESTN_UNIT", unitarea=WYunitarea, landarea="FOREST", 
  estvar="VOLCFNET", estvar.filter="STATUSCD ==1 ", rowvar="FORTYPCD", colvar="STDSZCD", 
  row.FIAname=TRUE, col.FIAname=TRUE, sumunits=TRUE, rawdata=TRUE)
tree4$est
tree4$pse

raw.nostrat <- tree4$raw
names(raw.nostrat)


## By estimation unit
## Net volume of live trees (at least 5 inches) by forest type and stand-size class
##    and Estimation Unit, Wyoming, 2011-2013
#######################################################################################

## Rows and columns; by estimation unit (sumunits=FALSE); no strata (strata=FALSE)
tree5a <- modGBtree(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN",
  strata=FALSE, unitvar="ESTN_UNIT", unitarea=WYunitarea, landarea="FOREST", 
  estvar="VOLCFNET", estvar.filter="STATUSCD == 1", rowvar="FORTYPCD", colvar="STDSZCD", 
  row.FIAname=TRUE, col.FIAname=TRUE, sumunits=FALSE)
tree5a$est
tree5a$pse

## Rows and columns; 1 estimation unit; get raw data and savedata and title info
tree5b <- modGBtree(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN",  
  unitvar=NULL, unitarea=sum(WYunitarea$ACRES), stratalut=WYstratalut, landarea="FOREST", 
  estvar="VOLCFNET", estvar.filter="STATUSCD == 1", rowvar="FORTYPCD", colvar="STDSZCD", 	
  row.FIAname=TRUE, col.FIAname=TRUE, rawdata=TRUE, savedata=TRUE, returntitle=TRUE, 
  outfolder=outfolder)
names(tree5b)
tree5b$est
tree5b$ps
tree5b$titlelst
tree5b.raw <- tree5b$raw
names(tree5b.raw)

## Add species for rows
## Net volume of live trees (at least 5 inches) by species; by estimation units (allin1=TRUE)
tree6 <- modGBtree(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  unitvar="ESTN_UNIT", unitarea=WYunitarea, stratalut=WYstratalut, landarea="FOREST", 
  estvar="TPA_UNADJ", estvar.filter="STATUSCD==1", sumunits=TRUE, rowvar="SPCD", row.FIAname=TRUE)
tree6

## Add species for columns
## Net volume of live trees (at least 5 inches) by forest type and species
## State-level population with combined estimation unit (sumunits=TRUE)
## Including stratification for by estimation unit (strata=TRUE)
## Get raw data and title info and save data to outfolder
tree7 <- modGBtree(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  unitvar="ESTN_UNIT", unitarea=WYunitarea, stratalut=WYstratalut, landarea="FOREST", 
  estvar="VOLCFNET", estvar.filter="STATUSCD==1", rowvar="FORTYPCD", colvar="SPCD", 
  row.FIAname=TRUE, col.FIAname=TRUE, sumunits=TRUE, rawdata=TRUE, returntitle=TRUE)
names(tree7)
tree7$est


## Add diameter classes
## Net volume of live trees (at least 5 inches) by species and diameter class
dat <- datLUTclass(x=WYtree, xvar="DIA", LUT=ref_diacl2in, LUTclassnm="DIACL2IN")
WYtree <- dat$xLUT
LUT <- dat$LUT

tree8 <- modGBtree(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  unitvar="ESTN_UNIT", unitarea=WYunitarea, stratalut=WYstratalut, landarea="FOREST", 
  estvar="TPA_UNADJ", estvar.filter="STATUSCD==1", rowvar="SPCD", colvar="DIACL2IN", 
  row.FIAname=TRUE, sumunits=TRUE, rawdata=TRUE)
names(tree8)
tree8$est
tree8$pse
raw8 <- tree8$raw
names(raw8)
head(raw8$grpest)



## Another way to add diameter classes
## First, create a new variable using cut function
WYtree$DIA2 <- cut(WYtree$DIA, c(5, 20, 100))

tree9 <- modGBtree(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  unitvar="ESTN_UNIT", unitarea=WYunitarea, stratalut=WYstratalut, landarea="FOREST", 
  estvar="TPA_UNADJ", estvar.filter="STATUSCD==1", rowvar="DIA2", sumunits=TRUE, 
  rawdata=TRUE)
names(tree9)
tree9$est
raw9 <- tree9$raw
names(raw9)
head(raw9$rowest)



## Add row and columns to table
## Net volume of dead trees (at least 5 inches) by species and cause of death, 
##    Wyoming, 2011-2013
######################################################################################

## Rows and columns; combine estimation units (sumunits=TRUE)
tree10 <- modGBtree(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  unitvar="ESTN_UNIT", unitarea=WYunitarea, stratalut=WYstratalut, landarea="FOREST", 
  estvar="VOLCFNET", estvar.filter="STATUSCD==2", rowvar="SPCD", row.FIAname=TRUE, 
  colvar="AGENTCD", col.FIAname=TRUE, sumunits=TRUE, rawdata=TRUE)
names(tree10)
tree10$est
raw10 <- tree10$raw
names(raw10)
head(raw10$rowest)


## Get population data for Wyoming area of interest using post-stratification - add seedlings
#############################################################################################
GBpopdat2 <- modGBpop(cond=WYcond, tree=WYtree, seed=WYseed, pltassgn=WYpltassgn, pltassgnid="CN", 
    unitarea=WYunitarea, unitvar="ESTN_UNIT", strata=TRUE, stratalut=WYstratalut)
names(GBpopdat)


## Now, use GBpopdat with a new diameter class
######################################################################################

# Use datLUTclass to define class breaks
treedia.brks <- c(1,10,20,30,40,999)
GBpopdat$treex <- datLUTclass(x=GBpopdat2$treex, xvar="DIA", cutbreaks=treedia.brks)$xLUT
head(GBpopdat$treex)
table(GBpopdat$treex$DIACL)

# Get number of live trees by species and diameter class
tree11 <- modGBtree(GBpopdat=GBpopdat2, landarea="FOREST", 
  estvar="TPA_UNADJ", estvar.filter="STATUSCD==1", rowvar="SPCD", row.FIAname=TRUE, 
  colvar="DIACL", sumunits=TRUE, rawdata=TRUE)
names(tree11)
tree11$est


# Get number of live trees by species and diameter class, and add seedlings
tree11b <- modGBtree(GBpopdat=GBpopdat2, estseed="add", landarea="FOREST", 
  estvar="TPA_UNADJ", estvar.filter="STATUSCD==1", rowvar="SPCD", row.FIAname=TRUE, 
  colvar="DIACL", sumunits=TRUE, rawdata=TRUE)
names(tree11b)
tree11b$est



```

<a name="modGBratio"></a>

#### modGBratio
```
####################################################################################
# Usage:
# modGBratio(GBpopdat = NULL, estseed = "none", ratiotype = "PERACRE", landarea="FOREST",  
#   pfilter = NULL, cfilter = NULL, estvarn = NULL, estvarn.filter = NULL, 
#   estvard = NULL, estvard.filter = NULL, rowvar = NULL, colvar = NULL,  
#   row.FIAname = FALSE, col.FIAname = FALSE, row.orderby = NULL, col.orderby = NULL,   
#   row.add0 = FALSE, col.add0 = FALSE, rowlut = NULL, collut = NULL, 
#   rowgrp = FALSE, rowgrpnm = NULL, rowgrpord = NULL, sumunits = FALSE,  
#   allin1 = FALSE, estround = 3, pseround = 2, estnull = 0, psenull = "--",   
#   divideby = NULL, savedata = FALSE, rawdata = FALSE, rawonly = FALSE,  
#   outfolder = NULL, outfn.pre = NULL, outfn.date = TRUE, overwrite = TRUE, 
#   addtitle = TRUE, returntitle = FALSE, title.main = NULL, title.ref = NULL, 
#   title.rowvar = NULL, title.colvar = NULL, title.unitvar = NULL,
#   title.estvarn = NULL, title.estvard = NULL, title.filter = NULL, gui = FALSE, ...)
# 
# Description:
#	Generates per-acre and per-tree estimates by domain and/or tree domain (and 
# estimation unit). Calculations are based on chapter 4 of Scott et al. 2005 
# ('the green-book') for mapped forest inventory plots. The ratio estimator for 
# estimating per-acre or per-tree by stratum and domain is used, referred to as 
# Ratio of Means (ROM).  
####################################################################################

help(modGBratio)


## Total net volume per acre of live trees (at least 5 inches), Wyoming, 2011-2013
####################################################################################
rat1 <- modGBratio(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  unitvar="ESTN_UNIT", unitarea=WYunitarea, stratalut=WYstratalut, landarea="FOREST", 
  estvarn="VOLCFNET", estvarn.filter="STATUSCD == 1", sumunits=TRUE, rawdata=TRUE, 
  returntitle=TRUE)

## Get names of list components
names(rat1)

## Look at estimate table from rat1 list
rat1$est

## Get list of raw data from tree1 list components and look at names
raw.tot <- rat1$raw
names(raw.tot)
raw.tot$unit.totest	# Raw data for total estimates by estimation unit
raw.tot$totest		  # Raw data for total estimates by estimation unit summed to one estimate

## Look at population data
GBpopdat <- rat1$GBpopdat
names(GBpopdat)
GBpopdat$plotsampcnt	# Number of plots after plot filter
GBpopdat$condsampcnt	# Number of conditions after plot filter, before cond filters
GBpopdat$stratalut    # Strata information and adjustment factors

## Look at titles
rat1$titlelst



## Add table rows:
## Net volume per acre of live trees (at least 5 inches) by forest type, Wyoming, 2011-2013
####################################################################################

## Rows only; combine estimation units (sumunits=TRUE)
rat2a <- modGBratio(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  unitvar="ESTN_UNIT", unitarea=WYunitarea, stratalut=WYstratalut, landarea="FOREST", 
  estvarn="VOLCFNET", estvarn.filter="STATUSCD == 1", rowvar="FORTYPCD", row.FIAname=TRUE, 
  sumunits=TRUE, savedata=TRUE, returntitle=TRUE, outfolder="outfolder")
rat2a$est


## Rows only; combine estimation units (sumunits=TRUE; allin1=TRUE)
rat2b <- modGBratio(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  unitvar="ESTN_UNIT", unitarea=WYunitarea, stratalut=WYstratalut, landarea="FOREST", 
  estvarn="VOLCFNET", estvarn.filter="STATUSCD == 1", rowvar="FORTYPCD", row.FIAname=TRUE, 
  sumunits=TRUE, allin1=TRUE)
rat2b$est


## Add table rows and columns:
## Net volume per acre of live trees (at least 5 inches) by forest type and stand size class, 
##    Wyoming, 2011-2013
rat3 <- modGBratio(tree=WYtree, cond=WYcond, pltassgn=WYpltassgn, pltassgnid="CN", 
  unitvar="ESTN_UNIT", unitarea=WYunitarea, stratalut=WYstratalut, landarea="FOREST", 
  estvarn="VOLCFNET", estvarn.filter="STATUSCD==1", rowvar="FORTYPCD", colvar="STDSZCD", 
  row.FIAname=TRUE, col.FIAname=TRUE, sumunits=TRUE, rawdata=TRUE, returntitle=TRUE)
rat3$est

names(rat3)
rat3$est
rat3$pse
names(rat3$raw)
head(rat3$raw$unit.grpest)
head(rat3$raw$grpest)
rat3$titlelst


## Try adding GBpopdat
rat3aa <- modGBratio(GBpopdat=GBpopdat, landarea="FOREST", 
  estvarn="VOLCFNET", estvarn.filter="STATUSCD==1", 
  rowvar="FORTYPCD", colvar="STDSZCD", row.FIAname=TRUE, col.FIAname=TRUE, 
  sumunits=TRUE, rawdata=TRUE, returntitle=TRUE)
rat3aa$est
rat3aa$pse


## Rows only - Species per acre; combine estimation units (sumunits=TRUE)
rat4 <- modGBratio(GBpopdat=GBpopdat, landarea="FOREST", 
  estvarn="VOLCFNET", estvarn.filter="STATUSCD==1", 
  rowvar="FORTYPCD", row.FIAname=TRUE, 
  sumunits=TRUE)
rat4$est

## Rows only - Species per acre; by estimation units (allin1=TRUE)
rat5 <- modGBratio(GBpopdat=GBpopdat, landarea="FOREST", 
  estvarn="VOLCFNET", estvarn.filter="STATUSCD==1", 
  rowvar="FORTYPCD", colvar="SPCD", row.FIAname=TRUE, col.FIAname=TRUE, 
  sumunits=TRUE)
rat5$est


## Add diameter classes
## Net volume per acre of live trees (at least 5 inches) by species and diameter class
dat <- datLUTclass(x=WYtree, xvar="DIA", LUT=ref_diacl2in, LUTclassnm="DIACL2IN")
WYtree <- dat$xLUT
LUT <- dat$LUT

rat6 <- modGBratio(GBpopdat=GBpopdat, landarea="FOREST", 
  estvarn="TPA_UNADJ", estvarn.filter="STATUSCD==1", 
  rowvar="SPCD", colvar="DIACL2IN", row.FIAname=TRUE, 
  sumunits=TRUE, rawdata=TRUE)
rat6$est

names(rat6)
rat6$est
rat6$pse
raw6 <- rat6$raw
names(raw6)
raw6$grpest


## Tree ratio
## Rows only; combine estimation units (sumunits=TRUE; allin1=TRUE)
rat7 <- modGBratio(GBpopdat=GBpopdat, landarea="FOREST", 
  estvarn="VOLCFNET", estvarn.filter="STATUSCD == 1", estvard="VOLCFNET", 
  rowvar="FORTYPCD", row.FIAname=TRUE, 
  sumunits=TRUE, allin1=TRUE)
rat7$est


rat7b <- modGBratio(GBpopdat=GBpopdat, ratiotype="PERTREE", landarea="FOREST", 
  estvarn="VOLCFNET", estvarn.filter="STATUSCD == 1", estvard="VOLCFNET", 
  rowvar="FORTYPCD", row.FIAname=TRUE,  
  sumunits=TRUE, allin1=TRUE)
rat7b$est

head(rat7$est)
head(rat7b$est)


```

## References

Bechtold, William A.; Patterson, Paul L., Editors. 2005. The enhanced Forest Inventory and Analysis program national sampling design and estimation procedures. Gen. Tech. Rep. SRS-80. Asheville, NC: U.S. Department of Agriculture, Forest Service, Southern Research Station. 85 p.

Patterson, Paul L. 2012. Photo-based estimators for the Nevada photo-based inventory. Res. Pap. RMRS-RP-92. Fort Collins, CO: U.S. Department of Agriculture, Forest Service, Rocky Mountain Research Station. 14 p.

Westfall, James A.; Patterson, Paul L.; Coulston, John W. 2011. Post-stratified estimation: with-in strata and total sample size recommendations. Canadian Journal of Forest Research. 41: 1130-1139.

