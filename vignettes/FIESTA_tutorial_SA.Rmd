---
title: "FIESTA - Small Area Estimators"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{FIESTA - Small Area Estimators}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

### Small Area (SA) module overview

`FIESTA`'s Small Area (SA) module was set up as a platform to integrate with current Small Area Estimators available on CRAN including the `JoSAE` (Breidenbach 2015), `sae` (Molina and Marhuenda 2015), and `hbsae` (Boonstra 2012) packages that use unit-level and area-level models such as the Empirical Best Linear Unbiased Prediction (EBLUP) estimation strategy and the hierarchical Bayesian estimation strategy. Rao (2003) discusses the benefits of the EBLUP for balancing potential bias of synthetic estimators against the instability of a direct estimator. White et al (2021) discusses the benefits of Small Area Estimation in a hierarchical Bayesian context, especially for forestry data. The module includes functional steps for checking, compiling, and formatting FIA plot data and ancillary spatial information for input to R packages, such as `JoSAE` (Breidenbach 2015), `sae` (Molina and Marhuenda 2015), or `hbsae` (Boonstra 2012) and translates integrated package output to `FIESTA` output format. 

Functions in `FIESTA` used for fitting Small Area Estimators include the `modMAarea` function for area estimates and `modMAtree` for tree estimates. The `modMApop` function is used to get population data needed for model-assisted estimation. Below is a description and table of contents for the sections related to these functions:

<!-- FUNCTION  | DESCRIPTION -->
<!-- -------------- | --------------------------------------------------------------- -->
<!-- [modMApop](#modMApop) | Creates population data for model-assisted estimation. -->
<!-- [modMAarea](#modMAarea) | Produces area level estimates through model-assisted estimation. -->
<!-- [modMAtree](#modMAtree) | Produces tree level estimates through model-assisted estimation. -->

### Objective of tutorial

The main objective of this tutorial is to demonstrate how to use FIESTA for generating estimates using estimators from JoSAE and sae. The following examples are for generating estimates and estimated variances using standard FIA Evaluation data from FIA's National database, with custom Estimation unit and Stratification information. The examples use data from three inventory years of field measurements in the state of Wyoming, from FIADB_1.7.2.00, last updated June 20, 2018, downloaded on June 25, 2018 and stored as internal data objects in FIESTA.

<!-- The main objective of this tutorial is to demonstrate how to use `FIESTA` for generating estimates using estimators from `mase`. The model-assisted estimators can be used with FIA's standard state-level population data (i.e, Evaluation) from the FIA database (FIADB) and also population data from a custom boundary.  -->

<!-- The following examples are for generating estimates and estimated variances using standard FIA Evaluation data from FIA's National database, with custom Estimation unit and Stratification information. The examples use data from three inventory years of field measurements in the state of Wyoming, from FIADB_1.7.2.00, last updated June 20, 2018, downloaded on June 25, 2018 and stored as internal data objects in `FIESTA`. -->


## Example data - Wyoming (WY), Inventory Years 2011-2012

Data Frame | Description
-----------| --------------------------------------------------------------------------------
WYplt      | WY plot-level data
WYcond     | WY condition-level data
WYtree     | WY tree-level data

External data            | Description
-------------------------| ------------------------------------------------------------------
WYbighorn_adminbnd.shp   | Polygon shapefile of WY Bighorn National Forest Administrative boundary*
WYbighorn_districtbnd.shp| Polygon shapefile of WY Bighorn National Forest District boundaries**
WYbighorn_forest_nonforest_250m.tif| GeoTIFF raster of predicted forest/nonforest (1/0) for stratification*** 
WYbighorn_dem_250m.img   | Erdas Imagine raster of elevation change, in meters****

*USDA Forest Service, Automated Lands Program (ALP). 2018. S_USA.AdministrativeForest (\url{http://data.fs.usda.gov/geodata/edw}). Description: An area encompassing all the National Forest System lands administered by an administrative unit. The area encompasses private lands, other governmental agency lands, and may contain National Forest System lands within the proclaimed boundaries of another administrative unit. All National Forest System lands fall within one and only one Administrative Forest Area.

**USDA Forest Service, Automated Lands Program (ALP). 2018. S_USA.RangerDistrict (http://data.fs.usda.gov/geodata/edw). Description: A depiction of the boundary that encompasses a Ranger District.

***Based on MODIS-based classified map resampled from 250m to 500m resolution and reclassified from 3 to 2 classes: 1:forest; 2:nonforest. Projected in Albers Conical Equal Area, Datum NAD27 (Ruefenacht et al. 2008). Clipped to extent of WYbighorn_adminbnd.shp.

****USGS National Elevation Dataset (NED), resampled from 30m resolution to 250m. Projected in Albers Conical Equal Area, Datum NAD27 (U.S. Geological Survey 2017). Clipped to boundary of WYbighorn_adminbnd.shp.



FUNCTION  | DESCRIPTION
-------------- | ---------------------------------------------------------------
[spGetSAdoms()](#spGetSAdoms) | Gets small area domains for estimation.
[spGetPlots()](#spGetPlots)| Gets data from FIA database for plots within a given boundary.
[spGetModeldat()](#spGetModeldat)| Gets plot and spatial data for small area models.
[modSAtree()](#modSAtree)| Generate tree estimates using Small Area Estimation (SAE) methods.


### EXAMPLES

Set up for examples
```{r}
# Load library
library(FIESTA)

outfolder <- tempdir()

# File names for external spatial data
FIAplotsfn <- system.file("extdata", "FIApublic_M331B.db", package="FIESTA")
FIAplotsfn <- "C:/_tsf/_GitHub/FIESTA/inst/extdata/FIA_data/FIApublic_M331B.db"

WYbhfn <- system.file("extdata", "sp_data/WYbighorn_adminbnd.shp", package="FIESTA")
WYbhdistfn <- system.file("extdata", "sp_data/WYbighorn_districtbnd.shp", package="FIESTA")
WYbhdist.att <- "DISTRICTNA"

fornffn <- system.file("extdata", "sp_data/WYbighorn_forest_nonforest_250m.tif", package="FIESTA")
demfn <- system.file("extdata", "sp_data/WYbighorn_dem_250m.img", package="FIESTA")

# # Derive new layers from dem
# aspfn <- file.path(outfolder, "WYbh_asp.img")
# gdalUtils::gdaldem("aspect", input_dem=demfn, output=aspfn, of="GTiff")
# 
# slpfn <- file.path(outfolder, "WYbh_slp.img")
# gdalUtils::gdaldem("slope", input_dem=demfn, output=slpfn, of="GTiff")


# Derive new predictor layers from dem
library(raster)
dem <- raster(demfn)
slp <- terrain(dem,
               opt = "slope",
               unit = "degrees",
               filename = paste0(outfolder, "/WYbh_slp.img"), 
               overwrite = TRUE)
asp <- terrain(dem,
               opt = "aspect",
               unit = "degrees", 
               filename = paste0(outfolder, "/WYbh_asp.img"),
               overwrite = TRUE)
```

<a name="ref"></a>

## Reference Tables in FIESTA

There are several reference tables stored in FIESTA, including table variable descriptions, code definitions, and estimation categories. 

* Table variable descriptions - ref_plt, ref_cond, ref_tree
* Code definitions - ref_codes


<a name="auxiliary"></a>


#### <a name="spGetSAdoms"/>spGetSAdoms()
```{r}
######################################################################################
# Usage:
# spGetSAdoms(smallbnd, smallbnd_dsn = NULL, smallbnd.unique = NULL,  
#	  smallbnd.att = NULL, smallbnd.filter = NULL, smallbnd.stfilter = NULL,
#   smallbnd.ecofilter = NULL, helperbnd = NULL, helperbnd_dsn = NULL, 
#	  helperbnd.unique = NULL, helperbnd.filter = NULL, largebnd = NULL, 
#	  largebnd_dsn = NULL, largebnd.unique = NULL, largebnd.filter = NULL, 
#   maxbnd = NULL, maxbnd_dsn = NULL, maxbnd.unique = NULL, maxbnd.filter = NULL,
#   helper_autoselect = FALSE, nbrdom_min = NULL, threshold=30, 
#	  multiSAdoms = TRUE, showsteps = TRUE, savedata = FALSE, savesteps = FALSE, 
# 	outfolder = NULL, out_fmt = "shp", out_dsn = NULL, outfn.pre = NULL,  
# 	outfn.date = FALSE, overwrite_dsn = FALSE, overwrite_layer = TRUE)
# 
# Description:
# Get spatial domains for small area estimation.
######################################################################################
# 
# WYbhdist <- spImportSpatial(WYbhdistfn)
# head(WYbhdist)
# 
# ## Get spatial domains for small area estimation
# SAdomdat <- spGetSAdoms(
#   smallbnd = WYbhdistfn,
#   smallbnd.domain = "DISTRICTNA",
#   helperbnd = FIESTAnalysis::ecomap,
#   helperbnd.unique = "SUBSECTION",
#   largebnd = FIESTAnalysis::ecomap,
#   largebnd.unique = "SECTION"
# )
# SAdoms <- SAdomdat$SAdomlst[[1]]
# 
# plot(st_geometry(SAdomdat$SAdomlst[[1]]))


smallbnd <- WYbhdistfn
smallbnd.domain <- "DISTRICTNA"

```

#### <a name="spGetPlots"/>spGetPlots()
```{r}
######################################################################################
# Usage:
# spGetPlots(bnd, bnd_dsn = NULL, bnd.filter = NULL, states = NULL, stbnd = NULL, 
#	  stbnd_dsn = NULL, stbnd.att = NULL, RS = NULL, xy = NULL, xy_dsn = NULL, 
#   xy.uniqueid = "PLT_CN", xvar = "LON_PUBLIC", yvar = "LAT_PUBLIC", xy.crs = 4269, 
#	  clipxy = TRUE, datsource = "datamart", data_dsn = NULL, istree = TRUE, 
#	  isseed = FALSE, plot_layer= "plot", cond_layer = "cond", tree_layer = "tree", 
#   seed_layer = "seed", other_layers = NULL, puniqueid = "CN", evalid = NULL, 
#   evalCur = FALSE, evalEndyr = NULL, evalType = "VOL", measCur = FALSE, 
#   measEndyr = NULL, measEndyr.filter = NULL, invyrs = NULL, allyrs=FALSE,
#	  intensity1 = FALSE, showsteps = FALSE, savedata = FALSE, savebnd = FALSE, 
#	  savexy = FALSE, outfolder = NULL, out_fmt = "shp", out_dsn = NULL, outfn.pre = NULL, 
#	  outfn.date = FALSE, overwrite_dsn = FALSE, overwrite_layer = FALSE, ...)
# 
# Description:
# Extract data from FIA database for plots within a given boundary.
######################################################################################


## Extracting data through FIA's DataMart (https://apps.fs.usda.gov/fia/datamart/datamart.html).
## Here, data are downloaded for all states intersecting boundary, then subset to boundary

# SApltdat <- spGetPlots(bnd = WYbhdistfn,
#                      datsource = "datamart",
#                      istree = TRUE,
#                      isseed = TRUE,
#                      invyrs = 2011:2013,
#                      showsteps = TRUE)
 
SApltdat <- spGetPlots(bnd = WYbhdistfn,
                     xy_datsource = "obj",
                     xy = WYplt,
                     xy.uniqueid = "CN",
                     xvar = "LON_PUBLIC",
                     yvar = "LAT_PUBLIC",
                     xy.crs = 4269, 
                     datsource = "obj",
                     istree = TRUE,
                     isseed = TRUE,
                     plot_layer = WYplt,
                     cond_layer = WYcond,
                     tree_layer = WYtree,
                     seed_layer = WYseed,
                     invyrs = 2011:2013,
                     showsteps = TRUE,
                     savexy=TRUE,
                     savedata_opts = savedata_options(outfolder = outfolder))
```


#### <a name="spGetAuxiliary"/>spGetAuxiliary()
```{r}

## Extract from raster predictor layers
#######################################################
rastlst.cont <- c(dem, slp, asp)
rastlst.cont.name <- c("dem", "slp", "asp")

#unit_layer = SAdoms,
#unitvar = "DOMAIN", 

unit_layer <- WYbhdistfn
unitvar = "DISTRICTNA"

auxdat <- spGetAuxiliary(xyplt = SApltdat$spxy, 
                         uniqueid = "CN", 
                         unit_layer = unit_layer,
                         unitvar = "DISTRICTNA", 
                         rastlst.cont = rastlst.cont, 
                         rastlst.cont.name = rastlst.cont.name, 
                         rastlst.cont.stat = "mean", 
                         rastlst.cont.NODATA = 0, 
                         asptransform = TRUE, 
                         rast.asp = asp, 
                         keepNA = FALSE, 
                         showext = FALSE, 
                         savedata = FALSE)
names(auxdat)



```



#### <a name="modSApop"/>modSApop()
```{r}

SApopdat <- modSApop(pltdat=SApltdat, auxdat=auxdat, smallbnd=WYbhdistfn,
		smallbnd.domain=smallbnd.domain)
names(SApopdat)



```

#### <a name="modSAtree"/>modSAtree()
```{r}
######################################################################################
# Usage:
# modSAtree(SAdomsdf = NULL, prednames = NULL, SApackage = "JoSAE", SAmethod = "unit",   
#	  estseed = "none", largebnd.att = NULL, landarea = "ALL", 
#   pfilter = NULL, cfilter = NULL, estvar = NULL, estvar.filter = NULL,  
#   allin1 = FALSE, estround = 0, pseround = 3, estnull = 0, psenull = "--", 
#   divideby = NULL, savedata = FALSE, rawdata = FALSE, outfolder = NULL, 
#   outfn = NULL, outfn.pre = NULL, outfn.date = TRUE, overwrite = FALSE, 
#   addtitle = TRUE, returntitle = FALSE, title.main = NULL, title.ref = NULL,
#   title.dunitvar = NULL, title.estvar = NULL, title.filter = NULL, 
#   SApopdat = NULL, ...) 
# 
# Description:
# Generate estimates for area of interest, or small boundary.
######################################################################################

## Estimates of live basal area (sq cuft) by Bighorn National Forest district
estvar <- "BA"
estvar.filter <- "STATUSCD == 1"
adjplot=TRUE
SAmethod="area"
SApackage="JoSAE"


area1 <- modSAarea(
  SApopdatlst = SApopdat, # pop - population calculations for WY, post-stratification
  SAdomsdf = NULL,
  prednames = c("slp", "dem"),
  SApackage = "sae",
  SAmethod = "area"
  # estvar = estvar
  )

SAdat <- modSAtree(tree=SAtree, cond=SAcond, pltassgn=pltassgn,
  pltassgnid=pltassgnid, dunitarea=dunitarea, areavar=areavar, 
  dunitlut=dunitlut, prednames=prednames, predfac=predfac,
  estvar=estvar, estvar.filter=estvar.filter, rawdata=TRUE)

names(SAdat)
SAdat$est
SAdat.raw <- SAdat$raw
names(SAdat.raw)


SAdat.raw$plotsampcnt
SAdat.raw$condsampcnt

SAdat.raw$dunitlut
SAdat.raw$dunitarea
head(SAdat.raw$dat)
SAdat.raw$estvar

SAdat.raw$dunit.multest
SAdat.raw$dunit_totest


```



## References

Breidenbach J. 2018. JoSAE: Unit-Level and Area-Level Small Area Estimation.

Molina I, Marhuenda Y. 2015. sae: An R Package for Small Area Estimation. The R Journal, 7(1), 81–98. https://journal.r-project.org/archive/2015/RJ-2015-007/RJ-2015-007.pdf.

Rao, J.N.K. 2003. Small Area Estimation. Wiley, Hoboken, New Jersey.

