---
output:
  word_document:
    reference_docx: anGBtemplate.docx
params:
  SApopdatlst: ''
  AOInm: ''
  pcfilter: ''
  fortypgrpcd: ''
  title.ref: ''
  estnm: ''
  totals: ''
  domain: ''
  
---


```{r Data_Inputs, echo=FALSE, warning=FALSE, message=FALSE}
 
library(FIESTA)
library(RColorBrewer)

SApopdatlst <- params$SApopdatlst
AOInm <- params$AOInm
pcfilter <- params$pcfilter
fortypgrpcd <- params$fortypgrpcd
title.ref <- params$title.ref
estnm <- params$estnm
domain <- params$domain
totals <- params$totals


digits <- c(0,0,4,4,2,0)

# AOInm <- "ecoM332"
# load("E:/workspace/FIESTA/FIESTA_SA/testfolder4/M332/SApopdatlst.rda")
# pcfilter <- NULL
# title.ref <- NULL
# fortypgrpcd <- 200
# estnm="JFH"
# senm="JFH.se"
# domain="Incident_Name"

## Create senm
senm <- paste0(estnm, ".se")

if (is.null(title.ref)) {
  title.ref <- AOInm
}
if (is.null(domain)) {
  domain <- "DOMAIN"
}


## pcfilter
for (i in 1:length(SApopdatlst)) {
  if (!is.null(pcfilter) && 'STATECD' %in% names(SApopdat$pltcondx)) {
    pltcondf <- datFilter(SApopdat$pltcondx, xfilter=pcfilter)$xf
    states <- FIESTA::pcheck.states(unique(pltcondf$STATECD))
    invyrs <- unique(pltcondf$INVYR)
  }
}

## Get all states and inventory years in SApopdatlst 
states <- {}
invyrs <- {}
for (i in 1:length(SApopdatlst)) {
  if (!is.null(pcfilter) && 'STATECD' %in% names(SApopdatlst[[i]]$pltcondx)) {
    pltcondf <- datFilter(SApopdatlst[[i]]$pltcondx, xfilter=pcfilter)$xf
    states <- sort(c(states, FIESTA::pcheck.states(unique(pltcondf$STATECD))))
    invyrs <- sort(unique(c(invyrs, pltcondf$INVYR)))
  } else {
    states <- sort(unique(c(states, SApopdatlst[[i]]$states)))
    invyrs <- sort(unique(c(invyrs, unlist(SApopdatlst[[i]]$invyrs))))
  }
}


if (is.null(pcfilter)) {
  title.statesx=title.states <- NULL
  title.filter <- NULL
} else {
  if (length(states) < 3) {
    title.statesx <- paste(states, collapse=" and ")
    title.states <- paste0(", ", paste(states, collapse=" and "))
  } else {
    title.statesx=title.states <- NULL 
  }
  title.filter <- AOInm
}
invyrs2 <- paste0(min(invyrs), "-", max(invyrs))


```


---
title: "Forest Resource Report:  \n`r title.ref``r title.states`,  \n`r invyrs2`"
---


-----  

&nbsp;  

Rocky Mountain Research Station, Forest Inventory and Analysis  | `r format(Sys.time(), "%B %Y")`

&nbsp;  

```{r smallbnd, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7.5}

smallbnd <- {}
for (i in 1:length(SApopdatlst)) {
  smallbnd <- rbind(smallbnd, SApopdatlst[[i]]$smallbnd)
  smallbnd.unique <- SApopdatlst[[i]]$smallbnd.unique
}  
plot(sf::st_geometry(smallbnd), border="black", main="")


```
Figure 1. Small area of interest, `r title.ref``r title.states`, `r invyrs2`.

&nbsp;  


----- 


# Summary

&nbsp;  

```{r Summary_Info, echo=FALSE, include=FALSE}
 

dunitlut <- {}
dunitarea <- {}
for (i in 1:length(SApopdatlst)) {
  dunitlut <- rbind(dunitlut, SApopdatlst[[i]]$dunitlut)
  dunitarea <- rbind(dunitarea, SApopdatlst[[i]]$dunitarea)
  areavar <- SApopdatlst[[i]]$areavar
}
  
dominfo <- merge(dunitlut[, c("DOMAIN", "AOI", "n.total")], 
                  dunitarea, by="DOMAIN")
nbrdoms <- nrow(dominfo)
totarea <- sum(dominfo[dominfo$AOI == 1, areavar])

#knitr::kable(dominfo, "simple", align=c("lrr"),
#              digits=digits, format.args=list(big.mark = ","))


intro_text1 <- paste0("The total area of ", AOInm, " is ", format(round(totarea), big.mark=","), 
        " acres with ", nbrdoms, " unique small areas. The area intersects ",
        length(states), " states (", toString(states), ").") 
                      

intro_text2 <-
paste0("Estimates are calculated using the Forest Inventory ESTimation and Analysis (FIESTA) R package (Frescino et al. 2015) and are based on area-level small area estimators from the JoSAE package. Data for this report were extracted from the Forest Inventory and Analysis (FIA) database for years ", invyrs2, " (Burrill et al. 2018).")



```


`r intro_text1`

&nbsp;  

`r intro_text2`

&nbsp;   

\newpage

&nbsp;  

-----  

# EST1 - Area of forest land by `r domain`.

-----  

&nbsp;  

Table 1. Area of forest land by `r domain`, `r title.ref``r title.states`, `r invyrs2`.

&nbsp;  


```{r est1, echo=FALSE, warning=FALSE, message=FALSE}

SAareadat1 <- modSAest(SApopdatlst=SApopdatlst, SApackage="JoSAE", 
	SAmethod="area", esttype="AREA", landarea="FOREST", 
 	smallbnd.att=NULL, savedata=FALSE, rawdata=TRUE,
	returntitle=TRUE, multest=TRUE, title.ref=title.ref)
#est1 <- SAareadat1$est
multest1 <- SAareadat1$dunit_multest
titlelst1 <- SAareadat1$titlelst

multest1$pse <- multest1[[senm]] / multest1[[estnm]] * 100
est1 <- multest1[multest1$AOI == 1, c("DOMAIN", "NBRPLT.gt0", estnm, senm, "pse", "AREAUSED")]
names(est1)[names(est1) == "DOMAIN"] <- domain

if (totals) {
  est1[[estnm]] <- est1[[estnm]] * est1$AREAUSED
  est1[[senm]] <- est1[[senm]] * est1$AREAUSED
}
 

knitr::kable(est1, "simple", align=c("lrrrrr"), digits=digits,
             format.args=list(big.mark = ","))

```  


&nbsp;  


&nbsp; 


```{r EST1_Barplot, echo=FALSE, warning=FALSE, message=FALSE}

est1tot <- est1
if (totals) {
  ylab <- "Acres"
} else {
  ylab <- "Per Acre"
}

horiz <- ifelse(nrow(est1tot) > 10, TRUE, FALSE)
datBarplot(x=est1tot, xvar=domain, yvar=estnm, horiz=horiz,
           errbars=TRUE, sevar=senm, toplabelvar="NBRPLT.gt0", ylab=ylab)

```
<!-- Figure 1. Area of forest land by, `r domain`, `r AOInm`, `r title.states`, `r invyrs2`. -->


&nbsp;    


```{r est1_map, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7.5}


## Merge estimate to smallbnd
smallbnd1 <- merge(smallbnd, est1, by.x=smallbnd.unique, by.y=domain)

pal <- palette(brewer.pal(n=4, name = "Greens"))
plot(smallbnd1[estnm], key.pos=1, axes=TRUE, key.width=lcm(1.3), 
 	graticule=TRUE, key.length=1.0, breaks="equal", nbreaks=5, 
 	pal=palette(brewer.pal(n=4, name="Greens")),
 	border="black", lwd=.5, main="")

# plot(smallbnd1[estnm], key.pos=1, axes=TRUE, key.width=lcm(1.3), 
# 	graticule=TRUE, key.length=1.0, breaks="equal", nbreaks=5, 
# 	border="black", lwd=.5, main="")


```
<!-- Figure 1. Area of forest land by domain, `r title.ref``r title.states`, `r invyrs2`. -->


\newpage    

&nbsp;  


-----  

# EST2 - Net cubic-foot volume of live trees on forest land by domain.

-----  


&nbsp; 


Table 2. Net cubic-foot volume of live trees on forest land by domain, `r title.ref``r title.states`, `r invyrs2`.

&nbsp;    

```{r est2, echo=FALSE, warning=FALSE, message=FALSE}
 
SAareadat2 <- modSAest(SApopdatlst=SApopdatlst, SApackage="JoSAE", 
	SAmethod="area", esttype="TREE", landarea="FOREST", 
	estvar="VOLCFNET", estvar.filter="STATUSCD == 1", 
 	smallbnd.att=NULL, savedata=FALSE, rawdata=TRUE,
	returntitle=TRUE, multest=TRUE, title.ref=title.ref)
#est2 <- SAareadat2$est
multest2 <- SAareadat2$dunit_multest
titlelst2 <- SAareadat2$titlelst

multest2$pse <- multest2[[senm]] / multest2[[estnm]] * 100
est2 <- multest2[multest2$AOI == 1, c("DOMAIN", "NBRPLT.gt0", estnm, senm, "pse", "AREAUSED")]
names(est2)[names(est2) == "DOMAIN"] <- domain

if (totals) {
  est2[[estnm]] <- est2[[estnm]] * est2$AREAUSED
  est2[[senm]] <- est2[[senm]] * est2$AREAUSED
}

knitr::kable(est2, "simple", align=c("lrrrrr"), digits=digits,
             format.args=list(big.mark = ","))

```  


&nbsp;    


&nbsp;    


```{r EST2_Barplot, echo=FALSE, warning=FALSE, message=FALSE}

est2tot <- est2
if (totals) {
  divideby <- "million"
  ylab <- "Acres"
} else {
  divideby <- NULL
  ylab <- "Per Acre"
}

horiz <- ifelse(nrow(est1tot) > 10, TRUE, FALSE)
datBarplot(x=est2tot, xvar=domain, yvar=estnm, horiz=horiz,
           errbars=TRUE, sevar=senm, toplabelvar="NBRPLT.gt0", 
           ylab=ylab, divideby=divideby)

```


&nbsp;  


```{r est2_map, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7.5}

## Merge estimate to smallbnd
smallbnd2 <- merge(smallbnd, est2, by.x=smallbnd.unique, by.y=domain)

pal <- palette(brewer.pal(n=4, name = "Reds"))
plot(smallbnd2[estnm], key.pos=1, axes=TRUE, key.width=lcm(1.3), 
 	graticule=TRUE, key.length=1.0, breaks="equal", nbreaks=4, 
 	pal=palette(brewer.pal(n=4, name="Reds")),
 	border="black", lwd=.5, main="")


```
<!-- Figure 2. Net cubic-foot volume of live trees on forest land by domain, `r title.ref``r title.states`, `r invyrs2`. -->


\newpage 

&nbsp;  

-----  

# EST3 - Square-feet basal area of live trees on forest land by domain.

-----  

Table 3. Square-feet basal area of live trees on forest land by domain, `r AOInm``r title.states`, `r invyrs2`.

&nbsp;    

```{r est3, echo=FALSE, warning=FALSE, message=FALSE}

SAareadat3 <- modSAest(SApopdatlst=SApopdatlst, SApackage="JoSAE", 
	SAmethod="area", esttype="TREE", landarea="FOREST", 
	estvar="BA", estvar.filter="STATUSCD == 1", 
 	smallbnd.att=NULL, savedata=FALSE, rawdata=TRUE,
	returntitle=TRUE, multest=TRUE, title.ref=title.ref)
multest3 <- SAareadat3$dunit_multest
titlelst3 <- SAareadat3$titlelst

multest3$pse <- multest3[[senm]] / multest3[[estnm]] * 100
est3 <- multest3[multest3$AOI == 1, c("DOMAIN", "NBRPLT.gt0", estnm, senm, "pse", "AREAUSED")]
names(est3)[names(est3) == "DOMAIN"] <- domain

if (totals) {
  est3[[estnm]] <- est3[[estnm]] * est3$AREAUSED
  est3[[senm]] <- est3[[senm]] * est3$AREAUSED
}


knitr::kable(est3, "simple", align=c("lrrrr"), digits=digits,
             format.args=list(big.mark = ","))

```  


&nbsp;  


&nbsp;   


```{r EST3_Barplot, echo=FALSE, warning=FALSE, message=FALSE}

est3tot <- est3
if (totals) {
  divideby <- "million"
  ylab <- "Acres"
} else {
  divideby <- NULL
  ylab <- "Per acre"
}

datBarplot(x=est3tot, xvar=domain, yvar=estnm, 
           errbars=TRUE, sevar=senm, toplabelvar="NBRPLT.gt0", 
           ylab=ylab, divideby=divideby)

```


&nbsp;    


```{r est3_map, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7.5}

smallbnd3 <- merge(smallbnd, est3, by.x=smallbnd.unique, by.y=domain)

pal <- palette(brewer.pal(n=4, name = "Blues"))
plot(smallbnd3[estnm], key.pos=1, axes=TRUE, key.width=lcm(1.3), 
 	graticule=TRUE, key.length=1.0, breaks="equal", nbreaks=5, 
 	#pal=palette(brewer.pal(n=7, name="Greens")),
 	border="black", lwd=.5, main="")


```
<!-- Figure 3. Square-feet basal area of live trees on forest land by domain, `r title.ref``r title.states`, `r invyrs2`. -->


\newpage    

&nbsp;  


-----  

# EST4 - Net cubic-board foot volume of live trees on forest land by domain.

-----  

&nbsp; 

Table 4. Net board-foot volume of live trees on forest land by domain, `r title.ref``r title.states`, `r invyrs2`.

&nbsp;    

```{r est4, echo=FALSE, warning=FALSE, message=FALSE}

SAareadat4 <- modSAest(SApopdatlst=SApopdatlst, SApackage="JoSAE", 
	SAmethod="area", esttype="TREE", landarea="FOREST", 
	estvar="VOLBFNET", estvar.filter="STATUSCD == 1", 
 	smallbnd.att=NULL, savedata=FALSE, rawdata=TRUE,
	returntitle=TRUE, multest=TRUE, title.ref=title.ref)
multest4 <- SAareadat4$dunit_multest
titlelst4 <- SAareadat4$titlelst

multest4$pse <- multest4[[senm]] / multest4[[estnm]] * 100
est4 <- multest4[multest4$AOI == 1, c("DOMAIN", "NBRPLT.gt0", estnm, senm, "pse", "AREAUSED")]
names(est4)[names(est4) == "DOMAIN"] <- domain

if (totals) {
  est4[[estnm]] <- est3[[estnm]] * est3$AREAUSED
  est4[[senm]] <- est3[[senm]] * est3$AREAUSED
}

knitr::kable(est4, "simple", align=c("lrrrrr"), digits=digits,
             format.args=list(big.mark = ","))

```  


&nbsp;    


&nbsp;    


```{r EST4_Barplot, echo=FALSE, warning=FALSE, message=FALSE}

est4tot <- est4
if (totals) {
  divideby <- "million"
  ylab <- "Acres"
} else {
  divideby <- NULL
  ylab <- "Per acre"
}

datBarplot(x=est4tot, xvar=domain, yvar=estnm, 
           errbars=TRUE, sevar=senm, toplabelvar="NBRPLT.gt0", 
           ylab=ylab, divideby=divideby)

```


&nbsp;    


```{r est4_map, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7.5}

## Merge estimate to smallbnd
smallbnd4 <- merge(smallbnd, est4, by.x=smallbnd.unique, by.y=domain)

plot(smallbnd4[estnm], key.pos=1, axes=TRUE, key.width=lcm(1.3),
	graticule=TRUE, key.length=1.0, breaks="equal", nbreaks=5,
#	pal=palette(brewer.pal(n=6, name="Blues")),
	border="black", lwd=.5, main="")


```
<!-- Figure 4. Net board-foot volume of live trees on forest land by domain, `r title.ref``r title.states`, `r invyrs2`. -->


\newpage 



# References

&nbsp;  

Breidenbach, Johannes 2018. JoSAE: Unit-Level and Area-Level Small Area Estimation. R package version 0.3.0. https://CRAN.R-project.org/package=JoSAE.
  
&nbsp;

Burrill, E.A., Wilson, A.M., Turner, J.A., Pugh, S.A., Menlove, J., Christiansen, G., Conkling, B.L., Winnie, D., 2018. Forest Inventory and Analysis Database [WWW Document]. St Paul MN US Dep. Agric. For. Serv. North. Res. Stn. URL http://apps.fs.fed.us/fiadb-downloads/datamart.html (accessed 3.6.21).

&nbsp; 

Frescino, Tracey S.; Patterson, Paul L.; Moisen, Gretchen G.; Toney, Chris; Freeman, Elizabeth A. 2018. FIESTA: A Forest Inventory Estimation and Analysis R Package. USDA Forest Service, Rocky Mountain Research Station, 507 25th street, Ogden, UT, USA.

&nbsp; 

Frescino, Tracey S.; Patterson, Paul L.; Moisen, Gretchen G.; Freeman, Elizabeth A. 2015. FIESTA—An R estimation tool for FIA analysts. In: Stanton, Sharon M.; Christensen, Glenn A., comps. 2015. Pushing boundaries: new directions in inventory techniques and applications: Forest Inventory and Analysis (FIA) symposium 2015. 2015 December 8–10; Portland, Oregon. Gen. Tech. Rep. PNW-GTR-931. Portland, OR: U.S. Department of Agriculture, Forest Service, Pacific Northwest Research Station. p. 72.

