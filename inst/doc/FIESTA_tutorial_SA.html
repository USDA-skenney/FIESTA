<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1">



<title>FIESTA - Small Area Estimators</title>






<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">FIESTA - Small Area Estimators</h1>


<div id="TOC">
<ul>
<li><a href="#fiesta-overview">FIESTA Overview</a><ul>
<li><a href="#small-area-sa-module-overview">Small Area (SA) module overview</a></li>
<li><a href="#objective-of-tutorial">Objective of tutorial</a></li>
</ul></li>
<li><a href="#example-data---wyoming-wy-inventory-years-2011-2012">Example data - Wyoming (WY), Inventory Years 2011-2012</a><ul>
<li><a href="#examples">EXAMPLES</a></li>
</ul></li>
<li><a href="#reference-tables-in-fiesta">Reference Tables in FIESTA</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

<div id="fiesta-overview" class="section level2">
<h2>FIESTA Overview</h2>
<p>The R package, FIESTA (Forest Inventory ESTimation and Analysis) is a research estimation tool for analysts that work with sample-based inventory data from the U.S. Department of Agriculture, Forest Service, Forest Inventory and Analysis (FIA) Program to accommodate: unique population boundaries, different evaluation time periods, customized stratification schemes, non-standard variance equations, integration of multi-scale remotely-sensed data and other ancillary information, and interaction with other modeling and estimation tools from CRAN R’s library of packages. FIESTA contains a collection of functions that can access FIA databases, summarize and compile plot and spatial data, and generate estimates with associated sampling errors.</p>
<p>Functions are organized by type or objective and are named with a corresponding prefix:</p>
<p><strong>Core Functions</strong></p>
<ul>
<li>Database tools (DB) - functions for querying and extracting data from FIA’s national database.</li>
<li>Data tools (dat) - functions for summarizing and exploring FIA data.</li>
<li>Spatial tools (sp) - functions for manipulating and summarizing spatial data.</li>
</ul>
<p><strong>Estimation Modules</strong></p>
<ul>
<li>Green-Book (GB) - functions for FIA’s standard Green-Book estimators.</li>
<li>Photo-Based (PB) - functions for supplementary photo-based estimators.</li>
<li>Small Area (SA) - functions for integration with available small area estimators (SAE).</li>
<li>Model-Assisted (MA) - functions for integration with available Model-Assisted estimators.</li>
</ul>
<p><strong>Analysis Tools</strong></p>
<ul>
<li>Analysis tools (an) - wrapper functions for steam-lining estimation processes.</li>
</ul>
<div id="small-area-sa-module-overview" class="section level3">
<h3>Small Area (SA) module overview</h3>
<p>FIESTA’s Small Area (SA) module was set up as a platform to integrate with current Small Area Estimators available on CRAN including the JoSAE (Breidenbach 2015) and sae (Molina and Marhuenda 2015) packages that use unit-level and area-level Empirical Best Linear Unbiased Prediction (EBLUP) estimation strategy for balancing potential bias of synthetic estimators against the instability of a direct estimator (Rao 2003). The module includes functional steps for checking, compiling, and formatting FIA plot data and ancillary spatial information for input to R packages, such as JoSAE (Breidenbach 2015) or sae (Molina and Marhuenda 2015) and translates integrated package output to FIESTA output format.</p>
</div>
<div id="objective-of-tutorial" class="section level3">
<h3>Objective of tutorial</h3>
<p>The main objective of this tutorial is to demonstrate how to use FIESTA for generating estimates using estimators from JoSAE and sae. The following examples are for generating estimates and estimated variances using standard FIA Evaluation data from FIA’s National database, with custom Estimation unit and Stratification information. The examples use data from three inventory years of field measurements in the state of Wyoming, from FIADB_1.7.2.00, last updated June 20, 2018, downloaded on June 25, 2018 and stored as internal data objects in FIESTA.</p>
</div>
</div>
<div id="example-data---wyoming-wy-inventory-years-2011-2012" class="section level2">
<h2>Example data - Wyoming (WY), Inventory Years 2011-2012</h2>
<table>
<thead>
<tr class="header">
<th>Data Frame</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>WYplt</td>
<td>WY plot-level data</td>
</tr>
<tr class="even">
<td>WYcond</td>
<td>WY condition-level data</td>
</tr>
<tr class="odd">
<td>WYtree</td>
<td>WY tree-level data</td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="27%"></col>
<col width="72%"></col>
</colgroup>
<thead>
<tr class="header">
<th>External data</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>WYbighorn_adminbnd.shp</td>
<td>Polygon shapefile of WY Bighorn National Forest Administrative boundary*</td>
</tr>
<tr class="even">
<td>WYbighorn_districtbnd.shp</td>
<td>Polygon shapefile of WY Bighorn National Forest District boundaries**</td>
</tr>
<tr class="odd">
<td>WYbighorn_forest_nonforest_250m.tif</td>
<td>GeoTIFF raster of predicted forest/nonforest (1/0) for stratification***</td>
</tr>
<tr class="even">
<td>WYbighorn_dem_250m.img</td>
<td>Erdas Imagine raster of elevation change, in meters****</td>
</tr>
</tbody>
</table>
<p>*USDA Forest Service, Automated Lands Program (ALP). 2018. S_USA.AdministrativeForest (). Description: An area encompassing all the National Forest System lands administered by an administrative unit. The area encompasses private lands, other governmental agency lands, and may contain National Forest System lands within the proclaimed boundaries of another administrative unit. All National Forest System lands fall within one and only one Administrative Forest Area.</p>
<p>**USDA Forest Service, Automated Lands Program (ALP). 2018. S_USA.RangerDistrict (<a href="http://data.fs.usda.gov/geodata/edw" class="uri">http://data.fs.usda.gov/geodata/edw</a>). Description: A depiction of the boundary that encompasses a Ranger District.</p>
<p>***Based on MODIS-based classified map resampled from 250m to 500m resolution and reclassified from 3 to 2 classes: 1:forest; 2:nonforest. Projected in Albers Conical Equal Area, Datum NAD27 (Ruefenacht et al. 2008). Clipped to extent of WYbighorn_adminbnd.shp.</p>
<p>****USGS National Elevation Dataset (NED), resampled from 30m resolution to 250m. Projected in Albers Conical Equal Area, Datum NAD27 (U.S. Geological Survey 2017). Clipped to boundary of WYbighorn_adminbnd.shp.</p>
<table>
<colgroup>
<col width="18%"></col>
<col width="81%"></col>
</colgroup>
<thead>
<tr class="header">
<th>FUNCTION</th>
<th>DESCRIPTION</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><a href="#spGetSAdoms">spGetSAdoms()</a></td>
<td>Gets small area domains for estimation.</td>
</tr>
<tr class="even">
<td><a href="#spGetDBbnd">spGetDBbnd()</a></td>
<td>Gets data from FIA database for plots within a given boundary.</td>
</tr>
<tr class="odd">
<td><a href="#spGetModeldat">spGetModeldat()</a></td>
<td>Gets plot and spatial data for small area models.</td>
</tr>
<tr class="even">
<td><a href="#modSAtree">modSAtree()</a></td>
<td>Generate tree estimates using Small Area Estimation (SAE) methods.</td>
</tr>
</tbody>
</table>
<div id="examples" class="section level3">
<h3>EXAMPLES</h3>
<p>Set up for examples</p>
<pre><code># Load library
library(FIESTA)
library(sae)
library(JoSAE)
library(nlme)


# Set workspace to FIESTA folder (create if doesn't exist)
if (!file.exists(&quot;C:/FIESTA&quot;))  dir.create(&quot;C:/FIESTA&quot;)
setwd(&quot;C:/FIESTA&quot;)

# Create 2 subfolders under the FIESTA folder, 'data' and 'outfolder' and set path to objects 
if (!file.exists(&quot;data&quot;))  dir.create(&quot;data&quot;)
datfolder &lt;- &quot;data&quot; 

if (!file.exists(&quot;outfolder&quot;)) dir.create(&quot;outfolder&quot;)
outfolder &lt;- &quot;outfolder&quot;

# File names for external spatial data
WYbhfn &lt;- system.file(&quot;extdata&quot;, &quot;sp_data/WYbighorn_adminbnd.shp&quot;, package=&quot;FIESTA&quot;)
WYbhdistfn &lt;- system.file(&quot;extdata&quot;, &quot;sp_data/WYbighorn_districtbnd.shp&quot;, package=&quot;FIESTA&quot;)
WYbhdist.att &lt;- &quot;DISTRICTNA&quot;

fornffn &lt;- system.file(&quot;extdata&quot;, &quot;sp_data/WYbighorn_forest_nonforest_250m.tif&quot;, package=&quot;FIESTA&quot;)
demfn &lt;- system.file(&quot;extdata&quot;, &quot;sp_data/WYbighorn_dem_250m.img&quot;, package=&quot;FIESTA&quot;)

# Derive new layers from dem
library(raster)
dem &lt;- raster(demfn)
slp &lt;- terrain(dem, opt=&quot;slope&quot;, unit=&quot;degrees&quot;, filename=paste0(outfolder, &quot;/WYbh_slp.img&quot;), overwrite=TRUE)
asp &lt;- terrain(dem, opt=&quot;aspect&quot;, unit=&quot;degrees&quot;, filename=paste0(outfolder, &quot;/WYbh_asp.img&quot;), overwrite=TRUE)

</code></pre>
<p><a name="ref"></a></p>
</div>
</div>
<div id="reference-tables-in-fiesta" class="section level2">
<h2>Reference Tables in FIESTA</h2>
<p>There are several reference tables stored in FIESTA, including table variable descriptions, code definitions, and estimation categories.</p>
<ul>
<li>Table variable descriptions - ref_plt, ref_cond, ref_tree</li>
<li>Code definitions - ref_codes</li>
</ul>
<p><a name="auxiliary"></a></p>
<div id="spgetsadoms" class="section level4">
<h4><a name="spGetSAdoms"></a>spGetSAdoms()</h4>
<pre><code>######################################################################################
# Usage:
# spGetSAdoms(smallbnd_layer, smallbnd_dsn = NULL, smallbnd.att, 
#     smallbnd.name = NULL, smallbnd.filter = NULL, helperbnd_layer = NULL, 
#     helperbnd_dsn = NULL, helperbnd.att = NULL, helperbnd.name = NULL, 
#     helperbnd.filter = NULL, largebnd_layer = NULL, largebnd_dsn = NULL, 
#     largebnd.att = NULL, largebnd.name = NULL, largebnd.filter = NULL, 
#     exportshp = FALSE, outfolder = NULL, outfn = NULL, outfn.date = TRUE, 
#     overwrite = FALSE)
# 
# Description:
# Get spatial domains for small area estimation.
######################################################################################
help(spGetSAdoms)

WYbhdist &lt;- spImportSpatial(WYbhdistfn)
head(WYbhdist@data)

## Get spatial domains for small area estimation
SAdoms &lt;- spGetSAdoms(smallbnd_layer=WYbhdistfn, smallbnd.att=&quot;DISTRICTNA&quot;)
SAdoms@data
sp::plot(SAdoms)

</code></pre>
</div>
<div id="spgetdbbnd" class="section level4">
<h4><a name="spGetDBbnd"></a>spGetDBbnd()</h4>
<pre><code>######################################################################################
# Usage:
# spGetDBbnd(bnd_layer, bnd_dsn = NULL, stbnd = NULL, states = NULL,  
#       RMRSonly = TRUE, datsource = &quot;ORACLE&quot;, FS_FIADB = FALSE, SQLitefn = NULL,  
#       evalCur = TRUE, evalEndyr = NULL, evalType = &quot;all&quot;, actual = FALSE,  
#       coordsfn = NULL, coordsfn.uniqueid = NULL, savedata = FALSE,  
#       exportshp = FALSE, outfolder = NULL, overwrite = FALSE, outfn = NULL,  
#       outfn.pre = NULL, datPlots = NULL, CTcoverfn = NULL, ...) 
# 
# Description:
# Extract data from FIA database for plots within a given boundary.
######################################################################################
bnd_layer=SAdoms
FS_FIADB=TRUE
states=&quot;Wyoming&quot;
datsource=&quot;CSV&quot;

layer=SAdoms
dsn=NULL
caption=NULL
checkonly=FALSE
stopifnull=FALSE
gui=FALSE


source(&quot;C:\\_tsf\\_GitHub\\FIESTA\\R\\spGetDBbnd.R&quot;)
SAdata &lt;- spGetDBbnd(bnd_layer=SAdoms, FS_FIADB=TRUE, states=&quot;Wyoming&quot;, datsource=&quot;CSV&quot;,
      invyrs=2011:2013)
names(SAdata)
SAbnd &lt;- SAdata$clip_poly
SAspplt &lt;- SAdata$clip_spplt
SAdata$coordtype

SAtabs &lt;- SAdata$clip_tabs
names(SAtabs)
SAplt &lt;- SAtabs$clip_plt
SAcond &lt;- SAtabs$clip_cond
SAtree &lt;- SAtabs$clip_tree
SAshp_PUBLIC &lt;- SAtabs$clip_shp_PUBLIC

sp::plot(SAspplt)
sp::plot(SAbnd, add=TRUE)

table(SAplt$INVYR)
</code></pre>
</div>
<div id="spgetmodeldat" class="section level4">
<h4><a name="spGetModeldat"></a>spGetModeldat()</h4>
<pre><code>######################################################################################
# Usage:
# spGetModeldat(spplt = NULL, spplt_dsn = NULL, xyplt = NULL, uniqueid = &quot;PLT_CN&quot;,  
#       domtype = &quot;POLY&quot;, dom_dsn, dom_layer = NULL, unitvar = NULL, rastlst.cont = NULL,  
#     rastlst.cont.name = NULL, rastlst.cont.stat = &quot;MEAN&quot;, rastlst.cat = NULL, 
#       rastlst.cat.name = NULL, rastfolder = NULL, rast.NODATA = NULL,  
#     asptransform = FALSE, asprast = NULL, keepnull = FALSE, showext = TRUE,   
#       savedata = FALSE, exportshp = FALSE, outfolder = NULL, outfn = NULL, 
#     overwrite = FALSE, ...) 
# 
# Description:
# Get data extraction and zonal statistics for Model-assisted or
#       Model-based (Small Area) Estimation. The major steps are as follows:
#   1) Check parameters 
#   2) Extract point values from domlayer
#   3) Set up output data structures
#   4) Extract point values and get zonal statistics from continuous raster layers
#   5) Extract point values and get zonal statistics from categorical raster layers
#   6) Get total acres from domlayer (if areacalc=TRUE)
######################################################################################

## Extract from raster predictor layers
#######################################################
rastlst.cont &lt;- c(demfn, slp, asp)
rastlst.cont.name &lt;- c(&quot;dem&quot;, &quot;slp&quot;, &quot;asp&quot;)
rastlst.cat &lt;- fornffn
rastlst.cat.name=&quot;fornf&quot;

modeldat &lt;- spGetModeldat(spplt=SAspplt, uniqueid=&quot;PLT_CN&quot;, dom_layer=SAbnd,
  domvar=&quot;DOMAIN&quot;, rastlst.cont=rastlst.cont, rastlst.cont.name=rastlst.cont.name,
  rastlst.cat=rastlst.cat, rastlst.cat.name=rastlst.cat.name, rastlst.cont.stat=&quot;mean&quot;,
  rast.NODATA=0, asptransform=TRUE, rast.asp=asp, keepnull=FALSE, showext=FALSE,
  savedata=FALSE, vars2keep=&quot;AOI&quot;)
names(modeldat)

sppltmodel &lt;- modeldat$sppltmodel
pltmodel &lt;- modeldat$pltmodel
dunitlut &lt;- modeldat$domzonal
dunitarea &lt;- modeldat$domarea
dunitvar &lt;- modeldat$domvar
areavar &lt;- modeldat$areavar
inputdf &lt;- modeldat$inputdf
prednames &lt;- modeldat$prednames
dunitnames &lt;- modeldat$zonalnames
predfac &lt;- modeldat$predfac

dunitlut
dunitvar
areavar
head(pltmodel)
prednames
dunitnames
dunitarea

</code></pre>
</div>
<div id="modsatree" class="section level4">
<h4><a name="modSAtree"></a>modSAtree()</h4>
<pre><code>######################################################################################
# Usage:
# modSAtree(tree, cond=NULL, pltmodel=NULL, tuniqueid=&quot;PLT_CN&quot;, 
#     cuniqueid=&quot;PLT_CN&quot;, puniqueid=&quot;PLT_CN&quot;, sumunits=FALSE, adjplot=TRUE, 
#     SApackage=&quot;JoSAE&quot;, SAmethod=&quot;unit&quot;, landarea=&quot;ALL&quot;, ACI=FALSE, 
#     nonsamp.filter=NULL, plt.filter=NULL, cond.filter=NULL, domarea=NULL, 
#     domvar=&quot;DOMAIN&quot;, areavar=NULL, domzonal=NULL, npixelvar=&quot;npixels&quot;,  
#     prednames=NULL, predfac=NULL, estvar=NULL, estvar.filter=NULL, 
#   allin1=FALSE, estround=0, pseround=3, divideby=NULL, savedata=FALSE, 
#   rawdata=FALSE, outfolder=NULL, outfn=NULL, outfn.pre=NULL, 
#   outfn.date=TRUE, overwrite=FALSE, addtitle=TRUE, returntitle=FALSE, 
#   title.main=NULL, title.ref=NULL, title.unitvar=NULL, title.estvar=NULL,
#   title.filter=NULL, gui=FALSE) 
# 
# Description:
# Generate estimates for area of interest, or small boundary.
######################################################################################


## Estimates of live basal area (sq cuft) by Bighorn National Forest district
estvar &lt;- &quot;BA&quot;
#prednames &lt;- prednames[1:3]   ## Note: not yet working with factor variables
estvar.filter &lt;- &quot;STATUSCD == 1&quot;
tree=SAtree
cond=SAcond
pltmodel=sppltmodel
adjplot=TRUE
SAmethod=&quot;area&quot;
SApackage=&quot;JoSAE&quot;

SAdat &lt;- modSAtree(tree=SAtree, cond=SAcond, pltmodel=sppltmodel,
  dunitarea=dunitarea, areavar=areavar, dunitlut=dunitlut, 
  prednames=prednames, predfac=predfac,
  estvar=estvar, estvar.filter=estvar.filter, rawdata=TRUE)

names(SAdat)
SAdat$est
SAdat.raw &lt;- SAdat$raw
names(SAdat.raw)


SAdat.raw$plotsampcnt
SAdat.raw$condsampcnt

SAdat.raw$domzonal
SAdat.raw$domarea
head(SAdat.raw$tdomdat)
SAdat.raw$estvar

SAdat.raw$JoSAE.unit
SAdat.raw$JoSAE.unit.lme

</code></pre>
</div>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<p>Breidenbach J. 2018. JoSAE: Unit-Level and Area-Level Small Area Estimation.</p>
<p>Molina I, Marhuenda Y. 2015. sae: An R Package for Small Area Estimation. The R Journal, 7(1), 81–98. <a href="https://journal.r-project.org/archive/2015/RJ-2015-007/RJ-2015-007.pdf" class="uri">https://journal.r-project.org/archive/2015/RJ-2015-007/RJ-2015-007.pdf</a>.</p>
<p>Rao, J.N.K. 2003. Small Area Estimation. Wiley, Hoboken, New Jersey.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
