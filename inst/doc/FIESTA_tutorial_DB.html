<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>FIESTA - Database Tools</title>






<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">FIESTA - Database Tools</h1>



<div id="fiesta-overview" class="section level2">
<h2>FIESTA Overview</h2>
<p>The R package, FIESTA (Forest Inventory ESTimation and Analysis) is a research estimation tool for analysts that work with sample-based inventory data from the U.S. Department of Agriculture, Forest Service, Forest Inventory and Analysis (FIA) Program to accommodate: unique population boundaries, different evaluation time periods, customized stratification schemes, non-standard variance equations, integration of multi-scale remotely-sensed data and other ancillary information, and interaction with other modeling and estimation tools from CRAN R’s library of packages. FIESTA contains a collection of functions that can access FIA databases, summarize and compile plot and spatial data, and generate estimates with associated sampling errors.</p>
<p>Functions are organized by type or objective and are named with a corresponding prefix:</p>
<ul>
<li><p>Database tools (DB) - functions for querying and extracting data from FIA’s national database.</p></li>
<li><p>Data tools (dat) - functions for summarizing and exploring FIA data.</p></li>
<li><p>Spatial tools (sp) - functions for manipulating and summarizing spatial data.</p></li>
<li><p>Estimation modules (GB, PB, SA) - functions for different estimation strategies, such as FIA’s standard ‘Green-Book’ estimators (GB); suplementary photo-based estimators (PB); integration with different available small area estimators (SAE) or other model-assisted or model-based estimation tools, such as LASSO.</p></li>
<li><p>Analysis tools (an) - wrapper functions for steam-lining estimation processes.</p></li>
</ul>
<p>FIESTA’s DB tools extract data from FIA’s online publically-available comma-delimited files (*.csv or *.zip). FIA’s CSV files are available by state from the FIA DataMart at the following link: <a href="https://apps.fs.usda.gov/fia/datamart/datamart.html" class="uri">https://apps.fs.usda.gov/fia/datamart/datamart.html</a>. Because of FIA’s confidentiality agreement to protect the privacy of landowners, as well as protecting the scientific integrity of FIA’s sample design, the exact coordinates of the sample plot locations are not included in the public data. If the exact coordinates are necessary for your analysis, contact FIA’s Spatial Data Services (<a href="https://www.fia.fs.fed.us/tools-data/spatial/index.php" class="uri">https://www.fia.fs.fed.us/tools-data/spatial/index.php</a>).</p>
<div id="objective-of-tutorial" class="section level3">
<h3>Objective of tutorial</h3>
<p>The objective of this tutorial is to demonstrate the use of FIESTA’s DB tools for accessing FIA data. These tools extract data from FIADB using FIA’s standard evaluations as well as customized evaluations (DBgetPlots and DBgetStrata). An FIA Evaluation is a group of plots within the FIA database that is used for population estimates, representing different inventory spans of data with different stratification or area adjustments. Each Evaluation is determined by the type of estimation (evalType) including: area and tree estimates, growth and mortality estimates, and area change estimates (evalType). These plots are identified by an evalid, which is a unique identifier in the format of a 2-digit State code, a 2-digit year code, and a 2-digit evaluation type code. For example, EVALID ‘491601’ represents the Utah 2016 evaluation for current area estimates.</p>
<table>
<colgroup>
<col width="18%"></col>
<col width="81%"></col>
</colgroup>
<thead>
<tr class="header">
<th>FUNCTION</th>
<th>DESCRIPTION</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><a href="#DBgetCSV">DBgetCSV()</a></td>
<td>Downloads comma-delimited file (.csv) or downloads and extracts a compressed csv file (.zip) from FIA’s online DataMart.</td>
</tr>
<tr class="even">
<td><a href="#DBqryCSV">DBqryCSV()</a></td>
<td>Extracts and queries data from FIA’s online DataMart, either CSV or ZIP files.</td>
</tr>
<tr class="odd">
<td><a href="#DBgetEvalid">DBgetEvalid()</a></td>
<td>Gets evalid for identifying an estimation group of plots for state or checks evalid.</td>
</tr>
<tr class="even">
<td><a href="#DBgetPlots">DBgetPlots()</a></td>
<td>Extracts inventory plot data from FIA database.</td>
</tr>
<tr class="odd">
<td><a href="#DBgetStrata">DBgetStrata()</a></td>
<td>Extracts strata information and total acres by estimation unit from FIA database, including plot-level assignment and a data frame with strata weights by estimation unit.</td>
</tr>
</tbody>
</table>
</div>
<div id="examples" class="section level3">
<h3>EXAMPLES</h3>
<p>Set up for examples</p>
<pre><code># Load library
library(FIESTA)

# Set workspace to FIESTA folder (create if doesn't exist)
if (!file.exists(&quot;C:/FIESTA&quot;))  dir.create(&quot;C:/FIESTA&quot;)
setwd(&quot;C:/FIESTA&quot;)

# Create 2 subfolders under the FIESTA folder, 'data' and 'outfolder' and set path to objects 
if (!file.exists(&quot;data&quot;))  dir.create(&quot;data&quot;)
datfolder &lt;- &quot;data&quot; 

if (!file.exists(&quot;outfolder&quot;)) dir.create(&quot;outfolder&quot;)
outfolder &lt;- &quot;outfolder&quot;


## Load SQLite database from FIESTAdata package
library(FIESTAdata)
SQLitefn &lt;- FIESTAdata::get_sqlite()

</code></pre>
<p>The following examples show how to use FIA’s publically-available, online zipfiles or a custom-built SQLite database that is stored internal to FIESTA. The plot coordinates have been altered for privacy (See <a href="https://www.fia.fs.fed.us/tools-data/spatial/Policy/index.php" class="uri">https://www.fia.fs.fed.us/tools-data/spatial/Policy/index.php</a> for details). The zip files are extracted on-the-fly from the online website. Web server connections will affect download speeds.</p>
<div id="dbgetcsv" class="section level4">
<h4><a name="DBgetCSV"></a>DBgetCSV()</h4>
<pre><code>####################################################################################
# Usage:
# DBgetCSV(DBtable, states = NULL, ZIP = TRUE, returnDT = TRUE) 
# 
# Description:
# Downloads *.csv file or downloads and extracts a *.zip file from FIA DataMart.
# Only 1 table can be specified, but multiple states may be included.
# Value:
# Returns a data table (returnDT=TRUE), or data.frame (returnDT=FALSE).
####################################################################################

## Get plot table for Wyoming
WYplots &lt;- DBgetCSV(&quot;PLOT&quot;, &quot;Wyoming&quot;)
dim(WYplots)

## Get plot table for Wyoming and Utah
WYUTplots &lt;- DBgetCSV(DBtable=&quot;PLOT&quot;, states=c(&quot;Wyoming&quot;, &quot;Utah&quot;))
table(WYUTplots$STATECD)

## Get survey table for Wyoming
WYsurvey &lt;- DBgetCSV(&quot;SURVEY&quot;, &quot;Wyoming&quot;)
WYsurvey

## Get ref_unit table
ref_research_station &lt;- DBgetCSV(&quot;ref_research_station&quot;)
head(ref_research_station)

</code></pre>
</div>
<div id="dbqrycsv" class="section level4">
<h4><a name="DBqryCSV"></a>DBqryCSV()</h4>
<pre><code>####################################################################################
# Usage:
# DBqryCSV(sql, ZIP = TRUE, states = NULL, sqltables = NULL) 
# 
# Description:
# Queries and extracts data from FIA's online data sources (FIA DataMart), 
#   either CSV or ZIP files (Note: must use SQL syntax).
#
# Value:
# Returns a data frame from resulting query.
####################################################################################

# QUERY1: Number of plots by inventory year for the state of Wyoming
sql1.csv &lt;- &quot;select INVYR, count(*) AS NBRPLOTS 
          from plot 
          where statecd=56 group by INVYR&quot;
DBqryCSV(sql=sql1.csv, states=&quot;Wyoming&quot;, sqltables=&quot;plot&quot;)

# QUERY2: min, mean, max height by FORTYPCD in Wyoming
sql2b.csv &lt;- &quot;select c.FORTYPCD, min(HT) HTmin, round(avg(HT)) HTmean, max(HT) maxHT 
                    from cond c INNER JOIN tree t ON c.PLT_CN = t.PLT_CN 
                    where c.statecd = 56 
                    group by c.FORTYPCD order by c.FORTYPCD&quot;
DBqryCSV(sql=sql2b.csv, states=&quot;Wyoming&quot;, sqltables=c(&quot;cond&quot;, &quot;tree&quot;))

# QUERY3: Number of plots by inventory year for Utah and Wyoming
sql3.csv &lt;- &quot;select STATECD, INVYR, count(*) NBRPLOTS 
          from plot 
          where statecd in(49,56) group by STATECD, INVYR&quot;
DBqryCSV(sql=sql3.csv, states=c(&quot;Utah&quot;, &quot;Wyoming&quot;), sqltables=&quot;plot&quot;)

</code></pre>
</div>
<div id="dbgetevalid" class="section level4">
<h4><a name="DBgetEvalid"></a>DBgetEvalid()</h4>
<pre><code>######################################################################################
# Usage:
# DBgetEvalid(states = NULL, RS = NULL, datsource = &quot;CSV&quot;, ZIP = TRUE, FS_FIADB = TRUE,  
#   invyrtab = NULL, invtype = &quot;ANNUAL&quot;, evalCur = TRUE, evalEndyr = NULL, evalid = NULL, 
#   evalType = &quot;ALL&quot;, dbconn = NULL, dbconnopen = FALSE, gui = FALSE)
# 
# Description:
# Extracts an evalid for identifying an estimation group of plots. If evalCur=TRUE, 
#   extracts current evalid and inventory years for state(s), or for a specified 
#   evalEndyr. Otherwise checks an evalid and returns states and inventory years.
#
# Value:
# A list of data objects:
#   $states      - state names
#   $rslst       - FIA research station names included in output
#   $evalidlist  - evalid by state
#   $invtype     - inventory type for state(s) (ANNUAL/PERIODIC)
#   $invyrtab    - a data frame with inventory years by state corresponding to evalid
#   $evalType    - Evaluation type(s) included in query
#   $invyrs      - a list of inventory years by state corresponding to evalid
######################################################################################

help(DBgetEvalid)

# Using GUI interface. 
eval &lt;- DBgetEvalid()
names(eval)
eval

## Get evalid and inventory years for Wyoming
WYeval &lt;- DBgetEvalid(states=&quot;Wyoming&quot;)
names(WYeval)
WYeval$evalidlist
WYeval$invyrs
WYeval$invyrtab
WYeval$invtype

## Get evalid for Utah and Wyoming
UTWYeval &lt;- DBgetEvalid(states=c(&quot;Wyoming&quot;, &quot;Utah&quot;))
UTWYeval$evalidlist
UTWYeval$invyrs
UTWYeval$invyrtab
UTWYeval$invtype

## Get most current evaluation for all states in RMRS and NCRS FIA research units
eval.cur &lt;- DBgetEvalid(RS=c(&quot;RMRS&quot;, &quot;NCRS&quot;))
names(eval.cur)
eval.cur$evalidlist


## Get most current evaluation for New York and Texas for areavol and grm evalTypes
NYTXeval.cur &lt;- DBgetEvalid(states=c(&quot;New York&quot;, &quot;Texas&quot;), evalType=c(&quot;AREAVOL&quot;, &quot;GRM&quot;))
names(NYTXeval.cur)
NYTXeval.cur$evalidlist
NYTXeval.cur$evalTypelist

</code></pre>
</div>
<div id="dbgetplots" class="section level4">
<h4><a name="DBgetPlots"></a>DBgetPlots()</h4>
<pre><code>######################################################################################
# Usage:
# DBgetPlots(states = NULL, RS = NULL, invtype = &quot;ANNUAL&quot;, evalid = NULL, 
#   evalCur = FALSE, evalEndyr = NULL, evalType = &quot;AREAVOL&quot;, allyrs = FALSE, 
#   invyrs = NULL, istree = FALSE, isseed = FALSE, isveg = FALSE, issp = FALSE, 
#   spcondid1 = FALSE, defaultVars = TRUE, regionVars = FALSE, ACI = FALSE,
#   subcycle99 = FALSE, intensity1 = TRUE, stateFilter = NULL, allFilter = NULL,  
#   savedata = FALSE, saveqry = FALSE, parameters = FALSE, outfolder = NULL, 
#   outSQLitern = NULL, outfn.pre = NULL, outfn.date = FALSE, overwrite = FALSE, 
#   returnPOP = FALSE)
# 
# Description:
# Extracts field, calculated, and derived data from FIA's publically-accessible 
#   online DataMart (https://apps.fs.usda.gov/fia/datamart/datamart.html).
# 
# Value:
# A list of data objects:
#   $states   - state names
#   $plt          - Plot variables from PLOT table
#   $cond         - Cond variables from COND table
#   $tree         - If istree=TRUE, tree variables from TREE table
#   $seed       - If isseed=TRUE, seedling variables from SEEDLING table
#   $spplt_*    - if issp=TRUE, SpatialPoints object with plot and some cond attributes  
#              represented at plot-level (see help for details).
#   $vspspp  - if isveg=TRUE, subplot understory vegetation from P2VEG_SUBPLOT_SPP
#   $vspstr  - if isveg=TRUE, subplot cover and layer understory vegetation from P2VEG_SUBP_STRUCTURE
#   $evalid  - if evalCur=TRUE or evalEndyr is not NULL, evalidation ID by state
#   $pltcnt  - number of plots by state, cycle, inventory year, and plot status
#
# If savedata=TRUE:
#   - If saveqry=TRUE, text file(s) of SQL queries used to extract data from database (*.txt),
#       Note: the plot and cond table is 1 query (pltcondqry*.txt).
#   - If parameters=TRUE, text file of parameters used. This file can be used to run program again 
#   (DBgetPlots_parameters_'date'.txt).
#   - If text file of plot and condition counts (pltcnt_*'date'.txt).
#   - If comma-delimited files of data frame objects (*'date'.csv).
#   - If issp=TRUE, an ESRI shapefile of plot and some condition attributes (shp_PUBLIC_'date'.shp).
#   Variable names are truncated to 10 characters or less. 
#   - If issp=TRUE, a comma-delimited file of the SpatialPoints data frame (shpdat_PUBLIC_'date'.csv).
#   - If issp=TRUE, a comma-delimited file of truncated names for conversion to shapefile
#   (shp_PUBLIC_newnames_'date'.shp). See notes for more info.
######################################################################################

help(DBgetPlots)

# Using GUI interface.
dat &lt;- DBgetPlots()
names(dat)
save(dat, file=paste(outfolder, &quot;dat.rda&quot;), sep=&quot;/&quot;)


# Most current evaluation and shapefile with public coordinates
WYdat1 &lt;- DBgetPlots(states=&quot;Wyoming&quot;, evalCur=TRUE, issp=TRUE)
names(WYdat1)
WYplt1 &lt;- WYdat1$plt
WYcond1 &lt;- WYdat1$cond
WYspxy_PUBLIC1 &lt;- WYdat1$spxy_PUBLIC
WYdat1$evalid
WYdat1$pltcnt

dim(WYplt1)

# Look at output
head(WYcond1)
plot(st_geometry(WYspxy_PUBLIC1))
table(WYplt1$INVYR)


# Add stateFilter (NOTE: only plot-level filters)
WYdat1b &lt;- DBgetPlots(states=&quot;Wyoming&quot;, evalCur=TRUE, issp=TRUE, stateFilter=&quot;p.COUNTYCD == 1&quot;)
dim(WYdat1b$plt)



# Include tree data
WYdat1 &lt;- DBgetPlots(states=&quot;Wyoming&quot;, evalCur=TRUE, issp=TRUE, istree=TRUE)
names(WYdat1)
WYtree1 &lt;- WYdat1$tree
head(WYtree1)

## Save to SQLite database (&quot;C:/FIESTA/data.sqlite&quot;)
WYdat1 &lt;- DBgetPlots(states=&quot;Wyoming&quot;, evalCur=TRUE, issp=TRUE, istree=FALSE,
              savedata=TRUE, outfolder=outfolder, 
              outSQLitefn=&quot;data.sqlite&quot;, overwrite=TRUE)

sqlitefn &lt;- file.path(outfolder, &quot;data.sqlite&quot;)

## Connect to database and list tables
conn &lt;- DBI::dbConnect(RSQLite::SQLite(), sqlitefn)
DBI::dbListTables(conn)
sf::st_layers(sqlitefn)

## Read in plot table
plt &lt;- DBI::dbReadTable(conn, &quot;plot&quot;)
dim(plt)

## Read in spatial xy coordinates
spxy_public &lt;- sf::st_read(sqlitefn, layer=&quot;spxy_public&quot;)
dim(spxy_public)

plot(sf::st_geometry(spxy_public))


# Most current evaluation and shapefile with public coordinates, 
# evalTypes - all, areavol, and growmort
##################################################################################
WYdat1a &lt;- DBgetPlots(states=&quot;Wyoming&quot;, evalCur=TRUE, issp=TRUE, 
                    evalType=c(&quot;ALL&quot;, &quot;AREAVOL&quot;, &quot;GRM&quot;))
names(WYdat1a)
WYplt1a &lt;- WYdat1a$plt
WYcond1a &lt;- WYdat1a$cond
WYdat1a$evalid

# Look at output
dim(WYplt1a)
head(WYplt1a)
table(WYplt1a$EVALID)


## Get WYplt, evalid ending in 00 
WYplt00 &lt;- WYplt1a[endsWith(as.character(WYplt1a$EVALID), &quot;00&quot;),]
dim(WYplt00)


# Inventory years 2012:2014 and shapefile with public coordinates
##################################################################################
WYdat2 &lt;- DBgetPlots(states=&quot;Wyoming&quot;, invyrs=2012:2014, issp=TRUE)
names(WYdat2)
WYplt2 &lt;- WYdat2$plt
WYcond2 &lt;- WYdat2$cond
WYspplt_PUBLIC2 &lt;- WYdat2$spxy_PUBLIC
WYdat2$pltcnt

# Look at output
head(WYcond2)
plot(sf::st_geometry(WYspplt_PUBLIC2))
table(WYplt2$INVYR)


# Two different states, most current evaluation
##################################################################################
UTWYdata &lt;- DBgetPlots(states=c(&quot;Utah&quot;, &quot;Wyoming&quot;), evalCur=TRUE)
names(UTWYdata)
UTWYdata$pltcnt
UTWYplt &lt;- UTWYdata$plt
table(UTWYplt$STATECD, UTWYplt$INVYR)


# Two different states, one inventory year
##################################################################################
UTWY15data &lt;- DBgetPlots(states=c(&quot;Utah&quot;, &quot;Wyoming&quot;), invyrs=2015)
names(UTWY15data)
UTWY15data$pltcnt
UTWY15plt &lt;- UTWY15data$plt
table(UTWY15plt$STATECD, UTWY15plt$INVYR)


# Two different states, different inventory years
##################################################################################
UTWYdata2 &lt;- DBgetPlots(states=c(&quot;Utah&quot;, &quot;Wyoming&quot;), invyrs=list(Utah=2010, Wyoming=2015))
names(UTWYdata2)
UTWYdata2$pltcnt


# All years of periodic data for Wyoming
##################################################################################
WYdata.periodic &lt;- DBgetPlots(states=&quot;Wyoming&quot;, invtype=&quot;PERIODIC&quot;, 
    allyrs=TRUE)
names(WYdata.periodic)
WYdata.periodic$pltcnt


# Most current evaluation of periodic data for Wyoming
# Note: the periodic inventory did not have evalType=&quot;ALL&quot;
##################################################################################
WYdata.periodic2 &lt;- DBgetPlots(states=&quot;Wyoming&quot;, invtype=&quot;PERIODIC&quot;, evalCur=TRUE,
      evalType=&quot;AREAVOL&quot;)
names(WYdata.periodic2)
WYdata.periodic2$pltcnt


# Most current evaluation of Utah and Wyoming filtered for OWNCD=11
##################################################################################
UTWYdata.nfs &lt;- DBgetPlots(states=c(&quot;Utah&quot;, &quot;Wyoming&quot;), evalEndyr=2017, 
                  allFilter=&quot;OWNCD == 11&quot;, evalType=&quot;ALL&quot;)
names(UTWYdata.nfs)
UTWYdata.nfs$pltcnt
table(UTWYdata.nfs$cond$ADFORCD)


# Most current inventory years for Idaho/Montana, R1, filtered for OWNGRPCD=10
# Include tree data
##################################################################################
UTdata.nfs &lt;- DBgetPlots(states=c(&quot;Idaho&quot;, &quot;Montana&quot;), invyrs=2008:2017, istree=TRUE,
                  allFilter=&quot;OWNGRPCD == 10 &amp; (ADFORCD &gt; 100 &amp; ADFORCD &lt; 200)&quot;)
names(UTdata.nfs)
UTdata.nfs$pltcnt
table(UTdata.nfs$cond$ADFORCD)



################## All Condition Inventory (ACI) data

# Region 1 plots, filtered for OWNGRPCD=10, include tree data with ACI
# Note: ACI data are not included in FIA evaluations, must specify inventory years
##################################################################################
UTdata.nfsACI &lt;- DBgetPlots(states=c(&quot;Idaho&quot;, &quot;Montana&quot;), invyrs=2008:2017, 
                  istree=TRUE, ACI=TRUE, 
                  allFilter=&quot;OWNGRPCD == 10 &amp; (ADFORCD &gt; 100 &amp; ADFORCD &lt; 200)&quot;)
names(UTdata.nfsACI)
UTdata.nfsACI$pltcnt
table(UTdata.nfsACI$cond$ADFORCD)



## Compare with FIA 2008-2017 Inventory years, not including ACI data
table(UTdata.nfs$plt$NF_PLOT_STATUS_CD)
dim(UTdata.nfs$tree)

table(UTdata.nfsACI$plt$NF_PLOT_STATUS_CD)
dim(UTdata.nfsACI$tree)



# All inventory years for Utah
##################################################################################
UTdat.all &lt;- DBgetPlots(states=&quot;Utah&quot;, allyrs=TRUE)
names(UTdat.all)
UTplt.all &lt;- UTdat.all$plt
table(UTplt.all$INVYR)



################## Save to SQLite database

# Wyoming - most current evaluation - save to SQLite database
##################################################################################
WYdat &lt;- DBgetPlots(states=&quot;Wyoming&quot;, evalCur=TRUE, istree=TRUE, 
          savedata=TRUE, outfolder=outfolder, outSQLitefn=&quot;WYdat&quot;,
          overwrite=TRUE)
names(WYdat)
WYplt &lt;- WYdat$plt
WYcond &lt;- WYdat$cond
WYtree &lt;- WYdat$tree
WYpltcnt &lt;- WYdat$pltcnt

head(WYplt)
head(WYcond)
head(WYtree)
WYpltcnt

## Read SQLite database
dsn &lt;- file.path(outfolder, &quot;WYdat.sqlite&quot;)
conn &lt;- dbConnect(RSQLite::SQLite(), dsn)
dbListTables(conn)
WYplt &lt;- dbGetQuery(conn, &quot;select * from plot&quot;)
dbDisconnect(conn)

</code></pre>
</div>
<div id="dbgetstrata" class="section level4">
<h4><a name="DBgetStrata"></a>DBgetStrata()</h4>
<pre><code>######################################################################################
# Usage:
# DBgetStrata(dat = NULL, uniqueid = &quot;CN&quot;, states = NULL, evalid = NULL, 
#   evalCur = FALSE, evalEndyr = NULL, evalType = &quot;AREAVOL&quot;, savedata = FALSE, 
#   outfolder = NULL, outfn.pre = NULL, outfn.date = FALSE, overwrite = FALSE, 
#   POP_PLOT_STRATUM_ASSGN = NULL)
# 
# Description:
# Gets strata information from FIA DataMart, including:
# (1) strata and estimation unit assignment per plot; (2) total area by estimation unit;
# (3) pixel counts and number plots by strata/estimation unit. 
# 
# Value:
# A list of data objects:
#   $pltassgn    - plot-level strata/estimation unit assignment
#   $pltassgnid  - name of unique identifier for plot in pltassgn
#   $unitarea    - total acres by estimation unit
#   $unitvar     - name of estimation unit variable (ESTN_UNIT)
#   $areavar     - name acre variable (ACRES)
#   $strlut      - strata look-up table with summarized pixel counts (P1POINTCNT)
#   $strvar      - name of strata variable (STRATA)
#   $strwtvar    - name of strata weight variable (P1POINTCNT)
#   $evalid      - the evalid used
#
# If savedata=TRUE:
#   - Comma-delimited file of datstrat (*'date'.csv).
#   - Comma-delimited file of unitarea (*'date'.csv).
#   - Comma-delimited file of stratalut (*'date'.csv).
#   - If collapsed, a comma-delimited file of original classes and new collapsed classes.
######################################################################################

help(DBgetStrata)


## From CSV files ##
# Get strata for the most current evaluation for Wyoming
WYstrat1 &lt;- DBgetStrata(states=&quot;Wyoming&quot;, evalCur=TRUE)
names(WYstrat1)

WYpltassgn &lt;- WYstrat1$pltassgn
head(WYpltassgn)
WYstrat1$unitarea
WYstrat1$unitvar
WYstrat1$areavar
WYstrat1$strlut
WYstrat1$strvar
WYstrat1$strwtvar
WYstrat1$evalid


# Get strata information for a specific evaluation for Wyoming
WYstrat2 &lt;- DBgetStrata(evalid=561200, savedata=TRUE, outfolder=outfolder)
names(WYstrat2)
WYpltassgn2 &lt;- WYstrat2$pltassgn
head(WYpltassgn2)
WYstrat2$unitarea
WYstrat2$strlut
WYstrat2$strwtvar
WYstrat2$evalid


# Get strata information for Wyoming, evaluation ending in 2014
WYstrat3 &lt;- DBgetStrata(states=&quot;Wyoming&quot;, evalEndyr=2014)
names(WYstrat3)
WYpltassgn3 &lt;- WYstrat3$pltassgn
head(WYpltassgn3)
WYstrat3$unitarea
WYstrat3$strlut
WYstrat3$strwtvar
WYstrat3$evalid


# Get strata information for a specific set of Wyoming plots
WYstrat4 &lt;- DBgetStrata(dat=WYplt)
names(WYstrat4)
WYpltassgn4 &lt;- WYstrat4$pltassgn
head(WYpltassgn4)
WYstrat4$unitarea
WYstrat4$strlut
WYstrat4$evalid


## Get strata information for Wyoming plots, 1 inventory year
WY2013strat &lt;- DBgetStrata(dat=WYplt[WYplt$INVYR == 2013, ])
names(WY2013strat)
WY2013pltassgn &lt;- WY2013strat$pltassgn
head(WY2013pltassgn)
WY2013strat$unitarea
WY2013strat$strlut
WY2013strat$strwtvar
WY2013strat$evalid


## Get strata information for Utah and Wyoming, most current evaluations
UTWYstrat &lt;- DBgetStrata(states=c(&quot;Utah&quot;, &quot;Wyoming&quot;), evalCur=TRUE)
names(UTWYstrat)
UTWYpltassgn &lt;- UTWYstrat$pltassgn
table(UTWYpltassgn$STATECD)
UTWYstrat$unitarea
UTWYstrat$strlut
UTWYstrat$evalid


## Get strata information for Utah, evalid 491500 and Wyoming, evalid 561500
UTWYstrat2 &lt;- DBgetStrata(evalid = list(Utah=491500, Wyoming=561500))
names(UTWYstrat2)
UTWYpltassgn2 &lt;- UTWYstrat2$pltassgn
table(UTWYpltassgn2$STATECD)
UTWYstrat2$unitarea
UTWYstrat2$strlut
UTWYstrat2$strwtvar
UTWYstrat2$evalid


## Get strata information all inventory years of Utah
## Note: For plots locations that have been visited more than once: all 
#   plots are assigned an estimation unit and strata value, but area and 
#   strata proportions are from the most current evaluation.
UTdat.all &lt;- DBgetPlots(states=&quot;Utah&quot;, allyrs=TRUE)
names(UTdat.all)
UTplt.all &lt;- UTdat.all$plt
table(UTplt.all$INVYR)

UTstrat.all &lt;- DBgetStrata(dat=UTplt.all, evalType=&quot;ALL&quot;)
names(UTstrat.all)
dim(UTplt.all)
pltassgn &lt;- UTstrat.all$pltassgn
dim(pltassgn)

UTstrat.all$unitarea
UTstrat.all$strlut

</code></pre>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
