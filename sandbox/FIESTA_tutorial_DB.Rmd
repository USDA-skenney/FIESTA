---
title: "FIESTA - Database Tools"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{FIESTA - Database Tools}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include = F}
library(knitr)
knitr::opts_chunk$set(message = F, warning = F)
```

```{r, include=FALSE}
# Sets up output folding
hooks = knitr::knit_hooks$get()
hook_foldable = function(type) {
  force(type)
  function(x, options) {
    res = hooks[[type]](x, options)
    
    if (isFALSE(options[[paste0("fold.", type)]])) return(res)
    
    paste0(
      "<details><summary>", type, "</summary>\n\n",
      res,
      "\n\n</details>"
    )
  }
}
knitr::knit_hooks$set(
  output = hook_foldable("output"),
  plot = hook_foldable("plot")
)
```

## FIESTA Overview
The R package, FIESTA (Forest Inventory ESTimation and Analysis) is a research estimation tool for analysts that work with sample-based inventory data like that from the U.S. Department of Agriculture, Forest Service, Forest Inventory and Analysis (FIA) Program to accommodate: unique population boundaries, different evaluation time periods, customized stratification schemes, non-standard variance equations, integration of multi-scale remotely-sensed data and other auxiliary information, and interaction with other modeling and estimation tools from CRAN R's library of packages. FIESTA contains a collection of functions that can access FIA databases, summarize and compile plot and spatial data, and generate estimates with associated sampling errors. 


Functions are organized by type or objective and are named with a corresponding prefix: 

**Core Functions**

* Database tools (DB) - functions for querying and extracting data from FIA's national database.
* Data tools (dat) - functions for summarizing and exploring FIA data.
* Spatial tools (sp) - functions for manipulating and summarizing spatial data.

**Estimation Modules**

* Green-Book (GB) - functions for FIA’s standard ‘Green-Book’ estimators.
* Photo-Based (PB) - functions for supplementary photo-based estimators.
* Small Area (SA) - functions for integration with available small area estimators (SAE).
* Model-Assisted (MA) - functions for integration with available Model-Assisted estimators.

**Analysis Tools**

* Analysis tools (an) - wrapper functions for stream-lining estimation processes.


### Overview of FIESTA Database (DB) tools
FIESTA's DB tools extract data from FIA's online publicly-available, comma-delimited files (\*.csv or \*.zip). FIA's CSV files are available by state from the FIA DataMart at the following link: https://apps.fs.usda.gov/fia/datamart/datamart.html. Because of FIA's confidentiality agreement to protect the privacy of landowners, as well as protecting the scientific integrity of FIA's sample design, the exact coordinates of the sample plot locations are not included in the public data. If the exact coordinates are necessary for your analysis, contact FIA's Spatial Data Services (https://www.fia.fs.fed.us/tools-data/spatial/index.php).


### Objective of tutorialThe objective of this tutorial is to demonstrate the use of FIESTA's DB tools for accessing FIA data. These tools extract data from FIA Datamart using FIA's standard evaluations as well as customized evaluations. 

An FIA Evaluation is a group of plots within the FIA database that is used for population estimates. An FIA Evaluation represents different inventory spans of data with different stratification and area adjustments for nonreponse. Each Evaluation is determined by the type of estimation (evalType) including: area and tree estimates, growth and mortality estimates, and area change estimates (evalType). These plots are identified by an evalid, which is a unique identifier in the format of a 2-digit State code, a 2-digit year code, and a 2-digit evaluation type code. For example, EVALID '491601' represents the Utah 2016 evaluation for current area estimates. 


FUNCTION  | DESCRIPTION
-------------- | ---------------------------------------------------------------
[DBgetCSV()](#DBgetCSV) | Downloads comma-delimited file (.csv) or downloads and extracts a compressed csv file (.zip) from FIA's online DataMart.
[DBqryCSV()](#DBqryCSV) | Extracts and queries data from FIA's online DataMart, either CSV or ZIP files.
[DBgetEvalid()](#DBgetEvalid) | Gets evalid for identifying an estimation group of plots for state or checks evalid.
[DBgetXY()](#DBgetXY) | Extracts XY data from FIA database.
[DBgetPlots()](#DBgetPlots) | Extracts inventory plot data from FIA database.
[DBgetStrata()](#DBgetStrata) | Extracts strata information and total acres by estimation unit from FIA database, including plot-level assignment and a data frame with strata weights by estimation unit.


### Set up 

First, you'll need to load the `FIESTA` library:

```{r, warning = F, message = F}
library(FIESTA)
```

Next, you'll need to set up an "outfolder". This is just a file path to a folder where you'd like `FIESTA` to send your data output. For this vignette, we have saved our outfolder file path as the `outfolder` object in a temporary directory. We also set a few default options preferred for this vignette.

```{r}
outfolder <- tempdir()
```

## DB Examples

The following examples show how to extract data from FIA's publicly-available, online DataMart. Data can be returned as R objects or exported to CSV (.csv) files or a SQLite (.sqlite) database.  The zip files are extracted on-the-fly from the online website. Web server connections will affect download speeds. We show examples for the following functions:



The following examples extract data from FIA's online DataMart (https://apps.fs.usda.gov/fia/datamart/datamart.html).

### <a name="DBgetCSV"/>`DBgetCSV()`

The `DBgetCSV` function extracts data from FIA's publicly-available, online DataMart CSV/ZIP files. The zip files are extracted on-the-fly from the online website. Web server connections will affect download speeds. 

#### Example 1: Extract PLOT data for Wyoming and Utah
<details>
  <summary>View Example</summary>
  
```{r}

WYUTplot <- DBgetCSV(DBtable="PLOT", states=c("Wyoming", "Utah"))
table(WYUTplot$STATECD)

```

</details>


#### <a name="DBgetCSV"/>DBgetCSV()
```{r}

## Get plot table for Wyoming
WYplots <- DBgetCSV("PLOT", "Wyoming")
dim(WYplots)

## Get plot table for Wyoming and Utah
WYUTplots <- DBgetCSV(DBtable="PLOT", states=c("Wyoming", "Utah"))
table(WYUTplots$STATECD)

## Get survey table for Wyoming
WYsurvey <- DBgetCSV("SURVEY", "Wyoming")
WYsurvey

```


### <a name="DBqryCSV"/>`DBqryCSV()` 

The `DBqryCSV` function queries table from FIA' online publicly-available DataMart. The tables in the query must be specified in the sqltables parameter.

#### Example: Multiple Uses
<details>
  <summary>View Example</summary>
#### <a name="DBqryCSV"/>DBqryCSV()

```{r}

# Get number of plots by inventory year for the state of Wyoming
sql1 <- "select INVYR, count(*) AS NBRPLOTS 
         from PLOT 
         where statecd=56 group by INVYR"
DBqryCSV(sql = sql1, 
         states = "Wyoming", 
         sqltables = "PLOT")


# Get min, mean, max height by FORTYPCD in Wyoming
sql2 <- "select c.FORTYPCD, min(HT) HTmin, round(avg(HT)) HTmean, max(HT) maxHT 
			   from COND c 
			   inner join TREE t ON c.PLT_CN = t.PLT_CN 
			   where c.statecd = 56 
			   group by c.FORTYPCD order by c.FORTYPCD"
DBqryCSV(sql = sql2,
         states = "Wyoming", 
         sqltables = c("COND", "TREE"))


# Get number of plots by inventory year for Utah and Wyoming
sql3 <- "select STATECD, INVYR, count(*) NBRPLOTS 
         from PLOT 
         where statecd in(49,56) 
         group by STATECD, INVYR"
DBqryCSV(sql = sql3, 
         states = c("Utah", "Wyoming"), 
         sqltables = "PLOT")


# Get number of plots by inventory year for Utah and Wyoming that have subalpine fir trees (SPCD=19)
sql4 <- "select p.STATECD, p.INVYR, count(*) NBRPLOTS 
         from PLOT p 
         join TREE t ON p.CN = t.PLT_CN 
         where p.statecd in(49,56) and t.SPCD = 19
         group by p.STATECD, p.INVYR"
DBqryCSV(sql = sql4, 
         states = c("Utah", "Wyoming"), 
         sqltables = c("PLOT", "TREE"))

```

</details>


### <a name="DBgetEvalid"/>`DBgetEvalid()`

The `DBgetEvalid` function gets information for FIA Evaluations. 

#### Example 1: Get most current evalid and inventory years for Wyoming
<details>
  <summary>View Example</summary>
```{r}

WYeval <- DBgetEvalid(states = "Wyoming",
                      evalCur = TRUE)

names(WYeval)
WYeval$evalidlist
WYeval$invyrs
WYeval$invyrtab
WYeval$invtype

```

</details>

#### Example 2: Get most current evalid and inventory years for RMRS states
<details>
  <summary>View Example</summary>
```{r}

RMRSeval <- DBgetEvalid(RS = "RMRS",
                        evalCur = TRUE)

names(RMRSeval)
RMRSeval$evalidlist
RMRSeval$invyrs
RMRSeval$invyrtab
RMRSeval$invtype

```

</details>

#### Example 3: Get most current evaluations for New York and Texas for VOL and GRM evalTypes
<details>
  <summary>View Example</summary>
  
```{r}

NYTXeval <- DBgetEvalid(states = c("New York", "Texas"), 
                        evalType = c("VOL", "GRM"))

names(NYTXeval)
NYTXeval$evalidlist
NYTXeval$evalTypelist

```

</details>


### <a name="DBgetXY"/>`DBgetXY()` 

The `DBgetXY` function queries XY data from FIA' online publicly-available DataMart or SQLite database.

#### Example1: Get xy data for the state of Wyoming
<details>
  <summary>View Example</summary>
#### <a name="DBgetXY"/>DBgetXY()

```{r}

xydat1 <- DBgetXY(states = "Wyoming", 
                  eval = "FIA",
                  eval_opts = eval_options(Cur = TRUE)
                  )
names(xydat1)
head(xydat1$xyCur_PUBLIC)

```

</details>


#### Example 2: Add variable in plot table, PLOT_STATUS_CD, and output spatial
<details>
  <summary>View Example</summary>
 
```{r}

xydat2 <- DBgetXY(states = "Wyoming", 
                  eval = "FIA",
                  eval_opts = eval_options(Cur = TRUE),
                  pvars2keep = c("PLOT_STATUS_CD"),
                  issp = TRUE
                  )
spxy2 <- xydat2$spxy

## Display points with by PLOT_STATUS_CD (1-light blue; 2-brown; 3-blue)
spxy2$color <- with(spxy2, 
          ifelse(PLOT_STATUS_CD == 2, "brown", 
                ifelse(PLOT_STATUS_CD == 3, "blue", "light blue")))
plot(sf::st_geometry(spxy2['PLOT_STATUS_CD']), pch = 16, cex = .5,
                     col = spxy2$color)


```

</details>


#### Example 3: Get XY data for Wyoming, inventory years 2015 to 2019
<details>
  <summary>View Example</summary>
 
```{r}

xydat3 <- DBgetXY(states = "Wyoming", 
                  eval = "custom",
                  eval_opts = eval_options(invyrs = 2015:2019),
                  issp = TRUE
                  )
spxy3 <- xydat3$spxy

## Display points 
plot(sf::st_geometry(spxy3), pch = 16, cex = .5)

```

</details>

### <a name="DBgetPlots"/>`DBgetPlots()`

The `DBgetPlots` function extracts data from FIA's online DataMart or SQLite database. 

#### Example 1: Get data for Wyoming, most current FIA Evaluation, all plots, no trees
<details>
  <summary>View Example</summary>

#### <a name="DBgetPlots"/>DBgetPlots()
```{r}

dat1 <- DBgetPlots(states = "Wyoming", 
                  eval = "FIA", 
                  eval_opts = eval_options(Cur = TRUE, 
                                           evalType = "CURR")
                  )

names(dat1)
tabs1 <- dat1$tabs
plt1 <- tabs1$plt
cond1 <- tabs1$cond
dat1$evalid
dat1$pltcnt

table(plt1$INVYR)

```


</details>


#### Example 2: Get data for Wyoming, most current measurement in database, all plots, no trees
<details>
  <summary>View Example</summary>
  
```{r}

dat2 <- DBgetPlots(states = "Wyoming", 
                   eval = "custom", 
                   eval_opts = eval_options(Cur = TRUE, 
                                            evalType = "CURR")
                   )

names(dat2)
tabs2 <- dat2$tabs
plt2 <- tabs2$plt
cond2 <- tabs2$cond
dat2$evalid
dat2$pltcnt

table(plt2$INVYR)

```
  
  
</details>


#### Example 3: Get data for Wyoming, most current FIA Evaluation, include spatial
<details>
  <summary>View Example</summary>

```{r}

dat3 <- DBgetPlots(states = "Wyoming", 
                   eval = "FIA",
                   eval_opts = eval_options(Cur = TRUE, 
                                            evalType = "CURR"),
                   issp = TRUE)

names(dat3)
spxy3 <- dat3$xy_PUBLIC


# Look at spatial output
plot(sf::st_geometry(spxy3))

```


</details>


#### Example 4: Get data for Wyoming, most current FIA Evaluation, include spatial, add filter
<details>
  <summary>View Example</summary>

```{r}

# Add a filter to include only plots with Whitebark pine forest type (FORTYPCD == 367)
# Note: *allFilter* filters for plots and/or conditions for all states specified.
dat4 <- DBgetPlots(states="Wyoming", 
                   eval = "FIA",
                   eval_opts = eval_options(Cur = TRUE, 
                                            evalType = "CURR"),
                   issp = TRUE, 
                   allFilter = "FORTYPCD == 367")

names(dat4)
spxy4 <- dat4$xy_PUBLIC

# Look at spatial output
plot(sf::st_geometry(spxy3))
plot(sf::st_geometry(spxy4), add=TRUE, col="green")


```


</details>


#### Example 5: Get data for Wyoming, most current FIA Evaluation, include spatial, add tree filter
<details>
  <summary>View Example</summary>

```{r}

# Add a filter to include only plots with Whitebark pine tree species (SPCD == 101)
# Note: *alltFilter* filters for plots and/or conditions for all states specified.
dat5 <- DBgetPlots(states = "Wyoming", 
                   eval = "FIA",
                   eval_opts = eval_options(Cur = TRUE, 
                                            evalType = "CURR"),
                   issp = TRUE, 
                   alltFilter = "SPCD == 101")

names(dat5)
spxy5 <- dat5$xy_PUBLIC

# Look at spatial output
plot(sf::st_geometry(spxy3))
plot(sf::st_geometry(spxy4), add=TRUE, col="red")
plot(sf::st_geometry(spxy5), add=TRUE, col="green")

```


</details>


#### Example 6: Get data for Wyoming, most current FIA Evaluation, include plotgeom data and subplot tables
<details>
  <summary>View Example</summary>

```{r}

dat6 <- DBgetPlots(states = "Wyoming", 
                   eval = "FIA",
                   eval_opts = eval_options(Cur = TRUE, 
                                            evalType = "CURR"),
                   issubp = TRUE,
                   plotgeom = TRUE)
names(dat6)
tabs6 <- dat6$tabs
plt6 <- tabs6$plt

## subplot and subp_cond tables are added to tabs list
names(tabs6)

## PLOTGEOM data are appended to plt table (e.g., ALP_ADFORCD, FVS_VARIANT)
head(plt6)

```


</details>


#### Example 7: Get data for Wyoming, most current FIA Evaluation, include pop tables
<details>
  <summary>View Example</summary>

```{r}

dat7 <- DBgetPlots(states = "Wyoming", 
                   eval = "FIA",
                   eval_opts = eval_options(Cur = TRUE, 
                                            evalType = "CURR"),
                   savePOP = TRUE,
                   othertables = c("POP_STRATUM", "POP_ESTN_UNIT"))

## savePOP = TRUE, saves the POP_PLOT_STRATUM_ASSGN table used to select plots 
names(dat7)

## pop_stratum and pop_estn_unit tables are added to tabs list
tabs7 <- dat7$tabs
names(tabs7)

```


</details>


#### Example 8: Export data to CSV files
<details>
  <summary>View Example</summary>

```{r}

DBgetPlots(states = "Wyoming", 
           eval = "FIA",
           eval_opts = eval_options(Cur = TRUE, evalType = "CURR"),
           returndata = FALSE,
           savedata = TRUE,
           savedata_opts = savedata_options(outfolder = outfolder, 
                                            out_fmt = "csv",
                                            overwrite_layer = TRUE)
           )

## Read in data from outfolder
plt <- read.csv(file.path(outfolder, "plot.csv"), stringsAsFactors=FALSE)
head(plt)

```


</details>


#### Example 9: Export data to a SQLite database
<details>
  <summary>View Example</summary>

```{r}

DBgetPlots(states = "Wyoming", 
           eval = "FIA",
           eval_opts = eval_options(Cur = TRUE, evalType = "CURR"),
           returndata = FALSE,
           savedata = TRUE,
           savedata_opts = savedata_options(outfolder = outfolder, 
                                            out_fmt = "sqlite",
                                            out_dsn = "data.db",
                                            overwrite_dsn = TRUE,
                                            overwrite_layer = TRUE)
           )

## Connect to database and list tables
sqlitefn <- file.path(outfolder, "data.db")
conn <- DBI::dbConnect(RSQLite::SQLite(), sqlitefn)
DBI::dbListTables(conn)

## Read in plot table
plt <- DBI::dbReadTable(conn, "plot")
dim(plt)

## List fields in plot
DBI::dbListFields(conn, "plot")

## Query plot data
DBI::dbGetQuery(conn, "select PLOT_STATUS_CD, count(*) from plot group by PLOT_STATUS_CD")

## Disconnect database connection
DBI::dbDisconnect(conn)

```


</details>


#### Example 10: Export data to a spatiaLite database
<details>
  <summary>View Example</summary>

```{r}

## Note: SpatiaLite is an extension to SQLite, providing vector geodatabase functionality.

DBgetPlots(states = "Wyoming", 
           eval = "FIA",
           eval_opts = eval_options(Cur = TRUE, evalType = "CURR"),
           issp = TRUE,
           returndata = FALSE,
           savedata = TRUE,
           savedata_opts = savedata_options(outfolder = outfolder, 
                                            out_fmt = "sqlite",
                                            out_dsn = "datasp.db",
                                            overwrite_dsn = TRUE,
                                            overwrite_layer = TRUE)
           )

## Connect to database and list tables
splitefn <- file.path(outfolder, "datasp.db")
conn <- DBI::dbConnect(RSQLite::SQLite(), splitefn)
DBI::dbListTables(conn)

## Disconnect database connection
DBI::dbDisconnect(conn)

## Now, let's use sf functions to list and read data
sf::st_layers(splitefn)

## Import spatial xy coordinates (using sf package)
spxy_public <- sf::st_read(splitefn, layer="xyx_public")
dim(spxy_public)

## Display plots with public coordinates
plot(sf::st_geometry(spxy_public))

```


</details>


#### Example 11: Multiple states
<details>
  <summary>View Example</summary>

```{r}

dat11 <- DBgetPlots(states = c("Utah", "Wyoming"), 
                    eval = "FIA",
                    eval_opts = eval_options(Cur = TRUE, 
                                             evalType = "CURR"),
                    )

names(dat11)
plt11 <- dat11$tabs$plt

table(plt11$STATECD)

```


</details>


#### Example 12: For all states in a Research Station
<details>
  <summary>View Example</summary>

```{r}

dat12 <- DBgetPlots(RS = "RMRS", 
                    eval = "FIA",
                    eval_opts = eval_options(Cur = TRUE, 
                                             evalType = "CURR"),
                    )

names(dat12)
plt12 <- dat12$tabs$plt

table(plt12$STATECD)

```


</details>


#### Example 13: Most current evaluation for multiple evalTypes ('ALL', 'VOL', 'GRM')
<details>
  <summary>View Example</summary>

```{r}

dat13 <- DBgetPlots(states = "Vermont", 
                    eval = "FIA",
                    eval_opts = eval_options(Cur = TRUE, 
                                             evalType = c("VOL", "CHNG", "P2VEG")),
                    )

names(dat13)
tabs13 <- dat13$tabs
names(tabs13)

ppsa13 <- dat13$pop_plot_stratum_assgn
table(ppsa13$EVALID)

```

</details>


#### Example 14: Get data for multiple evalids
<details>
  <summary>View Example</summary>

```{r}

dat14 <- DBgetPlots(eval = "FIA",
                    eval_opts = eval_options(Cur = TRUE, 
                                             evalid = c(491800, 491801, 491803)),
                    )

names(dat14)
tabs14 <- dat14$tabs
names(tabs14)

ppsa14 <- dat14$pop_plot_stratum_assgn
table(ppsa14$EVALID)

```


</details>


#### Example 15: Get data for multiple states by Endyr
<details>
  <summary>View Example</summary>

```{r}

dat15 <- DBgetPlots(states=c("Utah", "Texas", "New York", "Oregon"), 
                    eval = "FIA",
                    eval_opts = eval_options(Cur = TRUE, 
                                             evalType = "ALL",
                                             Endyr = 2017),
                    )

names(dat15)
tabs15 <- dat15$tabs
names(tabs15)

ppsa15 <- dat15$pop_plot_stratum_assgn
table(ppsa15$EVALID)

```


</details>

#### Example 16: Get data for multiple eval Endyrs
<details>
  <summary>View Example</summary>

```{r}

dat16 <- DBgetPlots(states = "Vermont", 
                    eval = "FIA",
                    eval_opts = eval_options(Cur = TRUE, 
                                             evalType = "VOL",
                                             Endyr = 2015:2019),
                    )

names(dat16)
tabs16 <- dat16$tabs
names(tabs16)

ppsa16 <- dat16$pop_plot_stratum_assgn
table(ppsa16$EVALID)

```


</details>

#### Example 17: Get data for multiple eval Endyrs
<details>
  <summary>View Example</summary>

```{r}

dat17 <- DBgetPlots(states = "Wyoming", 
                    eval = "custom",
                    eval_opts = eval_options(invyrs = 2012:2014, 
                                             evalType = "ALL"),
                    issp = TRUE
                    )

names(dat17)
tabs17 <- dat17$tabs
names(tabs17)
plt17 <- tabs17$plt

table(plt17$INVYR)


# Look at output
plot(sf::st_geometry(dat17$xy_PUBLIC))

```


</details>

#### Example 18: Get data for multiple states, different inventory years
<details>
  <summary>View Example</summary>

```{r}

dat18 <- DBgetPlots(states = "Wyoming", 
                    invtype = "PERIODIC",
                    eval = "FIA",
                    eval_opts = list(Cur = TRUE, 
                                     evalType = "VOL")
                    )

names(dat18)
tabs18 <- dat18$tabs
names(tabs18)
plt18 <- tabs18$plt

table(plt18$STATECD, plt18$INVYR)

```


</details>

#### Example 19: Get data for most current FIA Evaluation and most current custom Evaluation
<details>
  <summary>View Example</summary>

The objective of this section is to understand the differences when extracting plots for the most current evaluation (evalCur=TRUE) and the most current measurement (measCur=TRUE).

```{r}

# Most current evaluation for Utah
UTevalCur <- DBgetPlots(states = "Utah", 
                        eval = "FIA",
                        eval_opts = eval_options(Cur = TRUE,
                                                 evalType = "ALL")
                        )
names(UTevalCur)
tabs.UTevalCur <- UTevalCur$tabs
plt.UTevalCur <- tabs.UTevalCur$plt

## The difference in number of plots by inventory year and measurement year
table(plt.UTevalCur$INVYR, plt.UTevalCur$MEASYEAR)


# Most current measurement for Utah
UTmeasCur <- DBgetPlots(states = "Utah", 
                        eval = "custom",
                        eval_opts = eval_options(Cur = TRUE,
                                                 evalType = "ALL")
                        )
names(UTmeasCur)
tabs.UTmeasCur <- UTmeasCur$tabs
plt.UTmeasCur <- tabs.UTmeasCur$plt

## The difference in number of plots by inventory year and measurement year
table(plt.UTmeasCur$INVYR, plt.UTmeasCur$MEASYEAR)


## See that nonsampled plots (PLOT_STATUS_CD=3) decrease in number.
## Nonsampled plots that remain are plots that were nonsampled in every measurement cycle.
table(plt.UTmeasCur$PLOT_STATUS_CD)
table(plt.UTevalCur$PLOT_STATUS_CD)


## Let's look at an example for plot location 889 in county 78
## In the most current evaluation, inventory year 2012, the plot was denied access, and not sampled (PLOT_STATUS_CD=3 and PLOT_NONSAMPLE_REASN_CD=2)
## The same plot was measured previously, in 2002, and was found with forest (PLOT_STATUS_CD=1)
## We can use this information, with the caveat that the plot hasn't changed much

plt.UTevalCur[plt.UTevalCur$PLOT_ID == "ID490400780889",]
plt.UTmeasCur[plt.UTmeasCur$PLOT_ID == "ID490400780889",]

```


</details>

#### Example 20: Get data for most current FIA Evaluation and most current custom Evaluation
<details>
  <summary>View Example</summary>

Let's look at the most current evaluation for Oregon.

```{r}

# Most current evaluation for Oregon
ORevalCur <- DBgetPlots(states = "Oregon", 
                        eval = "FIA",
                        eval_opts = eval_options(Cur = TRUE,
                                                 evalType = "ALL")
                        )
names(ORevalCur)
tabs.ORevalCur <- ORevalCur$tabs
plt.ORevalCur <- tabs.ORevalCur$plt

## The difference in number of plots by inventory year and measurement year
table(plt.ORevalCur$INVYR, plt.ORevalCur$MEASYEAR)


# Most current measurement for Oregon
ORmeasCur <- DBgetPlots(states = "Oregon", 
                        eval = "custom",
                        eval_opts = eval_options(Cur = TRUE,
                                                 evalType = "ALL")
                          )
names(ORmeasCur)
tabs.ORmeasCur <- ORmeasCur$tabs
plt.ORmeasCur <- tabs.ORmeasCur$plt

## The difference in number of plots by inventory year and measurement year
table(plt.ORmeasCur$INVYR, plt.ORmeasCur$MEASYEAR)


## See that nonsampled plots (PLOT_STATUS_CD=3) decrease in number.
## Nonsampled plots that remain are plots that were nonsampled in every measurement cycle.
table(plt.ORmeasCur$PLOT_STATUS_CD)
table(plt.ORevalCur$PLOT_STATUS_CD)

```


</details>

#### Example 21: Intensity
<details>
  <summary>View Example</summary>

The objective of this section is to understand the differences when using INTENSITY=1.

```{r}

## With intensified plots
dat21a <- DBgetPlots(states = "Vermont", 
                    eval = "FIA",
                    eval_opts = list(Cur = TRUE, 
                                     Type = "ALL")
                    )
tabs21a <- dat21a$tabs
plt21a <- tabs21a$plt

## With only P2 plots (intensity1 = TRUE)
dat21b <- DBgetPlots(states = "Vermont", 
                    eval = "FIA",
                    eval_opts = list(Cur = TRUE, 
                                     Type = "ALL"),
                    intensity1 = TRUE
                    )

tabs21b <- dat21b$tabs
plt21b <- tabs21b$plt

table(plt21a$INVYR)
table(plt21b$INVYR)

```


</details>

#### Example 22: Filter multiple states for Region 1 forests
<details>
  <summary>View Example</summary>

```{r}

# Most current measurement for Montana, R1, filtered for OWNGRPCD=10
dat23a <- DBgetPlots(states = "Montana", 
                     eval = "custom",
                     eval_opts = list(Cur = TRUE, 
                                      Type = "ALL"),
                     allFilter = "OWNGRPCD == 10 & (ADFORCD > 100 & ADFORCD < 200)",
                     issp = TRUE
                     )

### Look at plot counts
dat23a$pltcnt
table(dat23a$tabs$cond$ADFORCD)

## Display points with by PLOT_STATUS_CD (1-light blue; 2-brown; 3-blue)
dat23aspxy <- dat23a$xyCur_PUBLIC

dat23aspxy$color <- with(dat23aspxy, 
          ifelse(PLOT_STATUS_CD == 2, "brown", 
                ifelse(PLOT_STATUS_CD == 3, "blue", "light blue")))
plot(sf::st_geometry(dat23aspxy['PLOT_STATUS_CD']), pch = 16, cex = .5,
                     col = dat23aspxy$color)


## Get plots that have pinyon pine trees in Montana
dat23b <- DBgetPlots(states = "Montana", 
                     eval = "custom",
                     eval_opts = list(Cur = TRUE, 
                                      Type = "ALL"),
                     allFilter = "OWNGRPCD == 10 & (ADFORCD > 100 & ADFORCD < 200)",
                     issp = TRUE,
                     alltFilter = "SPCD == 101"
                     )

## Display points with by PLOT_STATUS_CD (1-light blue; 2-brown; 3-blue)
dat23bspxy <- dat23b$xyCur_PUBLIC
plot(sf::st_geometry(dat23bspxy), pch = 16, cex = .5, col = "wheat", add = TRUE)

```

                
</details>

#### Example 24: All Condition Inventory (ACI) data
<details>
  <summary>View Example</summary>

Region 1 plots, filtered for OWNGRPCD=10, include tree data with ACI
Note: ACI data are not included in FIA evaluations, must specify inventory years

```{r}

## Get plots, 2008-2017 Inventory years
dat24a <- DBgetPlots(states = "Montana", 
                     eval = "custom",
                     eval_opts = list(invyrs = 2010:2019, 
                                     Type = "VOL"),
                     allFilter = "OWNGRPCD == 10 & (ADFORCD > 100 & ADFORCD < 200)",
                     )

## Get plots, 2008-2017 Inventory years, including ACI data
dat24b <- DBgetPlots(states = "Montana", 
                     eval = "custom",
                     eval_opts = list(invyrs = 2010:2019, 
                                      Type = "VOL"),
                     allFilter = "OWNGRPCD == 10 & (ADFORCD > 100 & ADFORCD < 200)",
                     ACI = TRUE
                     )

## Compare with FIA 2008-2017 Inventory years, not including ACI data
table(dat24a$tabs$plt$NF_PLOT_STATUS_CD)
table(dat24b$tabs$plt$NF_PLOT_STATUS_CD)

table(dat24a$tabs$cond$NF_COND_STATUS_CD)
table(dat24b$tabs$cond$NF_COND_STATUS_CD)


table(dat24a$tabs$cond$COND_STATUS_CD)
table(dat24b$tabs$cond$COND_STATUS_CD)

dim(dat24a$tabs$tree)
dim(dat24b$tabs$tree)


```


### <a name="DBgetStrata"/>`DBgetStrata()` 

The `DBgetStrata` function queries the FIA database for post-stratification information.

#### Example1: Get strata for the most current evaluation for Wyoming
<details>
  <summary>View Example</summary>
#### <a name="DBgetStrata"/>DBgetStrata()

#### <a name="DBgetStrata"/>DBgetStrata()
```{r}

strat1 <- DBgetStrata(states = "Wyoming", 
                      eval_opts = eval_options(Cur = TRUE)
                      )
names(strat1)

## Look at plot assign data
pltassgn1 <- strat1$pltassgn
head(pltassgn1)

unique(pltassgn1$EVALID)
strat1$evalid  


## Look at area data for estimation unit
strat1$unitarea
strat1$unitvar
strat1$unitvar2
strat1$areavar

## Look at stratification data for estimation unit
strat1$stratalut
strat1$strvar
strat1$getwtvar

```

</details>


#### Example 2: Get strata information for a specific evaluation for Wyoming
<details>
  <summary>View Example</summary>

```{r}

strat2 <- DBgetStrata(eval_opts = eval_options(evalid = 561200))

unique(strat2$pltassgn$EVALID)
strat2$evalid  

```

</details>


#### Example 3: Get strata information for Wyoming, evaluation ending in 2014
<details>
  <summary>View Example</summary>

```{r}

strat3 <- DBgetStrata(states = "Wyoming",
                      eval_opts = eval_options(Endyr = 2014))
                  
unique(strat3$pltassgn$EVALID)
strat3$evalid  

```

</details>


#### Example 4: Get strata information for a specific set of Wyoming plots
<details>
  <summary>View Example</summary>

```{r}

strat4 <- DBgetStrata(dat = WYplt)

head(strat4$unitarea)
head(WYunitarea)

```


</details>


#### Example 5: Get strata information for a specific set of Wyoming plots
<details>
  <summary>View Example</summary>

```{r}

strat5 <- DBgetStrata(states = c("Utah", "Wyoming"),
                      eval_opts = eval_options(Cur = TRUE))

table(strat5$pltassgn$EVALID)

```



